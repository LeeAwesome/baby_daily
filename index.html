<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ÂÆùÂÆùÊó•Â∏∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5px;
            padding-bottom: 70px;
        }

        .header-container {
            position: relative;
            margin-bottom: 10px
        }

        .settings-btn, .refresh-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .settings-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .refresh-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .settings-btn:hover, .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-50%) scale(1.05)
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translateY(-50%) rotate(0deg); }
            to { transform: translateY(-50%) rotate(360deg); }
        }

        h1 {
            color: #fff;
            text-align: center;
            margin: 0;
            font-size: clamp(22px, 6vw, 32px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .2)
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0
            }
            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0
        }

        .modal-header h2 {
            margin: 0;
            color: #667eea;
            font-size: 24px
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s
        }

        .close-btn:hover {
            color: #333;
            transform: scale(1.1)
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s
        }

        .save-btn:hover {
            background: #5568d3
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea
        }

        /* ÂØπËØùÈù¢ÊùøÊ†∑Âºè */
        .chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 800;
        }

        .chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .chat-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 801;
            animation: slideUp 0.3s ease-out;
            display: none;
        }

        .chat-panel.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            padding: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: #e8eaf6;
            color: #333;
            margin-right: auto;
        }

        .chat-message.error {
            background: #ffebee;
            color: #c62828;
            margin-right: auto;
        }

        .chat-input-group {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .chat-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-input-group button {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .chat-input-group button:hover {
            background: #5568d3;
        }

        .chat-input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin-right: 4px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        #babyAge {
            display: block;
            text-align: center;
            color: #fff;
            margin-bottom: 15px;
            font-size: clamp(13px, 3.5vw, 16px);
            transition: margin-bottom 0.3s ease;
        }

        /* ‰∫ã‰ª∂ËßÜÂõæÊó∂ÔºåÂáèÂ∞ëbabyAgeÁöÑÂ∫ïÈÉ®Èó¥Ë∑ù */
        body.event-view-active #babyAge {
            margin-bottom: 1px;
        }

        /* ‰∫ã‰ª∂ËßÜÂõæÊó∂ÔºåË∞ÉÊï¥ÂÆπÂô®È°∂ÈÉ®Èó¥Ë∑ù */
        body.event-view-active .view-container {
            margin-top: -55px;
        }

        .file-input-container {
            background: rgba(255, 255, 255, .95);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: #667eea;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            padding: 5px;
            text-decoration: underline
        }

        #fileDetails {
            margin-top: 12px
        }

        .birth-date-input {
            margin: 12px 0;
            text-align: center;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center
        }

        .birth-date-input label {
            color: #667eea;
            font-weight: 600;
            font-size: 14px
        }

        .birth-date-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(13px, 3vw, 15px);
            font-weight: 600;
            margin-top: 10px
        }

        .file-input-container input[type="file"] {
            display: none
        }

        .status {
            margin-top: 10px;
            font-size: clamp(11px, 2.5vw, 13px);
            color: #666
        }

        .today-summary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .2);
            color: #fff
        }

        .yesterday-summary {
            background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .2);
            color: #fff
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .summary-header h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 0;
            font-weight: 700;
            flex: 1;
        }

        .toggle-icon {
            font-size: clamp(18px, 4vw, 24px);
            transition: transform 0.3s;
            margin-left: 10px;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .summary-content {
            margin-top: 12px;
            overflow: hidden;
            transition: all 0.3s ease-out;
            max-height: 2000px;
        }

        .summary-content.collapsed {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }

        .today-summary h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 12px;
            text-align: center;
            font-weight: 700
        }

        .today-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px
        }

        .today-card {
            background: rgba(255, 255, 255, .15);
            padding: clamp(10px, 2.5vw, 14px);
            border-radius: 8px;
            min-width: 0
        }

        .today-card h3 {
            font-size: clamp(13px, 3.5vw, 16px);
            margin-bottom: 8px;
            font-weight: 700
        }

        .today-card .detail {
            font-size: clamp(12px, 3vw, 14px);
            margin: 5px 0;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 5px;
            align-items: center
        }

        .today-card .num {
            font-size: clamp(15px, 4vw, 19px);
            font-weight: 700
        }

        .latest-record {
            font-size: clamp(11px, 2.5vw, 13px);
            color: rgba(255, 255, 255, .85);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, .2);
            word-break: break-word
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px
        }

        .stat-card {
            background: rgba(255, 255, 255, .95);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            min-width: 0
        }

        .stat-card h3 {
            font-size: clamp(13px, 3vw, 15px);
            color: #666;
            margin-bottom: 8px
        }

        .stat-card .value {
            font-size: clamp(22px, 5vw, 32px);
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px
        }

        .stat-card .label {
            font-size: clamp(11px, 2.5vw, 13px);
            color: #999
        }

        .chart-container {
            background: rgba(255, 255, 255, .95);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .chart-container:last-of-type {
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px
        }

        .chart-title {
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: 700;
            color: #333
        }

        .time-dimension {
            display: flex;
            gap: 8px
        }

        .time-dimension button {
            padding: 6px 12px;
            border: 1px solid #667eea;
            background: #fff;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(11px, 2.5vw, 13px);
            transition: all .2s
        }

        .time-dimension button.active {
            background: #667eea;
            color: #fff
        }

        .time-dimension button:hover {
            background: #667eea;
            color: #fff
        }

        .chart-slide-wrapper {
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(248, 248, 248, 0.8);
            border-radius: 8px;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chart-legend-item:hover {
            opacity: 0.7;
        }

        .chart-legend-item.hidden {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .chart-legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .chart-slide-inner {
            will-change: transform;
            position: relative;
        }

        canvas {
            max-height: 300px;
            touch-action: pan-y;
            cursor: grab;
            user-select: none;
            display: block;
            /* widthÁî±JSÂä®ÊÄÅËÆæÁΩÆ */
        }

        canvas:active {
            cursor: grabbing;
        }

        @media (max-width: 600px) {
            .chart-header {
                gap: 8px;
                margin-bottom: 12px
            }
            
            .chart-title {
                font-size: 14px;
                flex: 1;
                min-width: auto
            }
            
            .time-dimension {
                gap: 5px
            }
            
            .time-dimension button {
                padding: 5px 10px;
                font-size: 11px
            }
        }

        .hidden {
            display: none
        }

        #dataContainer {
            padding-bottom: 20px;
        }

        /* AI Chat Ê∞îÊ≥°Âõ∫ÂÆöÂÆö‰ΩçÊ†∑Âºè */
        .ai-chat-bubble {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .ai-chat-bubble:hover {
            transform: translateY(-50%) scale(1.08);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.4);
        }

        .ai-chat-bubble svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* ÈÄöÁî®ÈÄâÊã©Âô®ÔºöÂº∫Âà∂‰øÆÂ§çÂèØËÉΩÁöÑAI ChatÂÖÉÁ¥†‰ΩçÁΩÆ */
        [class*="ai-chat"]:not(.bottom-nav):not(.nav-item),
        [class*="ai_chat"]:not(.bottom-nav):not(.nav-item),
        [class*="aiChat"]:not(.bottom-nav):not(.nav-item),
        [class*="chat-bubble"]:not(.bottom-nav):not(.nav-item),
        [class*="chat-widget"]:not(.bottom-nav):not(.nav-item),
        [id*="ai-chat"]:not(.bottom-nav):not(.nav-item),
        [id*="ai_chat"]:not(.bottom-nav):not(.nav-item),
        [id*="aiChat"]:not(.bottom-nav):not(.nav-item) {
            position: fixed !important;
            right: 20px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 2000 !important;
        }

        /* Á¨¨‰∏âÊñπËÅäÂ§©Â∑•ÂÖ∑ÈÄöÁî®Ê†∑Âºè */
        .intercom-launcher,
        .fb-customerchat,
        .crisp-client,
        #launcher:not(.bottom-nav):not(.nav-item),
        #chat-widget:not(.bottom-nav):not(.nav-item),
        #chat-bubble:not(.bottom-nav):not(.nav-item) {
            position: fixed !important;
            right: 20px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 2000 !important;
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖçÔºöÈÅøÂÖç‰∏éÂØºËà™Ê†èÂÜ≤Á™Å */
        @media (max-width: 768px) {
            .ai-chat-bubble,
            [class*="ai-chat"]:not(.bottom-nav):not(.nav-item),
            [class*="ai_chat"]:not(.bottom-nav):not(.nav-item),
            [class*="aiChat"]:not(.bottom-nav):not(.nav-item),
            [class*="chat-bubble"]:not(.bottom-nav):not(.nav-item),
            [class*="chat-widget"]:not(.bottom-nav):not(.nav-item) {
                right: 15px !important;
                top: auto !important;
                bottom: 80px !important;
                transform: none !important;
            }
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†èÊ†∑Âºè */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item:not(.active):hover {
            color: rgba(0, 0, 0, 0.7);
        }

        /* ‰∏∫ÂÜÖÂÆπÂå∫ÂüüÊ∑ªÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÔºåÈÅøÂÖçË¢´ÂØºËà™Ê†èÈÅÆÊå° */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            padding-bottom: 75px;
            min-height: 100vh
        }

        /* ========== ‰∫ã‰ª∂ËßÜÂõæÊ†∑Âºè ========== */
        .view-container {
            max-width: 100%;
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            margin-top: 5;
        }

        .event-controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .event-legend {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .event-legend::-webkit-scrollbar {
            display: none;
        }

        .event-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            flex-shrink: 0;
            padding: 4px 6px;
            border-radius: 4px;
        }

        .event-legend-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .event-legend-item.disabled {
            opacity: 0.3;
        }

        .event-legend-item.disabled span {
            text-decoration: line-through;
        }

        .event-legend-color {
            width: 16px;
            height: 12px;
            border-radius: 2px;
            border-left: 3px solid rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .event-card {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 20px;
            min-width: 280px;
            max-width: 320px;
            z-index: 1000;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        .event-card.show {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .event-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .event-card-close {
            background: #f5f5f5;
            border: none;
            color: #666;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: background 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .event-card-close:hover {
            background: #e0e0e0;
        }

        .event-card-item {
            margin-bottom: 12px;
        }

        .event-card-item:last-child {
            margin-bottom: 0;
        }

        .event-card-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-card-value {
            font-size: 14px;
            color: #333;
        }

        .gantt-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .gantt-fixed-column {
            width: 70px;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            background: white;
            z-index: 100;
            box-shadow: 2px 0 4px rgba(0,0,0,0.08);
        }

        .gantt-header-date {
            height: 40px;
            min-height: 40px;
            padding: 8px 4px;
            text-align: center;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .gantt-dates-body {
            flex: 1;
            overflow: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .gantt-dates-body::-webkit-scrollbar {
            display: none;
        }

        .gantt-scroll-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            position: relative;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .gantt-scroll-area::-webkit-scrollbar {
            display: none;
        }

        .gantt-header-hours {
            display: flex;
            width: 100%;
            min-width: 1440px;
            height: 40px;
            min-height: 40px;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 10px;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 50;
            pointer-events: none;
        }

        .gantt-hour-cell {
            flex: 1;
            min-width: 60px;
            padding: 8px 2px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gantt-content {
            flex: 1;
            width: 100%;
            min-width: 1440px;
            overflow: visible;
            touch-action: pan-x pan-y;
            user-select: none;
            -webkit-user-select: none;
        }

        .gantt-content::-webkit-scrollbar {
            display: none;
        }

        .gantt-date-label {
            height: 50px;
            min-height: 50px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 11px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .gantt-date-label:hover {
            background: #f8f9ff;
        }

        .gantt-date-label .date-main {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .gantt-date-label .date-sub {
            font-size: 10px;
            color: #666;
            margin-top: 1px;
        }

        .gantt-row {
            display: flex;
            height: 50px;
            min-height: 50px;
            width: 100%;
            min-width: 1440px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .gantt-row:hover {
            background: #f8f9ff;
        }

        .gantt-date-label.today {
            background: #fff8e1;
            border-left: 4px solid #ffa000;
        }

        .gantt-date-label.today:hover {
            background: #ffecb3;
        }

        .gantt-row.today {
            background: #fff8e1;
        }

        .gantt-event {
            position: absolute;
            height: 24px;
            border-radius: 3px;
            padding: 3px 6px;
            font-size: 10px;
            line-height: 1.4;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            pointer-events: auto;
            touch-action: none;
        }

        .gantt-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
            z-index: 40;
            white-space: normal;
        }

        .gantt-event:active {
            transform: translateY(0);
        }

        .event-sleep {
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
            color: white;
            border-left: 4px solid #1976d2;
        }

        .event-feed-milk {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
            color: white;
            border-left: 4px solid #f57c00;
        }

        .event-feed-formula {
            background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
            color: white;
            border-left: 4px solid #c2185b;
        }

        .event-food {
            background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);
            color: white;
            border-left: 4px solid #689f38;
        }

        .event-poop {
            background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);
            color: white;
            border-left: 4px solid #795548;
        }

        .event-weight {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
            border-left: 4px solid #388e3c;
        }

        .event-point {
            width: 28px !important;
            height: 28px !important;
            min-width: 28px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            position: absolute;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 20;
            border: none !important;
        }

        .event-point:hover {
            transform: translateX(-50%) scale(1.4);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50;
        }

        .event-point::after {
            content: attr(data-icon);
            font-size: 13px;
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .event-point.event-feed-milk {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
        }

        .event-point.event-feed-formula {
            background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
        }

        .event-point.event-food {
            background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);
        }

        .event-point.event-poop {
            background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);
        }

        .event-point.event-weight {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
        }

        .gantt-hour-cell.current-hour {
            background: rgba(255, 68, 68, 0.15);
            position: relative;
        }

        .gantt-hour-cell.current-hour::after {
            content: '‚óè';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff4444;
            font-size: 8px;
        }

        .gantt-hour-cell.future-hour {
            opacity: 0.4;
        }

        @media (max-width: 768px) {
            .gantt-fixed-column {
                width: 60px;
                min-width: 60px;
            }

            .gantt-header-date {
                font-size: 10px;
                padding: 6px 2px;
            }

            .gantt-date-label {
                padding: 6px 2px;
            }

            .gantt-date-label .date-main {
                font-size: 12px;
            }

            .gantt-date-label .date-sub {
                font-size: 9px;
            }

            .event-legend {
                font-size: 10px;
                gap: 8px;
            }

            .event-legend-item {
                gap: 3px;
                padding: 3px 4px;
            }

            .event-legend-color {
                width: 14px;
                height: 10px;
            }

            .event-point {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px;
            }

            .event-point::after {
                font-size: 12px;
            }

            .event-card {
                min-width: 240px;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <button class="settings-btn" onclick="openSettings()" title="ËÆæÁΩÆ">‚ò∞</button>
            <h1>üìä ÂÆùÂÆùÊó•Â∏∏</h1>
            <button class="refresh-btn" onclick="refreshData()" title="Âà∑Êñ∞Êï∞ÊçÆ">‚ü≥</button>
        </div>
        <span id="babyAge">Ê≠£Âú®ËÆ°ÁÆó...</span>

        <div id="fileContainer" class="file-input-container">
            <button id="toggleBtn" class="toggle-btn" onclick="toggleFileSection()">üìÅ ÊâãÂä®‰∏ä‰º†CSVÔºàÁÇπÂáªÂ±ïÂºÄÔºâ</button>
            <div id="fileDetails" style="display:none">
                <div class="birth-date-input">
                    <label for="birthDate">üìÖ ÂÆùÂÆùÁîüÊó•Ôºö</label>
                    <input type="date" id="birthDate" value="2025-02-24">
                </div>
                <label class="file-label" for="csvFile">
                    üìÇ ÈÄâÊã©CSVÊñá‰ª∂
                    <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(event)">
                </label>
                <div class="status" id="status">Á≠âÂæÖ‰∏ä‰º†CSVÊñá‰ª∂</div>
            </div>
        </div>

        <div id="dataContainer" class="hidden">
            <!-- ‰ªäÊó•Ê±áÊÄª -->
            <div class="today-summary">
                <div class="summary-header">
                    <h2>üìÖ ‰ªäÊó•Ê±áÊÄª <span id="todayDate"></span></h2>
                </div>
                <div class="summary-content">
                    <div class="today-grid">
                        <div class="today-card" id="feedCard">
                            <h3>üçº ÂñÇÂ•∂ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>ÊÄªÊ¨°Êï∞</span>
                                <span id="todayFeedCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Â•∂Á≤â</span>
                                <span id="todayFormula" class="num">-</span>
                                <span>ml</span>
                            </div>
                            <div class="detail">
                                <span>ÊØç‰π≥</span>
                                <span id="todayBreast" class="num">-</span>
                                <span>ÂàÜÈíü</span>
                            </div>
                        </div>
                        <div class="today-card" id="sleepCard">
                            <h3>üò¥ Áù°Áú†ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todaySleepCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>ÊÄªÊó∂Èïø</span>
                                <span id="todaySleepTotal" class="num">-</span>
                                <span>h</span>
                            </div>
                            <div class="detail">
                                <span>ÊúÄÈïø</span>
                                <span id="todaySleepMax" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>‚òÄÔ∏è ÁôΩÂ§©</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="todayDayFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="todayDaySleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üåô Â§úÈó¥</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="todayNightFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="todayNightSleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                    </div>
                    <div id="todayOther" class="today-grid" style="display:none;">
                        <div class="today-card" id="weightCard" style="display:none">
                            <h3>‚öñÔ∏è ‰ΩìÈáç</h3>
                            <div class="detail">
                                <span>‰ªäÊó•</span>
                                <span id="todayWeight" class="num">-</span>
                                <span>kg</span>
                            </div>
                        </div>
                        <div class="today-card" id="foodCard" style="display:none">
                            <h3>üçΩÔ∏è ËæÖÈ£ü</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todayFood" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                        </div>
                        <div class="today-card" id="poopCard" style="display:none">
                            <h3>üí© Â§ß‰æø</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todayPoop" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êò®Êó•Ê±áÊÄª -->
            <div class="yesterday-summary">
                <div class="summary-header" onclick="toggleYesterday()">
                    <h2>üìÜ Êò®Êó•Ê±áÊÄª <span id="yesterdayDate"></span></h2>
                    <span class="toggle-icon" id="yesterdayToggle">‚ñº</span>
                </div>
                <div class="summary-content collapsed" id="yesterdayContent">
                    <div class="today-grid">
                        <div class="today-card">
                            <h3>üçº ÂñÇÂ•∂ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>ÊÄªÊ¨°Êï∞</span>
                                <span id="yesterdayFeedCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Â•∂Á≤â</span>
                                <span id="yesterdayFormula" class="num">-</span>
                                <span>ml</span>
                            </div>
                            <div class="detail">
                                <span>ÊØç‰π≥</span>
                                <span id="yesterdayBreast" class="num">-</span>
                                <span>ÂàÜÈíü</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üò¥ Áù°Áú†ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="yesterdaySleepCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>ÊÄªÊó∂Èïø</span>
                                <span id="yesterdaySleepTotal" class="num">-</span>
                                <span>h</span>
                            </div>
                            <div class="detail">
                                <span>ÊúÄÈïø</span>
                                <span id="yesterdaySleepMax" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>‚òÄÔ∏è ÁôΩÂ§©</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="yesterdayDayFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="yesterdayDaySleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üåô Â§úÈó¥</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="yesterdayNightFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="yesterdayNightSleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üí§ Âπ≥ÂùáÁù°Áú†</h3>
                    <div class="value"><span id="avgSleep">-</span> h</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>üçº Âπ≥ÂùáÂ•∂Á≤â</h3>
                    <div class="value"><span id="avgFormula">-</span> ml</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>üë∂ Âπ≥ÂùáÊØç‰π≥</h3>
                    <div class="value"><span id="avgBreast">-</span> min</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>‚öñÔ∏è ÂΩìÂâç‰ΩìÈáç</h3>
                    <div class="value"><span id="currentWeight">-</span> kg</div>
                    <div class="label">ÊúÄËøëËÆ∞ÂΩï</div>
                </div>
                <div class="stat-card">
                    <h3>üçº ÂñÇÂ•∂Èó¥Èöî</h3>
                    <div class="value"><span id="avgFeedInterval">-</span> h</div>
                    <div class="label">Âπ≥Âùá</div>
                </div>
                <div class="stat-card">
                    <h3>üí§ Áù°Áú†Èó¥Èöî</h3>
                    <div class="value"><span id="avgSleepInterval">-</span> h</div>
                    <div class="label">Âπ≥Âùá</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÂñÇÂ•∂Ê¨°Êï∞ÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedCount', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedCount', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedCount', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="feedCountChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="feedCountChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÊØèÊó•ÂñÇÂ•∂Èáè</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedAmount', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedAmount', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedAmount', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="feedAmountChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="feedAmountChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí§ Áù°Áú†Êó∂ÈïøÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'sleepDuration', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'sleepDuration', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'sleepDuration', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="sleepDurationChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="sleepDurationChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí§ Áù°Áú†Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'sleepInterval', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'sleepInterval', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'sleepInterval', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="sleepIntervalChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="sleepIntervalChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÂñÇÂ•∂Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedInterval', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedInterval', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedInterval', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="feedIntervalChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="feedIntervalChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">‚öñÔ∏è ‰ΩìÈáçÂèòÂåñ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'weight', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'weight', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'weight', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="weightChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí© Â§ß‰æøÊ¨°Êï∞</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'poop', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'poop', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'poop', 'month')">Êúà</button>
                    </div>
                </div>
                <div id="poopChartLegend" class="chart-legend"></div>
                <div class="chart-slide-wrapper">
                    <div class="chart-slide-inner">
                        <canvas id="poopChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div id="settingsModal" class="modal-overlay" onclick="closeSettingsIfClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>‚öôÔ∏è ËÆæÁΩÆ</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div style="max-height: 600px; overflow-y: auto;">
                <form id="settingsForm">
                    <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px; font-size: 16px;">üë∂ ÂÆùÂÆù‰ø°ÊÅØ</h3>
                    <div class="form-group">
                        <label for="babyNameInput">ÂÆùÂÆùÂêçÂ≠óÔºàÈÄâÂ°´Ôºâ</label>
                        <input type="text" id="babyNameInput" placeholder="‰æãÂ¶ÇÔºöÂ∞èÊòé">
                    </div>
                    <div class="form-group">
                        <label for="birthDateInput">ÂÆùÂÆùÁîüÊó• *</label>
                        <input type="date" id="birthDateInput" required>
                    </div>
                    <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 16px;">ü§ñ AIÂä©ÊâãÈÖçÁΩÆ</h3>
                    <div class="form-group">
                        <label for="llmProvider">LLMÊúçÂä°ÂïÜ</label>
                        <select id="llmProvider" onchange="updateLLMFields()">
                            <option value="">-- ‰∏çÂêØÁî® --</option>
                            <option value="openai">OpenAI</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="claude">Claude (Anthropic)</option>
                        </select>
                    </div>
                    <div id="llmFields" style="display: none;">
                        <div class="form-group">
                            <label for="llmApiKey">API Key *</label>
                            <input type="password" id="llmApiKey" placeholder="ËæìÂÖ•‰Ω†ÁöÑAPIÂØÜÈí•">
                            <small style="color: #999; margin-top: 5px; display: block;">üîí ÂØÜÈí•‰ªÖÂ≠òÂÇ®Âú®Êú¨Âú∞Ôºå‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®</small>
                        </div>
                        <div class="form-group" id="llmEndpointGroup">
                            <label for="llmEndpoint">API Endpoint</label>
                            <input type="url" id="llmEndpoint" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group" id="llmModelGroup">
                            <label for="llmModel">Ê®°ÂûãÂêçÁß∞</label>
                            <input type="text" id="llmModel" placeholder="gpt-4 Êàñ claude-3-5-sonnet-20241022">
                        </div>
                        <!-- Azure ÁâπÊúâÂ≠óÊÆµ -->
                        <div class="form-group" id="azureResourceNameGroup" style="display: none;">
                            <label for="azureResourceName">Resource Name *</label>
                            <input type="text" id="azureResourceName" placeholder="‰æãÂ¶ÇÔºöME/MFG-SMT-CoC-Dev">
                            <small style="color: #999; margin-top: 5px; display: block;">‰ªéAzure PortalÂ§çÂà∂ÔºåÂèØËÉΩÂåÖÂê´Ë∑ØÂæÑÔºàÂ¶Ça/b/cÔºâ</small>
                        </div>
                        <div class="form-group" id="azureVersionGroup" style="display: none;">
                            <label for="azureApiVersion">API Version *</label>
                            <input type="text" id="azureApiVersion" placeholder="‰æãÂ¶ÇÔºö2025-03-01-preview">
                            <small style="color: #999; margin-top: 5px; display: block;">‰æãÂ¶Ç: 2025-03-01-preview, 2024-02-01, 2023-05-15</small>
                        </div>
                        <div class="form-group" id="azureEndpointGroup" style="display: none;">
                            <label for="azureEndpoint">Endpoint *</label>
                            <input type="url" id="azureEndpoint" placeholder="https://your-resource.openai.azure.com/">
                            <small style="color: #999; margin-top: 5px; display: block;">ÂÆåÊï¥ÁöÑAzure OpenAIÁ´ØÁÇπURL</small>
                        </div>
                        <div class="form-group" id="azureDeploymentGroup" style="display: none;">
                            <label for="azureDeploymentName">Deployment Name *</label>
                            <input type="text" id="azureDeploymentName" placeholder="‰æãÂ¶ÇÔºögpt-4-deployment">
                            <small style="color: #999; margin-top: 5px; display: block;">Âú®Azure‰∏≠ÈÉ®ÁΩ≤ÁöÑÊ®°ÂûãÂêçÁß∞</small>
                        </div>
                    </div>

                    <button type="submit" class="save-btn" style="margin-top: 20px;">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- AIÂØπËØùÈù¢Êùø -->
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h3>ü§ñ ÂÆùÂÆùÊï∞ÊçÆÈóÆÁ≠î</h3>
            <button class="close-btn" onclick="closeChatPanel()">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-group">
            <input type="text" id="chatInput" placeholder="ÈóÆÊàëÂÖ≥‰∫éÂÆùÂÆùÁöÑ‰ªª‰ΩïÈóÆÈ¢ò..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" id="sendBtn">‚û§</button>
        </div>
    </div>

    <!-- AIÂØπËØùÊåâÈíÆ -->
    <!-- Â∫ïÈÉ®ÂúÜÂΩ¢ÊåâÈíÆÂ∑≤ÁßªÈô§Ôºõ‰ΩøÁî®‰æßËæπ AI Ê∞îÊ≥°‰Ωú‰∏∫ÂÖ•Âè£ -->

    <script>
        // Áªü‰∏ÄÁöÑÁôΩÂ§©/Â§úÈó¥È¢úËâ≤ÊñπÊ°à
        var COLORS = {
            DAY: 'rgba(255,206,86,0.8)',      // ÁôΩÂ§©Áªü‰∏ÄÈ¢úËâ≤ - ÈªÑËâ≤
            NIGHT: 'rgba(153,102,255,0.8)',   // Â§úÈó¥Áªü‰∏ÄÈ¢úËâ≤ - Á¥´Ëâ≤
            DAY_DARK: 'rgba(255,193,7,0.9)',  // ÁôΩÂ§©Ê∑±Ëâ≤ÔºàÊØç‰π≥Ôºâ
            DAY_LIGHT: 'rgba(255,235,59,0.7)', // ÁôΩÂ§©ÊµÖËâ≤ÔºàÂ•∂Á≤âÔºâ
            NIGHT_DARK: 'rgba(126,87,194,0.9)', // Â§úÈó¥Ê∑±Ëâ≤ÔºàÊØç‰π≥Ôºâ
            NIGHT_LIGHT: 'rgba(179,157,219,0.7)' // Â§úÈó¥ÊµÖËâ≤ÔºàÂ•∂Á≤âÔºâ
        };
        
        var charts = {};

        // HTMLÂõæ‰æãÁîüÊàêÂô®Êèí‰ª∂
        function getOrCreateLegendList(chart, id) {
            var legendContainer = document.getElementById(id);
            if (!legendContainer) return null;
            
            var listContainer = legendContainer.querySelector('ul');
            if (!listContainer) {
                listContainer = document.createElement('ul');
                listContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; list-style: none; padding: 0; margin: 0;';
                legendContainer.innerHTML = '';
                legendContainer.appendChild(listContainer);
            }
            return listContainer;
        }

        var htmlLegendPlugin = {
            id: 'htmlLegend',
            afterUpdate: function(chart, args, options) {
                var ul = getOrCreateLegendList(chart, options.containerID);
                if (!ul) return;

                // Ê∏ÖÁ©∫ÊóßÂõæ‰æã
                while (ul.firstChild) {
                    ul.firstChild.remove();
                }

                // ÁîüÊàêÊñ∞Âõæ‰æã
                var items = chart.options.plugins.legend.labels.generateLabels(chart);
                items.forEach(function(item) {
                    var li = document.createElement('li');
                    li.style.cssText = 'display: flex; align-items: center; gap: 6px; font-size: 12px; color: #666; cursor: pointer; transition: opacity 0.2s;';
                    if (item.hidden) {
                        li.style.opacity = '0.4';
                        li.style.textDecoration = 'line-through';
                    }

                    li.onclick = function() {
                        var type = chart.config.type;
                        if (type === 'pie' || type === 'doughnut') {
                            chart.toggleDataVisibility(item.index);
                        } else {
                            chart.setDatasetVisibility(item.datasetIndex, !chart.isDatasetVisible(item.datasetIndex));
                        }
                        chart.update();
                    };

                    // È¢úËâ≤ÊñπÂùó
                    var boxSpan = document.createElement('span');
                    boxSpan.style.cssText = 'width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; background-color: ' + item.fillStyle + ';';
                    if (item.strokeStyle) {
                        boxSpan.style.border = '2px solid ' + item.strokeStyle;
                    }

                    // ÊñáÂ≠ó
                    var textContainer = document.createElement('span');
                    textContainer.textContent = item.text;

                    li.appendChild(boxSpan);
                    li.appendChild(textContainer);
                    ul.appendChild(li);
                });
            }
        };

        var allAnalyzedData = {};
        
        // ÂõæË°®ÂàÜÈ°µÁä∂ÊÄÅ
        var chartScroll = {
            feedCount: { offset: 0, totalItems: 0 },
            feedAmount: { offset: 0, totalItems: 0 },
            sleepDuration: { offset: 0, totalItems: 0 },
            sleepInterval: { offset: 0, totalItems: 0 },
            feedInterval: { offset: 0, totalItems: 0 },
            weight: { offset: 0, totalItems: 0 },
            poop: { offset: 0, totalItems: 0 }
        };


        // ÈÖçÁΩÆÁõ∏ÂÖ≥ÂáΩÊï∞
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function closeSettingsIfClickOutside(event) {
            if (event.target.id === 'settingsModal') {
                closeSettings();
            }
        }

        function loadSettings() {
            var babyName = localStorage.getItem('babyName') || '';
            var birthDate = localStorage.getItem('birthDate') || '2025-02-24';
            var llmProvider = localStorage.getItem('llmProvider') || '';
            var llmApiKey = localStorage.getItem('llmApiKey') || '';
            var llmEndpoint = localStorage.getItem('llmEndpoint') || '';
            var llmModel = localStorage.getItem('llmModel') || '';
            
            // AzureÁâπÊúâÂ≠óÊÆµ
            var azureResourceName = localStorage.getItem('azureResourceName') || '';
            var azureApiVersion = localStorage.getItem('azureApiVersion') || '';
            var azureEndpoint = localStorage.getItem('azureEndpoint') || '';
            var azureDeploymentName = localStorage.getItem('azureDeploymentName') || '';
            
            document.getElementById('babyNameInput').value = babyName;
            document.getElementById('birthDateInput').value = birthDate;
            document.getElementById('llmProvider').value = llmProvider;
            document.getElementById('llmApiKey').value = llmApiKey;
            document.getElementById('llmEndpoint').value = llmEndpoint;
            document.getElementById('llmModel').value = llmModel;
            
            // Âä†ËΩΩAzureÁâπÊúâÂ≠óÊÆµ
            if (document.getElementById('azureResourceName')) {
                document.getElementById('azureResourceName').value = azureResourceName;
            }
            if (document.getElementById('azureApiVersion')) {
                document.getElementById('azureApiVersion').value = azureApiVersion;
            }
            if (document.getElementById('azureEndpoint')) {
                document.getElementById('azureEndpoint').value = azureEndpoint;
            }
            if (document.getElementById('azureDeploymentName')) {
                document.getElementById('azureDeploymentName').value = azureDeploymentName;
            }
            
            updateLLMFields();
        }

        function updateLLMFields() {
            var provider = document.getElementById('llmProvider').value;
            var llmFields = document.getElementById('llmFields');
            var endpointGroup = document.getElementById('llmEndpointGroup');
            var endpointInput = document.getElementById('llmEndpoint');
            var modelInput = document.getElementById('llmModel');
            var modelGroup = document.getElementById('llmModelGroup');
            
            // AzureÁâπÊúâÂ≠óÊÆµ
            var azureResourceNameGroup = document.getElementById('azureResourceNameGroup');
            var azureVersionGroup = document.getElementById('azureVersionGroup');
            var azureEndpointGroup = document.getElementById('azureEndpointGroup');
            var azureDeploymentGroup = document.getElementById('azureDeploymentGroup');
            
            if (provider) {
                llmFields.style.display = 'block';
                
                // ÈªòËÆ§ÈöêËóèÊâÄÊúâAzureÂ≠óÊÆµ
                if (azureResourceNameGroup) azureResourceNameGroup.style.display = 'none';
                if (azureVersionGroup) azureVersionGroup.style.display = 'none';
                if (azureEndpointGroup) azureEndpointGroup.style.display = 'none';
                if (azureDeploymentGroup) azureDeploymentGroup.style.display = 'none';
                endpointGroup.style.display = 'block';
                modelGroup.style.display = 'block';
                
                if (provider === 'openai') {
                    // Ê†áÂáÜOpenAI
                    if (!endpointInput.value) {
                        endpointInput.value = 'https://api.openai.com/v1';
                    }
                    if (!modelInput.value) {
                        modelInput.value = 'gpt-4';
                    }
                } else if (provider === 'azure') {
                    // Azure OpenAI - ÊòæÁ§∫ÊâÄÊúâ5‰∏™AzureÂ≠óÊÆµ
                    if (azureResourceNameGroup) azureResourceNameGroup.style.display = 'block';
                    if (azureVersionGroup) azureVersionGroup.style.display = 'block';
                    if (azureEndpointGroup) azureEndpointGroup.style.display = 'block';
                    if (azureDeploymentGroup) azureDeploymentGroup.style.display = 'block';
                    
                    // ÈöêËóèÈÄöÁî®ÁöÑendpointÂíåmodelÂ≠óÊÆµÔºàAzureÁî®‰∏ìÊúâÂ≠óÊÆµÔºâ
                    endpointGroup.style.display = 'none';
                    modelGroup.style.display = 'none';
                    
                } else if (provider === 'claude') {
                    // Claude
                    if (!endpointInput.value) {
                        endpointInput.value = 'https://api.anthropic.com';
                    }
                    if (!modelInput.value) {
                        modelInput.value = 'claude-3-5-sonnet-20241022';
                    }
                }
            } else {
                llmFields.style.display = 'none';
            }
        }

        function saveSettings(event) {
            event.preventDefault();
            
            try {
                var babyName = document.getElementById('babyNameInput').value;
                var birthDate = document.getElementById('birthDateInput').value;
                
                var llmProvider = document.getElementById('llmProvider').value;
                var llmApiKey = document.getElementById('llmApiKey').value;
                var llmEndpoint = document.getElementById('llmEndpoint').value;
                var llmModel = document.getElementById('llmModel').value;
                
                // AzureÁâπÊúâÂ≠óÊÆµ
                var azureResourceName = document.getElementById('azureResourceName') ? document.getElementById('azureResourceName').value : '';
                var azureApiVersion = document.getElementById('azureApiVersion') ? document.getElementById('azureApiVersion').value : '';
                var azureEndpoint = document.getElementById('azureEndpoint') ? document.getElementById('azureEndpoint').value : '';
                var azureDeploymentName = document.getElementById('azureDeploymentName') ? document.getElementById('azureDeploymentName').value : '';
                
                localStorage.setItem('babyName', babyName);
                localStorage.setItem('birthDate', birthDate);
                
                // ‰øùÂ≠òLLMÈÖçÁΩÆ
                localStorage.setItem('llmProvider', llmProvider);
                if (llmProvider) {
                    localStorage.setItem('llmApiKey', llmApiKey);
                    
                    if (llmProvider === 'azure') {
                        // ‰øùÂ≠òAzureÁâπÊúâÂ≠óÊÆµ
                        localStorage.setItem('azureResourceName', azureResourceName);
                        localStorage.setItem('azureApiVersion', azureApiVersion);
                        localStorage.setItem('azureEndpoint', azureEndpoint);
                        localStorage.setItem('azureDeploymentName', azureDeploymentName);
                    } else {
                        // ‰øùÂ≠òÈÄöÁî®Â≠óÊÆµ
                        localStorage.setItem('llmEndpoint', llmEndpoint);
                        localStorage.setItem('llmModel', llmModel);
                    }
                }
                
                // Êõ¥Êñ∞ÈöêËóèÁöÑbirthDateËæìÂÖ•Ê°ÜÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                var birthDateInput = document.getElementById('birthDate');
                if (birthDateInput) {
                    birthDateInput.value = birthDate;
                }
                
                // Êõ¥Êñ∞Âπ¥ÈæÑÊòæÁ§∫
                calculateAndDisplayAge();
                
                // Êõ¥Êñ∞Ê†áÈ¢ò
                updatePageTitle();
                
                // ÂÖ≥Èó≠ÂºπÁ™ó
                closeSettings();
                
                // Â¶ÇÊûúÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºåÈáçÊñ∞Ê∏≤ÊüìÂõæË°®
                if (allAnalyzedData && allAnalyzedData.dates && allAnalyzedData.dates.length > 0) {
                    renderCharts(allAnalyzedData);
                }
                
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showSuccessMessage('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
            } catch (error) {
                console.error('‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Èîô:', error);
                showSuccessMessage('‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        function showSuccessMessage(message) {
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            var toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 16px; animation: slideDown 0.3s ease-out;';
            
            // Ê∑ªÂä†Âä®Áîª
            var style = document.createElement('style');
            style.textContent = '@keyframes slideDown { from { transform: translateX(-50%) translateY(-20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }';
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            // 3ÁßíÂêéÁßªÈô§
            setTimeout(function() {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(function() {
                    document.body.removeChild(toast);
                    document.head.removeChild(style);
                }, 300);
            }, 2000);
        }

        function updatePageTitle() {
            var babyName = localStorage.getItem('babyName');
            var h1 = document.querySelector('h1');
            if (babyName && babyName.trim() !== '') {
                h1.textContent = 'üìä ' + babyName + 'ÁöÑÊó•Â∏∏';
            } else {
                h1.textContent = 'üìä ÂÆùÂÆùÊó•Â∏∏';
            }
        }

        function refreshData() {
            var btn = document.querySelector('.refresh-btn');
            btn.classList.add('loading');
            
            fetch('./baby_log.csv', { cache: 'no-cache' })
                .then(function (r) { return r.text(); })
                .then(function (text) {
                    var csv = parseCSV(text);
                    if (csv.length > 0) {
                        // ‰øùÂ≠òÂéüÂßãÊï∞ÊçÆÂà∞localStorage‰æõ‰∫ã‰ª∂ËßÜÂõæ‰ΩøÁî®
                        try {
                            localStorage.setItem('baby_all_raw_rows', JSON.stringify(csv));
                        } catch (e) {
                            console.warn('Êó†Ê≥ï‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage', e);
                        }
                        
                        allAnalyzedData = analyzeData(csv);
                        renderCharts(allAnalyzedData);
                        showSuccessMessage('‚úÖ Êï∞ÊçÆÂ∑≤Âà∑Êñ∞ÔºÅ');
                    } else {
                        showSuccessMessage('‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞Êï∞ÊçÆ');
                    }
                })
                .catch(function (error) {
                    console.error('Âà∑Êñ∞Â§±Ë¥•:', error);
                    showSuccessMessage('‚ùå Âà∑Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂');
                })
                .finally(function() {
                    btn.classList.remove('loading');
                });
        }

        // ========== AIÂØπËØùÂäüËÉΩ ==========
        var chatHistory = [];

        function openChatPanel() {
            var llmProvider = localStorage.getItem('llmProvider');
            if (!llmProvider) {
                showSuccessMessage('‚ö†Ô∏è ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAIÂä©Êâã');
                return;
            }
            document.getElementById('chatPanel').classList.add('show');
            document.getElementById('chatInput').focus();
        }

        function closeChatPanel() {
            document.getElementById('chatPanel').classList.remove('show');
        }

        function formatCSVDataForContext() {
            if (!allAnalyzedData || !allAnalyzedData.dates) {
                return 'Ê≤°ÊúâÂèØÁî®ÁöÑÂÆùÂÆùÊï∞ÊçÆ';
            }
            
            var context = 'ÂÆùÂÆùÊï∞ÊçÆÊëòË¶Å:\n';
            var dates = allAnalyzedData.dates || [];
            
            if (dates.length > 0) {
                var recentDate = dates[dates.length - 1];
                var todayData = allAnalyzedData.data[recentDate];
                
                context += `\nÊúÄËøë‰∏ÄÂ§© (${recentDate}):\n`;
                context += `- ÂñÇÂ•∂Ê¨°Êï∞: ${todayData.milk + todayData.formula}\n`;
                context += `- Â•∂Á≤â: ${Math.round(todayData.formulaMl)}ml\n`;
                context += `- ÊØç‰π≥: ${Math.round(todayData.milkMin)}ÂàÜÈíü\n`;
                context += `- Áù°Áú†Ê¨°Êï∞: ${todayData.sleep ? todayData.sleep.length : 0}\n`;
                context += `- ÊÄªÁù°Áú†Êó∂Èïø: ${todayData.sleepTotal ? todayData.sleepTotal.toFixed(1) : 0}Â∞èÊó∂\n`;
                context += `- ‰ΩìÈáç: ${todayData.weight || 'Êú™ËÆ∞ÂΩï'}kg\n`;
                context += `- Â§ß‰æøÊ¨°Êï∞: ${todayData.poop || 0}\n`;
                
                if (dates.length > 1) {
                    context += `\nÊúÄËøë ${Math.min(dates.length, 7)} Â§©Âπ≥ÂùáÊï∞ÊçÆ:\n`;
                    var recentDays = dates.slice(-7);
                    var avgFeed = 0, avgSleep = 0, avgFormula = 0;
                    recentDays.forEach(function(d) {
                        avgFeed += allAnalyzedData.data[d].milk + allAnalyzedData.data[d].formula;
                        avgSleep += allAnalyzedData.data[d].sleepTotal || 0;
                        avgFormula += allAnalyzedData.data[d].formulaMl || 0;
                    });
                    context += `- Âπ≥ÂùáÂñÇÂ•∂Ê¨°Êï∞: ${(avgFeed / recentDays.length).toFixed(1)}\n`;
                    context += `- Âπ≥ÂùáÁù°Áú†Êó∂Èïø: ${(avgSleep / recentDays.length).toFixed(1)}Â∞èÊó∂\n`;
                    context += `- Âπ≥ÂùáÂ•∂Á≤âÈáè: ${(avgFormula / recentDays.length).toFixed(0)}ml\n`;
                }
            }
            
            return context;
        }

        function addMessageToChat(message, isUser) {
            var messagesDiv = document.getElementById('chatMessages');
            var messageEl = document.createElement('div');
            messageEl.className = 'chat-message ' + (isUser ? 'user' : 'assistant');
            messageEl.textContent = message;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            
            if (!message) return;
            
            var llmProvider = localStorage.getItem('llmProvider');
            if (!llmProvider) {
                addMessageToChat('‚ùå ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAIÂä©Êâã', false);
                return;
            }
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessageToChat(message, true);
            input.value = '';
            
            var sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            
            // Ê∑ªÂä†Âä†ËΩΩÊåáÁ§∫
            var loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-message assistant';
            loadingMsg.innerHTML = '<div class="loading-indicator"></div>ÊÄùËÄÉ‰∏≠...';
            document.getElementById('chatMessages').appendChild(loadingMsg);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            
            // ÂáÜÂ§áÊ∂àÊÅØ
            chatHistory.push({ role: 'user', content: message });
            
            // Ëé∑ÂèñÊï∞ÊçÆ‰∏ä‰∏ãÊñá
            var dataContext = formatCSVDataForContext();
            
            // Ê†πÊçÆ‰∏çÂêåÁöÑLLMÊèê‰æõÂïÜË∞ÉÁî®API
            if (llmProvider === 'openai') {
                callOpenAI(dataContext, loadingMsg, sendBtn);
            } else if (llmProvider === 'claude') {
                callClaude(dataContext, loadingMsg, sendBtn);
            }
        }

        function callOpenAI(dataContext, loadingMsg, sendBtn) {
            var apiKey = localStorage.getItem('llmApiKey');
            var provider = localStorage.getItem('llmProvider');
            
            var systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÂ©¥ÂÑøÊä§ÁêÜÂä©Êâã„ÄÇÁî®Êà∑‰ºöÂêë‰Ω†ËØ¢ÈóÆÂÖ≥‰∫é‰ªñ‰ª¨ÂÆùÂÆùÁöÑÈóÆÈ¢ò„ÄÇ‰ª•‰∏ãÊòØÊúÄËøëÁöÑÂÆùÂÆùÊï∞ÊçÆ:\n\n${dataContext}\n\nËØ∑Ê†πÊçÆËøô‰∫õÊï∞ÊçÆÂíåÁî®Êà∑ÁöÑÈóÆÈ¢òÊèê‰æõÊúâÂ∏ÆÂä©ÁöÑÂª∫ËÆÆ„ÄÇ`;
            
            var messages = [
                { role: 'system', content: systemPrompt }
            ];
            
            // Ê∑ªÂä†ËÅäÂ§©ÂéÜÂè≤
            messages = messages.concat(chatHistory);
            
            var apiUrl, headers, body;
            
            if (provider === 'azure') {
                // Azure OpenAI - ‰ΩøÁî®5‰∏™Áã¨Á´ãÂ≠óÊÆµ
                var azureResourceName = localStorage.getItem('azureResourceName');
                var azureApiVersion = localStorage.getItem('azureApiVersion');
                var azureEndpoint = localStorage.getItem('azureEndpoint');
                var azureDeploymentName = localStorage.getItem('azureDeploymentName');
                
                // È™åËØÅÊâÄÊúâÂøÖË¶ÅÂ≠óÊÆµ
                if (!apiKey || !azureResourceName || !azureApiVersion || !azureEndpoint || !azureDeploymentName) {
                    var missing = [];
                    if (!apiKey) missing.push('API Key');
                    if (!azureResourceName) missing.push('Resource Name');
                    if (!azureApiVersion) missing.push('API Version');
                    if (!azureEndpoint) missing.push('Endpoint');
                    if (!azureDeploymentName) missing.push('Deployment Name');
                    
                    addMessageToChat('‚ùå ÈîôËØØÔºöAzureÈÖçÁΩÆ‰∏çÂÆåÊï¥\nÁº∫Â∞ë: ' + missing.join(', '), false);
                    sendBtn.disabled = false;
                    loadingMsg.remove();
                    return;
                }
                
                // ÊûÑÂª∫Azure URLÊ†ºÂºè
                // https://endpoint/openai/deployments/deployment-name/chat/completions?api-version=version
                apiUrl = azureEndpoint.replace(/\/$/, '') + '/openai/deployments/' + azureDeploymentName + '/chat/completions?api-version=' + azureApiVersion;
                
                headers = {
                    'Content-Type': 'application/json',
                    'api-key': apiKey  // Azure‰ΩøÁî®api-key header
                };
                
                console.log('üîµ [Azure] Resource Name:', azureResourceName);
                console.log('üîµ [Azure] Endpoint:', azureEndpoint);
                console.log('üîµ [Azure] Deployment:', azureDeploymentName);
                console.log('üîµ [Azure] API Version:', azureApiVersion);
                console.log('üîµ [Azure] Final URL:', apiUrl);
                
            } else {
                // OpenAI Êàñ Claude
                var endpoint = localStorage.getItem('llmEndpoint');
                var model = localStorage.getItem('llmModel');
                
                if (provider === 'openai') {
                    apiUrl = endpoint + '/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    };
                } else if (provider === 'claude') {
                    apiUrl = endpoint + '/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                }
            }
            
            // ÊûÑÂª∫request body
            if (provider === 'azure') {
                // Azure‰∏çÈúÄË¶ÅmodelÂ≠óÊÆµ
                body = JSON.stringify({
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1000
                });
            } else if (provider === 'claude') {
                // ClaudeÊ†ºÂºè
                var model = localStorage.getItem('llmModel');
                body = JSON.stringify({
                    model: model,
                    max_tokens: 1000,
                    system: systemPrompt,
                    messages: chatHistory
                });
            } else {
                // OpenAIÊ†ºÂºè
                var model = localStorage.getItem('llmModel');
                body = JSON.stringify({
                    model: model,
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1000
                });
            }
            
            console.log('üì§ Request URL:', apiUrl);
            console.log('üì§ Request Headers:', headers);
            console.log('üì§ Request Body:', body.substring(0, 200) + '...');
            
            // ÂàõÂª∫Ë∂ÖÊó∂Promise
            var timeoutPromise = new Promise(function(resolve, reject) {
                setTimeout(function() {
                    reject(new Error('ËØ∑Ê±ÇË∂ÖÊó∂Ôºà30ÁßíÔºâ- ÊúçÂä°Âô®ÂèØËÉΩÊó†ÂìçÂ∫îÊàñÁΩëÁªúÁºìÊÖ¢'));
                }, 30000); // 30ÁßíË∂ÖÊó∂
            });
            
            // ÊâßË°åËØ∑Ê±Ç
            var fetchPromise = fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: body
            });
            
            // Ê∑ªÂä†ËØ¶ÁªÜÁöÑÈîôËØØÂ§ÑÁêÜ
            Promise.race([fetchPromise, timeoutPromise])
            .then(function(response) {
                console.log('‚úÖ ÂìçÂ∫îÁä∂ÊÄÅÁ†Å:', response.status);
                
                if (!response.ok) {
                    return response.text().then(function(text) {
                        console.error('‚ùå ÈîôËØØÂìçÂ∫î:', text);
                        try {
                            var errData = JSON.parse(text);
                            var errorMsg = errData.error?.message || JSON.stringify(errData);
                            throw new Error('APIÈîôËØØ ' + response.status + ': ' + errorMsg);
                        } catch(e) {
                            throw new Error('APIÈîôËØØ ' + response.status + ': ' + text.substring(0, 100));
                        }
                    });
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ ÂìçÂ∫îÊï∞ÊçÆ:', data);
                loadingMsg.remove();
                
                var assistantMessage;
                
                if (provider === 'claude') {
                    // ClaudeÂìçÂ∫îÊ†ºÂºè
                    if (data.content && data.content[0] && data.content[0].text) {
                        assistantMessage = data.content[0].text;
                    }
                } else {
                    // OpenAIÂíåAzureÂìçÂ∫îÊ†ºÂºè
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        assistantMessage = data.choices[0].message.content;
                    }
                }
                
                if (assistantMessage) {
                    chatHistory.push({ role: 'assistant', content: assistantMessage });
                    addMessageToChat(assistantMessage, false);
                } else {
                    addMessageToChat('‚ùå Êó†Ê≥ïËé∑ÂèñÂìçÂ∫î: ' + JSON.stringify(data), false);
                }
                sendBtn.disabled = false;
            })
            .catch(function(error) {
                console.error('‚ùå ÂÆåÊï¥ÈîôËØØ:', error);
                loadingMsg.remove();
                
                var errorMsg = error.message;
                
                // Êô∫ËÉΩÈîôËØØËØäÊñ≠
                if (errorMsg.includes('CORS')) {
                    errorMsg += '\n\nüí° CORSÈîôËØØ - ÂèØËÉΩÈúÄË¶Å‰ΩøÁî®ÊúçÂä°Âô®‰ª£ÁêÜ';
                } else if (errorMsg.includes('Ë∂ÖÊó∂')) {
                    errorMsg += '\n\nüí° Ê£ÄÊü•Ôºö\n1. EndpointÊòØÂê¶Ê≠£Á°Æ\n2. Deployment NameÊòØÂê¶Â≠òÂú®\n3. ÁΩëÁªúËøûÊé•';
                } else if (errorMsg.includes('404')) {
                    errorMsg += '\n\nüí° ËµÑÊ∫ê‰∏çÂ≠òÂú® - Ê£ÄÊü•Ôºö\n1. Deployment Name\n2. API Version\n3. Resource Name';
                } else if (errorMsg.includes('401') || errorMsg.includes('403')) {
                    errorMsg += '\n\nüí° ËÆ§ËØÅÂ§±Ë¥• - Ê£ÄÊü•API KeyÊòØÂê¶Ê≠£Á°Æ';
                }
                
                addMessageToChat('‚ùå ÈîôËØØ: ' + errorMsg, false);
                sendBtn.disabled = false;
            });
        }

        function callClaude(dataContext, loadingMsg, sendBtn) {
            var apiKey = localStorage.getItem('llmApiKey');
            var endpoint = localStorage.getItem('llmEndpoint') || 'https://api.anthropic.com';
            var model = localStorage.getItem('llmModel') || 'claude-3-5-sonnet-20241022';
            
            var systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÂ©¥ÂÑøÊä§ÁêÜÂä©Êâã„ÄÇÁî®Êà∑‰ºöÂêë‰Ω†ËØ¢ÈóÆÂÖ≥‰∫é‰ªñ‰ª¨ÂÆùÂÆùÁöÑÈóÆÈ¢ò„ÄÇ‰ª•‰∏ãÊòØÊúÄËøëÁöÑÂÆùÂÆùÊï∞ÊçÆ:\n\n${dataContext}\n\nËØ∑Ê†πÊçÆËøô‰∫õÊï∞ÊçÆÂíåÁî®Êà∑ÁöÑÈóÆÈ¢òÊèê‰æõÊúâÂ∏ÆÂä©ÁöÑÂª∫ËÆÆ„ÄÇ`;
            
            var messages = [];
            
            // Ê∑ªÂä†ËÅäÂ§©ÂéÜÂè≤ÔºåËΩ¨Êç¢‰∏∫ClaudeÊ†ºÂºè
            chatHistory.forEach(function(msg) {
                messages.push({
                    role: msg.role,
                    content: msg.content
                });
            });
            
            fetch(endpoint + '/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 1000,
                    system: systemPrompt,
                    messages: messages
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('APIÈîôËØØ: ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                loadingMsg.remove();
                if (data.content && data.content[0] && data.content[0].text) {
                    var assistantMessage = data.content[0].text;
                    chatHistory.push({ role: 'assistant', content: assistantMessage });
                    addMessageToChat(assistantMessage, false);
                } else {
                    addMessageToChat('‚ùå Êó†Ê≥ïËé∑ÂèñÂìçÂ∫î', false);
                }
                sendBtn.disabled = false;
            })
            .catch(function(error) {
                loadingMsg.remove();
                addMessageToChat('‚ùå ÈîôËØØ: ' + error.message, false);
                sendBtn.disabled = false;
            });
        }

        function initializeSettings() {
            // ‰ªélocalStorageÂä†ËΩΩÂá∫ÁîüÊó•Êúü
            var savedBirthDate = localStorage.getItem('birthDate');
            if (savedBirthDate) {
                var birthDateEl = document.getElementById('birthDate');
                if (birthDateEl) {
                    birthDateEl.value = savedBirthDate;
                }
            }
            
            updatePageTitle();
            calculateAndDisplayAge();
            
            // ‰∏∫Ë°®ÂçïÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            var settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.onsubmit = null;
                settingsForm.addEventListener('submit', function(e) {
                    saveSettings(e);
                }, false);
            }
        }

        function toggleFileSection() {
            var details = document.getElementById('fileDetails');
            var btn = document.getElementById('toggleBtn');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                btn.textContent = 'üìÅ Êî∂Ëµ∑';
            } else {
                details.style.display = 'none';
                btn.textContent = 'üìÅ ÊâãÂä®‰∏ä‰º†CSVÔºàÁÇπÂáªÂ±ïÂºÄÔºâ';
            }
        }

        function toggleYesterday() {
            var content = document.getElementById('yesterdayContent');
            var icon = document.getElementById('yesterdayToggle');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '‚ñ∂';
            }
        }

        function calculateAndDisplayAge() {
            // ‰ºòÂÖà‰ªélocalStorageËØªÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéinputÂÖÉÁ¥†ËØªÂèñ
            var birthDateStr = localStorage.getItem('birthDate');
            if (!birthDateStr) {
                var birthDateInput = document.getElementById('birthDate');
                if (birthDateInput) {
                    birthDateStr = birthDateInput.value;
                }
            }
            
            if (!birthDateStr) return;
            
            var birthDate = new Date(birthDateStr);
            var today = new Date();
            var months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
            var days = today.getDate() - birthDate.getDate();
            if (days < 0) {
                months--;
                var lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                days = lastMonth.getDate() - birthDate.getDate() + today.getDate();
            }
            
            // Ëé∑ÂèñÂÆùÂÆùÂêçÂ≠ó
            var babyName = localStorage.getItem('babyName');
            var displayName = (babyName && babyName.trim() !== '') ? babyName : 'ÂÆùÂÆù';
            
            document.getElementById('babyAge').textContent = displayName + 'Â∑≤Áªè ' + months + ' ‰∏™Êúà ' + days + ' Â§©‰∫Ü üéâ';
        }

        // Â§ÑÁêÜCSVÊñá‰ª∂‰∏ä‰º†
        function handleCSVUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('status').textContent = '‚è≥ Ê≠£Âú®ËØªÂèñÊñá‰ª∂...';
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var text = e.target.result;
                    var csv = parseCSV(text);
                    
                    if (csv.length === 0) {
                        document.getElementById('status').textContent = '‚ùå Êñá‰ª∂Ê†ºÂºèÈîôËØØÊàñÊó†Êï∞ÊçÆ';
                        return;
                    }
                    
                    // ‰øùÂ≠òÂéüÂßãÊï∞ÊçÆÂà∞localStorage‰æõ‰∫ã‰ª∂ËßÜÂõæ‰ΩøÁî®
                    try {
                        localStorage.setItem('baby_all_raw_rows', JSON.stringify(csv));
                    } catch (err) {
                        console.warn('Êó†Ê≥ï‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage', err);
                    }
                    
                    // ÂàÜÊûêÊï∞ÊçÆÂπ∂Ê∏≤ÊüìÂõæË°®
                    allAnalyzedData = analyzeData(csv);
                    renderCharts(allAnalyzedData);
                    
                    document.getElementById('status').textContent = '‚úÖ Êñá‰ª∂Âä†ËΩΩÊàêÂäüÔºÅÂÖ± ' + csv.length + ' Êù°ËÆ∞ÂΩï';
                    
                    // ÊòæÁ§∫Êï∞ÊçÆÂÆπÂô®
                    var dataContainer = document.getElementById('dataContainer');
                    if (dataContainer) {
                        dataContainer.classList.remove('hidden');
                    }
                    
                    showSuccessMessage('‚úÖ CSVÊñá‰ª∂Âä†ËΩΩÊàêÂäüÔºÅ');
                } catch (error) {
                    console.error('Ëß£ÊûêÈîôËØØ:', error);
                    document.getElementById('status').textContent = '‚ùå Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ' + error.message;
                }
            };
            
            reader.onerror = function() {
                document.getElementById('status').textContent = '‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•';
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(text) {
            var lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            var headers = lines[0].split(',').map(function (h) { return h.trim(); });
            var data = [];
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                var cols = line.split(',');
                var row = {};
                for (var j = 0; j < headers.length; j++) {
                    row[headers[j]] = cols[j] ? cols[j].trim() : '';
                }
                if (row.timestamp) data.push(row);
            }
            return data;
        }

        // Âà§Êñ≠Êó∂Èó¥Â∫îËØ•ÂΩíÂ±ûÂì™‰∏ÄÂ§©ÔºàÊôö‰∏ä8ÁÇπÂà∞Ê¨°Êó•Êó©‰∏ä6ÁÇπÂΩíÂâç‰∏ÄÂ§©Ôºâ
        function getClassifyDate(timestamp) {
            var date = timestamp.split(' ')[0];
            var hour = parseInt(timestamp.split(' ')[1].split(':')[0]);
            var classifyDate = new Date(date + 'T00:00:00');
            
            // Êôö‰∏ä8ÁÇπ(20:00)Âà∞Ê¨°Êó•Êó©‰∏ä6ÁÇπÂΩíÂâç‰∏ÄÂ§©
            if (hour < 6 || hour >= 20) {
                if (hour < 6) {
                    classifyDate.setDate(classifyDate.getDate() - 1);
                }
            }
            
            var classifyFullDate = classifyDate.getFullYear() + '-' + 
                                  String(classifyDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                  String(classifyDate.getDate()).padStart(2, '0');
            return {
                fullDate: classifyFullDate,
                shortDate: classifyFullDate.substring(5)
            };
        }

        function analyzeData(csvData) {
            var dailyStats = {};
            var today = new Date().toISOString().split('T')[0];
            var latestRecords = {};
            var todayData = null;
            var latestWeight = null;

            csvData.forEach(function (row) {
                var ts = row.timestamp.trim();
                if (!ts || !/\d{4}-\d{2}-\d{2}/.test(ts)) return;

                var date = ts.split(' ')[0];
                var hour = parseInt(ts.split(' ')[1].split(':')[0]);
                // Â§úÈó¥Êó∂ÊÆµÔºö20:00-06:00
                var isNight = hour >= 20 || hour < 6;

                var type = row.event_type.trim();
                var sub = row.subtype.trim();
                var val = parseFloat(row.value) || 0;

                // Â§ÑÁêÜÁù°Áú†ÔºàÁâπÊÆäÂ§ÑÁêÜÔºåÂõ†‰∏∫ÂÆÉÊúâpair_keyÔºâ
                if (type === 'Áù°Ëßâ' && sub === 'ÁªìÊùü' && row.pair_key) {
                    try {
                        var start = new Date(row.pair_key.replace(' ', 'T'));
                        var end = new Date(ts.replace(' ', 'T'));
                        var h = (end - start) / 3600000;
                        if (h > 0 && h < 24) {
                            var startHour = parseInt(row.pair_key.split(' ')[1].split(':')[0]);
                            var startMinute = parseInt(row.pair_key.split(' ')[1].split(':')[1]);
                            var endHour = parseInt(ts.split(' ')[1].split(':')[0]);
                            var endMinute = parseInt(ts.split(' ')[1].split(':')[1]);
                            
                            // Ê†πÊçÆÂºÄÂßãÊó∂Èó¥Âà§Êñ≠ÂΩíÂ±ûÊó•Êúü
                            var classified = getClassifyDate(row.pair_key);
                            
                            if (!dailyStats[classified.shortDate]) {
                                dailyStats[classified.shortDate] = {
                                    fullDate: classified.fullDate,
                                    milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                                    sleep: [], food: 0, poop: 0,
                                    dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                                    dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                                    feedTimes: [], sleepEndTimes: []
                                };
                            }
                            
                            var s = dailyStats[classified.shortDate];
                            s.sleep.push(h);
                            s.sleepEndTimes.push(end);
                            
                            // ËÆ°ÁÆóÁôΩÂ§©ÂíåÂ§úÈó¥ÁöÑÈáçÂè†Êó∂Èó¥
                            // ËæπÁïåÊó∂Èó¥Ôºö6:00 Âíå 20:00
                            var startDecimal = startHour + startMinute / 60;
                            var endDecimal = endHour + endMinute / 60;
                            
                            var daySleepHours = 0;
                            var nightSleepHours = 0;
                            
                            // Â¶ÇÊûúË∑®Â§©ÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                            if (end.getDate() !== start.getDate()) {
                                // Ë∑®Â§©ÊÉÖÂÜµÔºöËÆ°ÁÆóÁ¨¨‰∏ÄÂ§©ÁöÑÈÉ®ÂàÜ
                                if (startDecimal >= 6 && startDecimal < 20) {
                                    // ÂºÄÂßãÂú®ÁôΩÂ§©
                                    daySleepHours += 20 - startDecimal;
                                    nightSleepHours += 24 - 20; // 20:00Âà∞24:00
                                } else if (startDecimal >= 20) {
                                    // ÂºÄÂßãÂú®Êôö‰∏ä
                                    nightSleepHours += 24 - startDecimal;
                                } else {
                                    // ÂºÄÂßãÂú®ÂáåÊô®
                                    nightSleepHours += 6 - startDecimal;
                                    daySleepHours += 20 - 6; // ÂÆåÊï¥ÁôΩÂ§©
                                    nightSleepHours += 24 - 20; // 20:00Âà∞24:00
                                }
                                
                                // ËÆ°ÁÆóÁ¨¨‰∫åÂ§©ÁöÑÈÉ®ÂàÜ
                                if (endDecimal >= 6 && endDecimal <= 20) {
                                    // ÁªìÊùüÂú®ÁôΩÂ§©
                                    nightSleepHours += 6; // 0:00Âà∞6:00
                                    daySleepHours += endDecimal - 6;
                                } else if (endDecimal < 6) {
                                    // ÁªìÊùüÂú®ÂáåÊô®
                                    nightSleepHours += endDecimal;
                                } else {
                                    // ÁªìÊùüÂú®Êôö‰∏ä
                                    nightSleepHours += 6;
                                    daySleepHours += 20 - 6;
                                    nightSleepHours += endDecimal - 20;
                                }
                            } else {
                                // Âêå‰∏ÄÂ§©ÂÜÖÁöÑÁù°Áú†
                                if (startDecimal >= 20 || endDecimal <= 6) {
                                    // ÂÆåÂÖ®Âú®Â§úÈó¥
                                    nightSleepHours = h;
                                } else if (startDecimal >= 6 && endDecimal <= 20) {
                                    // ÂÆåÂÖ®Âú®ÁôΩÂ§©
                                    daySleepHours = h;
                                } else if (startDecimal < 6 && endDecimal > 6 && endDecimal <= 20) {
                                    // Ë∑®Ë∂äÊó©‰∏ä6ÁÇπÔºöÂáåÊô® ‚Üí ÁôΩÂ§©
                                    nightSleepHours = 6 - startDecimal;
                                    daySleepHours = endDecimal - 6;
                                } else if (startDecimal >= 6 && startDecimal < 20 && endDecimal > 20) {
                                    // Ë∑®Ë∂äÊôö‰∏ä20ÁÇπÔºöÁôΩÂ§© ‚Üí Â§úÈó¥
                                    daySleepHours = 20 - startDecimal;
                                    nightSleepHours = endDecimal - 20;
                                } else if (startDecimal < 6 && endDecimal > 20) {
                                    // Ë∑®Ë∂ä‰∏§‰∏™ËæπÁïåÔºöÂáåÊô® ‚Üí ÁôΩÂ§© ‚Üí Â§úÈó¥
                                    nightSleepHours = 6 - startDecimal;
                                    daySleepHours = 20 - 6;
                                    nightSleepHours += endDecimal - 20;
                                }
                            }
                            
                            s.daySleep += daySleepHours;
                            s.nightSleep += nightSleepHours;
                            
                            // ‰ΩøÁî®ÁªìÊùüÊó∂Èó¥‰Ωú‰∏∫ÈÜíÊù•Êó∂Èó¥
                            if (classified.fullDate === today) {
                                latestRecords.sleep = { 
                                    t: ts.split(' ')[1],
                                    h: h.toFixed(1) 
                                };
                            }
                        }
                    } catch (e) { }
                    return; // Áù°Áú†Â§ÑÁêÜÂÆåÊØïÔºåË∑≥ËøáÂêéÈù¢ÁöÑÂ§ÑÁêÜ
                }

                // ÂÖ∂‰ªñ‰∫ã‰ª∂Á±ªÂûãÊ†πÊçÆÊó∂Èó¥Êà≥Âà§Êñ≠ÂΩíÂ±ûÊó•Êúü
                var classified = getClassifyDate(ts);
                var shortDate = classified.shortDate;

                if (!dailyStats[shortDate]) {
                    dailyStats[shortDate] = {
                        fullDate: classified.fullDate,
                        milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                        sleep: [], food: 0, poop: 0,
                        dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                        dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                        feedTimes: [], sleepEndTimes: []
                    };
                }

                var s = dailyStats[shortDate];

                if (type === 'ÂñÇÂ•∂') {
                    if (sub === 'ÊØç‰π≥' || sub === 'Â•∂Á≤â') {
                        s.feedTimes.push(new Date(ts.replace(' ', 'T')));
                    }
                    if (sub === 'ÊØç‰π≥') {
                        s.milk++;
                        if (val > 0) s.milkMin += val;
                        if (isNight) {
                            s.nightFeed++;
                            s.nightMilk++;
                        } else {
                            s.dayFeed++;
                            s.dayMilk++;
                        }
                        if (classified.fullDate === today) latestRecords.milk = { t: ts.split(' ')[1], v: val };
                    } else if (sub === 'Â•∂Á≤â') {
                        s.formula++;
                        if (val > 0) s.formulaMl += val;
                        if (isNight) {
                            s.nightFeed++;
                            s.nightFormula++;
                        } else {
                            s.dayFeed++;
                            s.dayFormula++;
                        }
                        if (classified.fullDate === today) latestRecords.formula = { t: ts.split(' ')[1], v: val };
                    }
                } else if (type === '‰ΩìÈáç' && val > 0) {
                    s.weight = val;
                    latestWeight = val;
                    if (classified.fullDate === today) latestRecords.weight = { t: ts.split(' ')[1], v: val };
                } else if (type === 'ËæÖÈ£ü') {
                    s.food++;
                    if (classified.fullDate === today) {
                        if (!latestRecords.foods) latestRecords.foods = [];
                        var foodDesc = sub || '';
                        if (row.notes && row.notes.trim()) foodDesc += (foodDesc ? ' - ' : '') + row.notes.trim();
                        latestRecords.foods.push({ t: ts.split(' ')[1], desc: foodDesc || '(Êó†ÊèèËø∞)' });
                    }
                } else if (type === 'Êç¢Â∞øÂ∏É' && sub === 'Â§ß‰æø') {
                    s.poop++;
                    if (classified.fullDate === today) latestRecords.poop = { t: ts.split(' ')[1] };
                }

                if (classified.fullDate === today) todayData = s;
            });

            var dates = Object.keys(dailyStats).sort();
            var result = {};
            dates.forEach(function (d) {
                var s = dailyStats[d];
                var total = s.sleep.reduce(function (a, b) { return a + b; }, 0);
                
                var feedIntervals = [];
                for (var i = 1; i < s.feedTimes.length; i++) {
                    var interval = (s.feedTimes[i] - s.feedTimes[i-1]) / 3600000;
                    // ËøáÊª§ÊéâË¥üÊï∞ÂíåÂºÇÂ∏∏ÂÄºÔºà>24Â∞èÊó∂ÁöÑÈó¥ÈöîÂèØËÉΩÊòØË∑®Â§©Êï∞ÊçÆÈóÆÈ¢òÔºâ
                    if (interval > 0 && interval < 24) {
                        var hour = s.feedTimes[i-1].getHours();
                        var isNightInterval = hour >= 20 || hour < 6;
                        feedIntervals.push({ value: interval, isDay: !isNightInterval });
                    }
                }
                
                var sleepIntervals = [];
                for (var i = 1; i < s.sleepEndTimes.length; i++) {
                    var interval = (s.sleepEndTimes[i] - s.sleepEndTimes[i-1]) / 3600000;
                    // ËøáÊª§ÊéâË¥üÊï∞ÂíåÂºÇÂ∏∏ÂÄº
                    if (interval > 0 && interval < 24) {
                        var hour = s.sleepEndTimes[i-1].getHours();
                        var isNightInterval = hour >= 20 || hour < 6;
                        sleepIntervals.push({ value: interval, isDay: !isNightInterval });
                    }
                }

                result[d] = {
                    fullDate: s.fullDate,
                    milk: s.milk, milkMin: s.milkMin, formula: s.formula, formulaMl: s.formulaMl,
                    sleep: Math.round(total * 10) / 10, sleepCnt: s.sleep.length,
                    maxSleep: s.sleep.length > 0 ? Math.max.apply(null, s.sleep).toFixed(1) : 0,
                    food: s.food, poop: s.poop,
                    dayFeed: s.dayFeed, nightFeed: s.nightFeed,
                    dayMilk: s.dayMilk, nightMilk: s.nightMilk,
                    dayFormula: s.dayFormula, nightFormula: s.nightFormula,
                    daySleep: Math.round(s.daySleep * 10) / 10, nightSleep: Math.round(s.nightSleep * 10) / 10,
                    weight: s.weight,
                    feedIntervals: feedIntervals,
                    sleepIntervals: sleepIntervals
                };
            });

            return {
                data: result, dates: dates, weight: latestWeight,
                latest: latestRecords,
                today: todayData ? {
                    milk: todayData.milk, milkMin: todayData.milkMin,
                    formula: todayData.formula, formulaMl: todayData.formulaMl,
                    sleep: todayData.sleep,
                    sleepTotal: todayData.sleep.reduce(function (a, b) { return a + b; }, 0),
                    maxSleep: todayData.sleep.length > 0 ? Math.max.apply(null, todayData.sleep) : 0,
                    dayFeed: todayData.dayFeed, nightFeed: todayData.nightFeed,
                    daySleep: todayData.daySleep, nightSleep: todayData.nightSleep,
                    food: todayData.food, poop: todayData.poop, weight: todayData.weight
                } : null,
                yesterday: (function() {
                    var yd = new Date();
                    yd.setDate(yd.getDate() - 1);
                    var yesterdayKey = String(yd.getMonth() + 1).padStart(2, '0') + '-' + String(yd.getDate()).padStart(2, '0');
                    return result[yesterdayKey] || null;
                })(),
                foods: latestRecords.foods || []
            };
        }

        function aggregateByDimension(data, dimension) {
            var result = {};
            if (dimension === 'day') {
                return data.data;
            } else if (dimension === 'week') {
                data.dates.forEach(function (d) {
                    var fullDate = data.data[d].fullDate;
                    var dateObj = new Date(fullDate);
                    var year = dateObj.getFullYear();
                    var firstDayOfYear = new Date(year, 0, 1);
                    var pastDaysOfYear = (dateObj - firstDayOfYear) / 86400000;
                    var weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                    var weekKey = year + '-W' + String(weekNumber).padStart(2, '0');
                    if (!result[weekKey]) {
                        result[weekKey] = {
                            fullDate: weekKey,
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            food: 0, poop: 0,
                            dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                            dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                            feedIntervals: [], sleepIntervals: [], count: 0
                        };
                    }
                    var w = result[weekKey];
                    var s = data.data[d];
                    w.milk += s.milk;
                    w.milkMin += s.milkMin;
                    w.formula += s.formula;
                    w.formulaMl += s.formulaMl;
                    w.sleep += s.sleep;
                    w.sleepCnt += s.sleepCnt;
                    if (parseFloat(s.maxSleep) > parseFloat(w.maxSleep)) w.maxSleep = s.maxSleep;
                    w.food += s.food;
                    w.poop += s.poop;
                    w.dayFeed += s.dayFeed;
                    w.nightFeed += s.nightFeed;
                    w.dayMilk += s.dayMilk;
                    w.nightMilk += s.nightMilk;
                    w.dayFormula += s.dayFormula;
                    w.nightFormula += s.nightFormula;
                    w.daySleep += s.daySleep;
                    w.nightSleep += s.nightSleep;
                    if (s.weight) w.weight = s.weight;
                    w.feedIntervals = w.feedIntervals.concat(s.feedIntervals);
                    w.sleepIntervals = w.sleepIntervals.concat(s.sleepIntervals);
                    w.count++;
                });
                Object.keys(result).forEach(function (k) {
                    result[k].milk = Math.round(result[k].milk / result[k].count);
                    result[k].milkMin = Math.round(result[k].milkMin / result[k].count);
                    result[k].formula = Math.round(result[k].formula / result[k].count);
                    result[k].formulaMl = Math.round(result[k].formulaMl / result[k].count);
                    result[k].sleep = Math.round((result[k].sleep / result[k].count) * 10) / 10;
                    result[k].sleepCnt = Math.round(result[k].sleepCnt / result[k].count);
                    result[k].food = Math.round(result[k].food / result[k].count);
                    result[k].poop = Math.round(result[k].poop / result[k].count);
                    result[k].dayFeed = Math.round(result[k].dayFeed / result[k].count);
                    result[k].nightFeed = Math.round(result[k].nightFeed / result[k].count);
                    result[k].dayMilk = Math.round(result[k].dayMilk / result[k].count);
                    result[k].nightMilk = Math.round(result[k].nightMilk / result[k].count);
                    result[k].dayFormula = Math.round(result[k].dayFormula / result[k].count);
                    result[k].nightFormula = Math.round(result[k].nightFormula / result[k].count);
                    result[k].daySleep = Math.round((result[k].daySleep / result[k].count) * 10) / 10;
                    result[k].nightSleep = Math.round((result[k].nightSleep / result[k].count) * 10) / 10;
                });
                return result;
            } else if (dimension === 'month') {
                data.dates.forEach(function (d) {
                    var fullDate = data.data[d].fullDate;
                    var monthKey = fullDate.substring(0, 7);
                    if (!result[monthKey]) {
                        result[monthKey] = {
                            fullDate: monthKey,
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            food: 0, poop: 0,
                            dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                            dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                            feedIntervals: [], sleepIntervals: [], count: 0
                        };
                    }
                    var m = result[monthKey];
                    var s = data.data[d];
                    m.milk += s.milk;
                    m.milkMin += s.milkMin;
                    m.formula += s.formula;
                    m.formulaMl += s.formulaMl;
                    m.sleep += s.sleep;
                    m.sleepCnt += s.sleepCnt;
                    if (parseFloat(s.maxSleep) > parseFloat(m.maxSleep)) m.maxSleep = s.maxSleep;
                    m.food += s.food;
                    m.poop += s.poop;
                    m.dayFeed += s.dayFeed;
                    m.nightFeed += s.nightFeed;
                    m.dayMilk += s.dayMilk;
                    m.nightMilk += s.nightMilk;
                    m.dayFormula += s.dayFormula;
                    m.nightFormula += s.nightFormula;
                    m.daySleep += s.daySleep;
                    m.nightSleep += s.nightSleep;
                    if (s.weight) m.weight = s.weight;
                    m.feedIntervals = m.feedIntervals.concat(s.feedIntervals);
                    m.sleepIntervals = m.sleepIntervals.concat(s.sleepIntervals);
                    m.count++;
                });
                Object.keys(result).forEach(function (k) {
                    result[k].milk = Math.round(result[k].milk / result[k].count);
                    result[k].milkMin = Math.round(result[k].milkMin / result[k].count);
                    result[k].formula = Math.round(result[k].formula / result[k].count);
                    result[k].formulaMl = Math.round(result[k].formulaMl / result[k].count);
                    result[k].sleep = Math.round((result[k].sleep / result[k].count) * 10) / 10;
                    result[k].sleepCnt = Math.round(result[k].sleepCnt / result[k].count);
                    result[k].food = Math.round(result[k].food / result[k].count);
                    result[k].poop = Math.round(result[k].poop / result[k].count);
                    result[k].dayFeed = Math.round(result[k].dayFeed / result[k].count);
                    result[k].nightFeed = Math.round(result[k].nightFeed / result[k].count);
                    result[k].dayMilk = Math.round(result[k].dayMilk / result[k].count);
                    result[k].nightMilk = Math.round(result[k].nightMilk / result[k].count);
                    result[k].dayFormula = Math.round(result[k].dayFormula / result[k].count);
                    result[k].nightFormula = Math.round(result[k].nightFormula / result[k].count);
                    result[k].daySleep = Math.round((result[k].daySleep / result[k].count) * 10) / 10;
                    result[k].nightSleep = Math.round((result[k].nightSleep / result[k].count) * 10) / 10;
                });
                return result;
            }
        }

        function renderChart(chartType, dimension) {
            // ÈáçÁΩÆÂΩìÂâçÂõæË°®ÁöÑÊªöÂä®Áä∂ÊÄÅ
            chartScroll[chartType].offset = 0;
            
            if (chartType === 'feedCount') renderFeedCountChart(dimension);
            else if (chartType === 'feedAmount') renderFeedAmountChart(dimension);
            else if (chartType === 'sleepDuration') renderSleepDurationChart(dimension);
            else if (chartType === 'sleepInterval') renderSleepIntervalChart(dimension);
            else if (chartType === 'feedInterval') renderFeedIntervalChart(dimension);
            else if (chartType === 'weight') renderWeightChart(dimension);
            else if (chartType === 'poop') renderPoopChart(dimension);
            
            // ÈáçÁΩÆÊªëÂä®‰ΩçÁΩÆÂà∞ÊúÄÊñ∞Êï∞ÊçÆÔºàÊúÄÂè≥ËæπÔºâ
            setTimeout(function() {
                var canvas = document.getElementById(chartType + 'Chart');
                if (!canvas) return;
                var wrapper = canvas.closest('.chart-slide-wrapper');
                var inner = wrapper ? wrapper.querySelector('.chart-slide-inner') : null;
                if (inner && wrapper) {
                    // ËÆ°ÁÆóÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆÁöÑ‰ΩçÁΩÆ
                    var totalW = inner.offsetWidth;
                    var wrapperW = wrapper.clientWidth;
                    if (totalW > wrapperW) {
                        inner.style.transform = 'translateX(' + (wrapperW - totalW) + 'px)';
                    } else {
                        inner.style.transform = 'translateX(0)';
                    }
                }
            }, 50); // Á≠âÂæÖensureChartWidthÂÆåÊàê
        }
        
        // ÂõæË°®ÊªöÂä®ËæÖÂä©ÂáΩÊï∞ÔºàÊõø‰ª£ÂàÜÈ°µÔºâ
        

        
        // ‰∏∫Âçï‰∏™ÂõæË°®ÁªëÂÆöÊªëÂä®‰∫ã‰ª∂
        var chartEventHandlers = {}; // Â≠òÂÇ®‰∫ã‰ª∂Â§ÑÁêÜÂô®
        
        
// Á°Æ‰øùÂõæË°®canvasÂÆΩÂ∫¶Ë∂≥Â§üÊòæÁ§∫ÊâÄÊúâÊï∞ÊçÆ
function ensureChartWidth(chartType) {
    var canvas = document.getElementById(chartType + 'Chart');
    if (!canvas) return;
    
    var wrapper = canvas.closest('.chart-slide-wrapper');
    var inner = wrapper ? wrapper.querySelector('.chart-slide-inner') : null;
    if (!wrapper || !inner) return;

    var totalItems = chartScroll[chartType] ? chartScroll[chartType].totalItems : 0;
    var perDayWidth = 70; // ÊØèÂ§©Âç†Áî®ÁöÑÂÉèÁ¥†ÂÆΩÂ∫¶
    var totalWidth = Math.max(totalItems * perDayWidth, wrapper.clientWidth);

    inner.style.width = totalWidth + 'px';
    canvas.style.width = totalWidth + 'px';
    
    // ÂàùÂßã‰ΩçÁΩÆÔºöÊòæÁ§∫ÊúÄÊñ∞Êï∞ÊçÆÔºàÊúÄÂè≥ËæπÔºâ
    var wrapperW = wrapper.clientWidth;
    if (totalWidth > wrapperW) {
        // Â∞ÜcanvasÂêëÂ∑¶ÁßªÂä®ÔºåËÆ©ÊúÄÂè≥ËæπÔºàÊúÄÊñ∞Êï∞ÊçÆÔºâÊòæÁ§∫Âá∫Êù•
        inner.style.transform = 'translateX(' + (wrapperW - totalWidth) + 'px)';
    } else {
        // Â¶ÇÊûúÊÄªÂÆΩÂ∫¶Â∞è‰∫éÁ≠â‰∫éËßÜÂè£ÂÆΩÂ∫¶Ôºå‰∏çÈúÄË¶ÅÁßªÂä®
        inner.style.transform = 'translateX(0)';
    }
}

// ‰∏∫ÂõæË°®ÁªëÂÆöÂπ≥ÊªëÊªëÂä®ÂäüËÉΩÔºàÂ∏¶ÊÉØÊÄßÔºâ
function bindSwipeToChart(chartType) {
    var canvas = document.getElementById(chartType + 'Chart');
    if (!canvas) return;
    
    var wrapper = canvas.closest('.chart-slide-wrapper');
    var inner = wrapper ? wrapper.querySelector('.chart-slide-inner') : null;
    if (!wrapper || !inner) return;

    ensureChartWidth(chartType);

    var isDown = false;
    var startX = 0;
    var startTranslate = 0;
    var lastX = 0;
    var lastTime = 0;
    var velocityX = 0;
    var momentumAnimation = null;

    function getTranslate() {
        var t = inner.style.transform;
        if (!t) return 0;
        var m = /translateX\(([-0-9.]+)px\)/.exec(t);
        return m ? parseFloat(m[1]) : 0;
    }

    function clamp(x) {
        var wrapperW = wrapper.clientWidth;
        var totalW = inner.offsetWidth;
        var minX = Math.min(0, wrapperW - totalW); // ÊúÄÂ∑¶ËæπÔºàÊúÄÊóßÁöÑÊï∞ÊçÆÔºâ
        if (x < minX) x = minX;
        if (x > 0) x = 0; // ÊúÄÂè≥ËæπÔºàÊúÄÊñ∞ÁöÑÊï∞ÊçÆÔºâ
        return x;
    }

    function setTranslate(x, withTransition) {
        x = clamp(x);
        if (withTransition) {
            inner.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        } else {
            inner.style.transition = 'none';
        }
        inner.style.transform = 'translateX(' + x + 'px)';
    }

    // ÂÅúÊ≠¢ÊÉØÊÄßÂä®Áîª
    function stopMomentum() {
        if (momentumAnimation) {
            cancelAnimationFrame(momentumAnimation);
            momentumAnimation = null;
        }
    }

    // ÊÉØÊÄßÊªëÂä®Âä®Áîª
    function momentum() {
        if (Math.abs(velocityX) < 0.5) {
            // ÈÄüÂ∫¶Â§™Â∞èÔºåÂÅúÊ≠¢
            stopMomentum();
            return;
        }

        var currentX = getTranslate();
        var newX = currentX + velocityX;
        
        // Ê£ÄÊü•ËæπÁïå
        var wrapperW = wrapper.clientWidth;
        var totalW = inner.offsetWidth;
        var minX = Math.min(0, wrapperW - totalW);
        var maxX = 0;
        
        // ËæπÁïåÂºπÊÄßÊïàÊûú
        if (newX > maxX) {
            newX = maxX;
            velocityX = 0;
        } else if (newX < minX) {
            newX = minX;
            velocityX = 0;
        }
        
        setTranslate(newX, false);
        
        // ÂáèÈÄü - ‰ΩøÁî®Êë©Êì¶Á≥ªÊï∞
        velocityX *= 0.95;
        
        // ÁªßÁª≠Âä®Áîª
        if (Math.abs(velocityX) >= 0.5) {
            momentumAnimation = requestAnimationFrame(momentum);
        } else {
            stopMomentum();
        }
    }

    wrapper.onpointerdown = function (e) {
        // ÂÅúÊ≠¢‰ªª‰ΩïËøõË°å‰∏≠ÁöÑÊÉØÊÄßÂä®Áîª
        stopMomentum();
        velocityX = 0;
        
        isDown = true;
        startX = e.clientX;
        lastX = e.clientX;
        lastTime = Date.now();
        startTranslate = getTranslate();
        wrapper.setPointerCapture(e.pointerId);
        canvas.style.cursor = 'grabbing';
    };

    wrapper.onpointermove = function (e) {
        if (!isDown) return;
        
        var currentTime = Date.now();
        var currentX = e.clientX;
        var dx = currentX - startX;
        
        // ËÆ°ÁÆóÈÄüÂ∫¶ÔºàÁî®‰∫éÊÉØÊÄßÔºâ
        var dt = currentTime - lastTime;
        if (dt > 0) {
            velocityX = (currentX - lastX) / dt * 16; // ÂΩí‰∏ÄÂåñÂà∞60fps
        }
        
        lastX = currentX;
        lastTime = currentTime;
        
        setTranslate(startTranslate + dx, false);
    };

    wrapper.onpointerup = wrapper.onpointercancel = function (e) {
        if (!isDown) return;
        
        isDown = false;
        canvas.style.cursor = 'grab';
        
        if (e.pointerId) {
            try { wrapper.releasePointerCapture(e.pointerId); } catch (_) {}
        }
        
        // ÂêØÂä®ÊÉØÊÄßÊªëÂä®
        if (Math.abs(velocityX) > 1) {
            // ÈôêÂà∂ÊúÄÂ§ßÈÄüÂ∫¶
            var maxVelocity = 50;
            if (velocityX > maxVelocity) velocityX = maxVelocity;
            if (velocityX < -maxVelocity) velocityX = -maxVelocity;
            
            momentum();
        }
    };

    window.addEventListener('resize', function () {
        stopMomentum();
        ensureChartWidth(chartType);
        var cur = getTranslate();
        setTranslate(cur, false);
    });
}

        
        // ÂàùÂßãÂåñËß¶Êë∏ÊªëÂä®ÊîØÊåÅ
        function initChartSwipe() {
            var chartTypes = ['feedCount', 'feedAmount', 'sleepDuration', 'sleepInterval', 'feedInterval', 'weight', 'poop'];
            chartTypes.forEach(function(chartType) {
                bindSwipeToChart(chartType);
            });
        }

        // 1. ÂñÇÂ•∂Ê¨°Êï∞ÔºàÁôΩÂ§©/Â§úÈó¥ÔºåÂå∫ÂàÜÊØç‰π≥ÂíåÂ•∂Á≤âÔºâ
        function renderFeedCountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Êï∞ÊçÆÈ™åËØÅ
            if (!allLabels || allLabels.length === 0) {
                console.log('renderFeedCountChart: Ê≤°ÊúâÊï∞ÊçÆ');
                return;
            }
            
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.feedCount) {
                chartScroll.feedCount = {};
            }
            chartScroll.feedCount.totalItems = allLabels.length;
            
            // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆÔºå‰∏çÂàáÁâá
            var labels = allLabels;
            
            if (charts.feedCount) charts.feedCount.destroy();
            charts.feedCount = new Chart(document.getElementById('feedCountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©ÊØç‰π≥(Ê¨°)', data: labels.map(function(d) { return aggregated[d].dayMilk; }), backgroundColor: COLORS.DAY_DARK, stack: 'day' },
                        { label: 'ÁôΩÂ§©Â•∂Á≤â(Ê¨°)', data: labels.map(function(d) { return aggregated[d].dayFormula; }), backgroundColor: COLORS.DAY_LIGHT, stack: 'day' },
                        { label: 'Â§úÈó¥ÊØç‰π≥(Ê¨°)', data: labels.map(function(d) { return aggregated[d].nightMilk; }), backgroundColor: COLORS.NIGHT_DARK, stack: 'night' },
                        { label: 'Â§úÈó¥Â•∂Á≤â(Ê¨°)', data: labels.map(function(d) { return aggregated[d].nightFormula; }), backgroundColor: COLORS.NIGHT_LIGHT, stack: 'night' }
                    ]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false, // Êîπ‰∏∫false‰ª•ÈÄÇÂ∫îÂä®ÊÄÅÂÆΩÂ∫¶
                    interaction: {
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false }, // Á¶ÅÁî®CanvasÂõæ‰æã
                        htmlLegend: {
                            containerID: 'feedCountChartLegend' // ‰ΩøÁî®HTMLÂõæ‰æã
                        },
                        tooltip: { enabled: true }
                    },
                    scales: { 
                        y: { display: false },
                        x: { stacked: true }
                    } 
                },
                plugins: [htmlLegendPlugin]
            });
            
            // Á°Æ‰øùcanvasÂÆΩÂ∫¶Ê≠£Á°ÆÔºåÁÑ∂ÂêéÁªëÂÆöÊªëÂä®‰∫ã‰ª∂
            ensureChartWidth('feedCount');
            bindSwipeToChart('feedCount');
        }

        // 2. ÊØèÊó•ÂñÇÂ•∂ÈáèÔºàÊØç‰π≥ÂíåÂ•∂Á≤âÔºâ
        function renderFeedAmountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.feedAmount) chartScroll.feedAmount = {};
            chartScroll.feedAmount.totalItems = allLabels.length;
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            if (charts.feedAmount) charts.feedAmount.destroy();
            charts.feedAmount = new Chart(document.getElementById('feedAmountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'Â•∂Á≤â(ml)', data: labels.map(function(d) { return aggregated[d].formulaMl; }), backgroundColor: 'rgba(255,206,86,0.8)' },
                        { label: 'ÊØç‰π≥(min)', data: labels.map(function(d) { return aggregated[d].milkMin; }), backgroundColor: 'rgba(153,102,255,0.8)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        htmlLegend: { containerID: 'feedAmountChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: { display: false }
                    }
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('feedAmount');
            bindSwipeToChart('feedAmount');
        }

        // 3. Áù°Áú†Êó∂ÈïøÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderSleepDurationChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.sleepDuration) chartScroll.sleepDuration = {};
            chartScroll.sleepDuration.totalItems = allLabels.length;
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            if (charts.sleepDuration) charts.sleepDuration.destroy();
            charts.sleepDuration = new Chart(document.getElementById('sleepDurationChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©(h)', data: labels.map(function(d) { return aggregated[d].daySleep; }), backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥(h)', data: labels.map(function(d) { return aggregated[d].nightSleep; }), backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, htmlLegend: { containerID: 'sleepDurationChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: { 
                        y: { display: false },
                        x: { stacked: true }
                    } 
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('sleepDuration');
            bindSwipeToChart('sleepDuration');
        }

        // 4. Áù°Áú†Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderSleepIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.sleepInterval) chartScroll.sleepInterval = {};
            chartScroll.sleepInterval.totalItems = allLabels.length;
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            var dayIntervals = labels.map(function(d) {
                var intervals = aggregated[d].sleepIntervals.filter(function(i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function(d) {
                var intervals = aggregated[d].sleepIntervals.filter(function(i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            
            if (charts.sleepInterval) charts.sleepInterval.destroy();
            charts.sleepInterval = new Chart(document.getElementById('sleepIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©Èó¥Èöî(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥Èó¥Èöî(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, htmlLegend: { containerID: 'sleepIntervalChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: { y: { display: false } }
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('sleepInterval');
            bindSwipeToChart('sleepInterval');
        }

        // 5. ÂñÇÂ•∂Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderFeedIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.feedInterval) chartScroll.feedInterval = {};
            chartScroll.feedInterval.totalItems = allLabels.length;
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            var dayIntervals = labels.map(function(d) {
                var intervals = aggregated[d].feedIntervals.filter(function(i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function(d) {
                var intervals = aggregated[d].feedIntervals.filter(function(i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            
            if (charts.feedInterval) charts.feedInterval.destroy();
            charts.feedInterval = new Chart(document.getElementById('feedIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©Èó¥Èöî(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥Èó¥Èöî(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, htmlLegend: { containerID: 'feedIntervalChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: { y: { display: false } }
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('feedInterval');
            bindSwipeToChart('feedInterval');
        }

        // 6. ‰ΩìÈáçÂèòÂåñ
        // 6. ‰ΩìÈáçÂèòÂåñ
        function renderWeightChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.weight) chartScroll.weight = {};
            chartScroll.weight.totalItems = allLabels.length;
            
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            if (charts.weight) charts.weight.destroy();
            charts.weight = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ 
                        label: '‰ΩìÈáç(kg)', 
                        data: labels.map(function(d) { return aggregated[d].weight; }), 
                        borderColor: 'rgba(75,192,192,1)', 
                        backgroundColor: 'rgba(75,192,192,0.1)',
                        tension: 0.4, 
                        spanGaps: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, htmlLegend: { containerID: 'weightChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            display: true,
                            ticks: {
                                count: 3,
                                font: { size: 10 },
                                color: 'rgba(255,255,255,0.7)'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)',
                                drawBorder: false
                            }
                        }
                    }
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('weight');
            bindSwipeToChart('weight');
        }

        // 7. Â§ß‰æøÊ¨°Êï∞
        function renderPoopChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var allLabels = Object.keys(aggregated).sort();
            
            // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
            // Â≠òÂÇ®Êï∞ÊçÆÊÄªÈáè
            if (!chartScroll.poop) chartScroll.poop = {};
            chartScroll.poop.totalItems = allLabels.length;
            
            var labels = allLabels; // Áõ¥Êé•‰ΩøÁî®ÊâÄÊúâÊï∞ÊçÆ
            
            if (charts.poop) charts.poop.destroy();
            charts.poop = new Chart(document.getElementById('poopChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ label: 'Â§ß‰æø(Ê¨°)', data: labels.map(function(d) { return aggregated[d].poop; }), backgroundColor: 'rgba(139,69,19,0.6)' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, htmlLegend: { containerID: 'poopChartLegend' },
                        tooltip: { enabled: true }
                    },
                    scales: { y: { display: false } }
                },
                plugins: [htmlLegendPlugin]
            });
            
            ensureChartWidth('poop');
            bindSwipeToChart('poop');
        }

        function changeTimeDimension(btn, chartType, dimension) {
            var parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderChart(chartType, dimension);
        }

        function renderToday(td, latest, foods) {
            if (!td) return;
            
            // Ê∏ÖÁ©∫‰πãÂâçÁöÑËÆ∞ÂΩïÊï∞ÊçÆÔºàÈò≤Ê≠¢ÈáçÂ§çÔºâ
            var latestRecords = document.querySelectorAll('.latest-record');
            latestRecords.forEach(function(el) { el.remove(); });
            
            var now = new Date();
            document.getElementById('todayDate').textContent = '(' + (now.getMonth() + 1) + '/' + now.getDate() + ')';
            document.getElementById('todayFeedCount').textContent = td.milk + td.formula;
            document.getElementById('todayFormula').textContent = Math.round(td.formulaMl);
            document.getElementById('todayBreast').textContent = Math.round(td.milkMin);
            document.getElementById('todaySleepCount').textContent = td.sleep.length;
            document.getElementById('todaySleepTotal').textContent = td.sleepTotal.toFixed(1);
            document.getElementById('todaySleepMax').textContent = td.maxSleep.toFixed(1);
            document.getElementById('todayDayFeed').textContent = td.dayFeed;
            document.getElementById('todayDaySleep').textContent = td.daySleep.toFixed(1);
            document.getElementById('todayNightFeed').textContent = td.nightFeed;
            document.getElementById('todayNightSleep').textContent = td.nightSleep.toFixed(1);

            if (latest.milk) document.getElementById('feedCard').innerHTML += '<div class="latest-record">üçº ÊØç‰π≥ ' + latest.milk.t.substring(0, 5) + ' (' + latest.milk.v + 'ÂàÜÈíü)</div>';
            if (latest.formula) document.getElementById('feedCard').innerHTML += '<div class="latest-record">üçº Â•∂Á≤â ' + latest.formula.t.substring(0, 5) + ' (' + latest.formula.v + 'ml)</div>';
            if (latest.sleep) document.getElementById('sleepCard').innerHTML += '<div class="latest-record">üí§ ' + latest.sleep.t.substring(0, 5) + ' ÈÜíÊù• (Áù°‰∫Ü' + latest.sleep.h + 'h)</div>';

            if (td.weight) {
                document.getElementById('weightCard').style.display = 'block';
                document.getElementById('todayWeight').textContent = td.weight;
                document.getElementById('todayOther').style.display = 'grid';
            }
            if (td.food > 0) {
                document.getElementById('foodCard').style.display = 'block';
                document.getElementById('todayFood').textContent = td.food;
                document.getElementById('todayOther').style.display = 'grid';
                if (foods && foods.length > 0) {
                    var foodContent = document.getElementById('foodCard');
                    foods.forEach(function(food) {
                        foodContent.innerHTML += '<div class="latest-record">ü•Ñ ' + food.t.substring(0, 5) + ' ' + food.desc + '</div>';
                    });
                }
            }
            if (td.poop > 0) {
                document.getElementById('poopCard').style.display = 'block';
                document.getElementById('todayPoop').textContent = td.poop;
                document.getElementById('todayOther').style.display = 'grid';
            }
        }

        function renderYesterday(yd) {
            if (!yd) return;
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('yesterdayDate').textContent = '(' + (yesterday.getMonth() + 1) + '/' + yesterday.getDate() + ')';
            document.getElementById('yesterdayFeedCount').textContent = yd.milk + yd.formula;
            document.getElementById('yesterdayFormula').textContent = Math.round(yd.formulaMl);
            document.getElementById('yesterdayBreast').textContent = Math.round(yd.milkMin);
            document.getElementById('yesterdaySleepCount').textContent = yd.sleepCnt;
            document.getElementById('yesterdaySleepTotal').textContent = yd.sleep.toFixed(1);
            document.getElementById('yesterdaySleepMax').textContent = yd.maxSleep;
            document.getElementById('yesterdayDayFeed').textContent = yd.dayFeed;
            document.getElementById('yesterdayDaySleep').textContent = yd.daySleep.toFixed(1);
            document.getElementById('yesterdayNightFeed').textContent = yd.nightFeed;
            document.getElementById('yesterdayNightSleep').textContent = yd.nightSleep.toFixed(1);
        }

        function renderCharts(analyzed) {
            console.log('renderCharts called', analyzed);
            var data = analyzed.data;
            var dates = analyzed.dates;
            if (dates.length === 0) {
                console.log('No dates found');
                return;
            }
            
            console.log('Dates length:', dates.length);

            document.getElementById('dataContainer').style.display = 'block';
            document.getElementById('fileContainer').style.display = 'none';

            renderToday(analyzed.today, analyzed.latest, analyzed.foods);
            renderYesterday(analyzed.yesterday);

            var totalS = dates.reduce(function (s, d) { return s + data[d].sleep; }, 0);
            var totalF = dates.reduce(function (s, d) { return s + data[d].formulaMl; }, 0);
            var totalM = dates.reduce(function (s, d) { return s + data[d].milkMin; }, 0);
            var totalFeedGaps = [];
            var totalSleepGaps = [];
            dates.forEach(function(d) {
                totalFeedGaps = totalFeedGaps.concat(data[d].feedIntervals);
                totalSleepGaps = totalSleepGaps.concat(data[d].sleepIntervals);
            });

            document.getElementById('avgSleep').textContent = (totalS / dates.length).toFixed(1);
            document.getElementById('avgFormula').textContent = Math.round(totalF / dates.length);
            document.getElementById('avgBreast').textContent = Math.round(totalM / dates.length);
            document.getElementById('currentWeight').textContent = analyzed.weight || '-';
            var avgFeedVal = totalFeedGaps.length > 0 ? (totalFeedGaps.reduce(function(a,b){return a+b.value}, 0)/totalFeedGaps.length).toFixed(1) : '-';
            var avgSleepVal = totalSleepGaps.length > 0 ? (totalSleepGaps.reduce(function(a,b){return a+b.value}, 0)/totalSleepGaps.length).toFixed(1) : '-';
            document.getElementById('avgFeedInterval').textContent = avgFeedVal;
            document.getElementById('avgSleepInterval').textContent = avgSleepVal;

            Chart.defaults.font.size = 12;

            renderChart('feedCount', 'day');
            renderChart('feedAmount', 'day');
            renderChart('sleepDuration', 'day');
            renderChart('sleepInterval', 'day');
            renderChart('feedInterval', 'day');
            renderChart('weight', 'day');
            renderChart('poop', 'day');

            document.getElementById('status').textContent = '‚úÖ Âä†ËΩΩÊàêÂäüÔºÅÂÖ± ' + dates.length + ' Â§©Êï∞ÊçÆ';
            
            // ÂàùÂßãÂåñËß¶Êë∏ÊªëÂä®ÊîØÊåÅ
            initChartSwipe();
        }

        document.getElementById('csvFile').addEventListener('change', function (e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                var csv = parseCSV(ev.target.result);
                if (csv.length > 0) {
                    allAnalyzedData = analyzeData(csv);
                    renderCharts(allAnalyzedData);
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        document.getElementById('birthDate').addEventListener('change', calculateAndDisplayAge);

        window.addEventListener('load', function () {
            initializeSettings();
            fetch('./baby_log.csv', { cache: 'no-cache' })
                .then(function (r) { return r.text(); })
                .then(function (text) {
                    var csv = parseCSV(text);
                    if (csv.length > 0) {
                        // ‰øùÂ≠òÂéüÂßãÊï∞ÊçÆÂà∞localStorage‰æõ‰∫ã‰ª∂ËßÜÂõæ‰ΩøÁî®
                        try {
                            localStorage.setItem('baby_all_raw_rows', JSON.stringify(csv));
                        } catch (e) {
                            console.warn('Êó†Ê≥ï‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage', e);
                        }
                        
                        allAnalyzedData = analyzeData(csv);
                        renderCharts(allAnalyzedData);
                    }
                })
                .catch(function () {
                    document.getElementById('status').textContent = 'Á≠âÂæÖ‰∏ä‰º†CSVÊñá‰ª∂';
                });
        });
    </script>

    <!-- ‰æßËæπ AI Chat Ê∞îÊ≥°Ôºà‰øùÁïôÂπ∂ÁªëÂÆöÂà∞ openChatPanelÔºâ -->
    <div class="ai-chat-bubble" id="aiChatBubble" title="AIÂä©Êâã">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
    </div>

    <script>
        // ========== ËßÜÂõæÂàáÊç¢ÂäüËÉΩ ==========
        function switchView(viewName) {
            var analysisView = document.getElementById('dataContainer');
            var eventView = document.getElementById('eventView');
            var navItems = document.querySelectorAll('.nav-item');
            var babyAge = document.getElementById('babyAge');
            var fileContainer = document.getElementById('fileContainer');
            
            if (viewName === 'event') {
                analysisView.style.display = 'none';
                eventView.style.display = 'flex';
                navItems[0].classList.add('active');
                navItems[1].classList.remove('active');
                
                // Ê∑ªÂä†‰∫ã‰ª∂ËßÜÂõæÊ†áËØÜclass
                document.body.classList.add('event-view-active');
                if (fileContainer) fileContainer.style.display = 'none';
                
                // ÂàùÂßãÂåñ‰∫ã‰ª∂ËßÜÂõæ
                initEventView();
            } else {
                analysisView.style.display = 'block';
                eventView.style.display = 'none';
                navItems[0].classList.remove('active');
                navItems[1].classList.add('active');
                
                // ÁßªÈô§‰∫ã‰ª∂ËßÜÂõæÊ†áËØÜclass
                document.body.classList.remove('event-view-active');
                if (fileContainer) fileContainer.style.display = 'block';
            }
        }

        // ========== ‰∫ã‰ª∂ËßÜÂõæÁõ∏ÂÖ≥ÂèòÈáè ==========
        var eventAllData = [];
        var eventProcessedEvents = [];
        var eventTypeFilters = {
            'sleep': true,
            'feed-milk': true,
            'feed-formula': true,
            'food': true,
            'poop': true,
            'weight': true
        };

        // ========== ‰∫ã‰ª∂ËßÜÂõæÂàùÂßãÂåñ ==========
        function initEventView() {
            // ‰ªélocalStorageËØªÂèñÊï∞ÊçÆ
            try {
                var stored = localStorage.getItem('baby_all_raw_rows');
                if (stored) {
                    var parsed = JSON.parse(stored);
                    if (parsed && parsed.length > 0) {
                        eventAllData = parsed;
                        eventProcessedEvents = processEventsForGantt(eventAllData);
                        if (eventProcessedEvents.length > 0) {
                            renderEventHeader(false);
                            renderAllEventData();
                        }
                    }
                }
            } catch (err) {
                console.warn('ËØªÂèñ‰∫ã‰ª∂Êï∞ÊçÆÂ§±Ë¥•', err);
            }
        }

        // Ê∏≤ÊüìÊâÄÊúâ‰∫ã‰ª∂Êï∞ÊçÆ
        function renderAllEventData() {
            if (eventProcessedEvents.length === 0) return;
            
            // Ëé∑ÂèñÊâÄÊúâÊó•Êúü
            var allDates = {};
            eventProcessedEvents.forEach(function(evt) {
                allDates[evt.date] = true;
            });
            
            var dateList = Object.keys(allDates).sort();
            if (dateList.length === 0) return;
            
            // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂíåÊúÄÂêé‰∏Ä‰∏™Êó•Êúü‰Ωú‰∏∫ËåÉÂõ¥
            var startDate = new Date(dateList[0] + 'T00:00:00');
            var endDate = new Date(dateList[dateList.length - 1] + 'T00:00:00');
            
            renderEventGantt(startDate, endDate);
        }

        // ========== ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞ ==========
        function processEventsForGantt(data) {
            var events = [];
            var sleepPairs = {};
            
            data.forEach(function(row) {
                if (!row || !row.timestamp) return;
                
                var date = new Date(row.timestamp);
                var rawDateStr = row.timestamp.split(' ')[0];
                var dateParts = rawDateStr.split('-');
                var dateStr;
                if (dateParts.length === 3) {
                    var year = dateParts[0];
                    var month = dateParts[1].padStart(2, '0');
                    var day = dateParts[2].padStart(2, '0');
                    dateStr = year + '-' + month + '-' + day;
                } else {
                    dateStr = rawDateStr;
                }
                
                var hour = date.getHours();
                var minute = date.getMinutes();
                var timeInMinutes = hour * 60 + minute;
                
                if (row.event_type === 'Áù°Ëßâ') {
                    if (row.subtype === 'ÂºÄÂßã') {
                        var key = row.pair_key || row.timestamp;
                        sleepPairs[key] = {
                            date: dateStr,
                            startTime: timeInMinutes,
                            startTimestamp: row.timestamp,
                            who: row.who
                        };
                    } else if (row.subtype === 'ÁªìÊùü' && row.pair_key) {
                        var startEvent = sleepPairs[row.pair_key];
                        if (startEvent) {
                            var endTimeInMinutes = timeInMinutes;
                            
                            if (dateStr !== startEvent.date) {
                                events.push({
                                    date: startEvent.date,
                                    type: 'sleep',
                                    startTime: startEvent.startTime,
                                    endTime: 24 * 60,
                                    duration: 24 * 60 - startEvent.startTime,
                                    text: 'üò¥ Áù°Ëßâ',
                                    tooltip: startEvent.startTimestamp + ' ÂºÄÂßã',
                                    who: startEvent.who
                                });
                                
                                events.push({
                                    date: dateStr,
                                    type: 'sleep',
                                    startTime: 0,
                                    endTime: endTimeInMinutes,
                                    duration: endTimeInMinutes,
                                    text: 'üò¥ Áù°Ëßâ',
                                    tooltip: row.timestamp + ' ÈÜíÊù•',
                                    who: row.who
                                });
                            } else {
                                events.push({
                                    date: dateStr,
                                    type: 'sleep',
                                    startTime: startEvent.startTime,
                                    endTime: endTimeInMinutes,
                                    duration: endTimeInMinutes - startEvent.startTime,
                                    text: 'üò¥ Áù°Ëßâ ' + formatEventDuration(endTimeInMinutes - startEvent.startTime),
                                    tooltip: startEvent.startTimestamp + ' - ' + row.timestamp,
                                    who: startEvent.who
                                });
                            }
                            
                            delete sleepPairs[row.pair_key];
                        }
                    }
                } else if (row.event_type === 'ÂñÇÂ•∂') {
                    var eventText = '';
                    var eventType = '';
                    var val = parseFloat(row.value) || 0;
                    
                    if (row.subtype === 'ÊØç‰π≥') {
                        eventText = 'ü§± ÊØç‰π≥';
                        if (val > 0) eventText += ' ' + val + row.unit;
                        eventType = 'feed-milk';
                    } else if (row.subtype === 'Â•∂Á≤â') {
                        eventText = 'üçº Â•∂Á≤â';
                        if (val > 0) eventText += ' ' + val + row.unit;
                        eventType = 'feed-formula';
                    }
                    
                    events.push({
                        date: dateStr,
                        type: eventType,
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: eventText,
                        tooltip: row.timestamp + (row.notes ? '\n' + row.notes : ''),
                        who: row.who
                    });
                } else if (row.event_type === 'ËæÖÈ£ü') {
                    var val = parseFloat(row.value) || 0;
                    var foodText = 'ü•Ñ ' + (row.subtype || 'ËæÖÈ£ü');
                    if (val > 0) foodText += ' ' + val + row.unit;
                    
                    events.push({
                        date: dateStr,
                        type: 'food',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: foodText,
                        tooltip: row.timestamp + '\n' + (row.notes || row.subtype || ''),
                        who: row.who
                    });
                } else if (row.event_type === 'Êç¢Â∞øÂ∏É') {
                    events.push({
                        date: dateStr,
                        type: 'poop',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: 'üí© ' + row.subtype,
                        tooltip: row.timestamp,
                        who: row.who
                    });
                } else if (row.event_type === '‰ΩìÈáç') {
                    var val = parseFloat(row.value) || 0;
                    events.push({
                        date: dateStr,
                        type: 'weight',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: '‚öñÔ∏è ' + val + row.unit,
                        tooltip: row.timestamp,
                        who: row.who
                    });
                }
            });
            
            return events;
        }

        function formatEventDuration(minutes) {
            if (minutes < 60) {
                return minutes + 'ÂàÜ';
            }
            var hours = Math.floor(minutes / 60);
            var mins = minutes % 60;
            if (mins === 0) {
                return hours + 'Â∞èÊó∂';
            }
            return hours + 'Â∞èÊó∂' + mins + 'ÂàÜ';
        }

        function formatEventDate(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        function getEventWeekday(date) {
            var days = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            return days[date.getDay()];
        }

        function generateEventDateRange(startDate, endDate) {
            var dates = [];
            var current = new Date(startDate);
            var end = new Date(endDate);
            
            while (current <= end) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        function renderEventHeader(markCurrentTime) {
            var headerHours = document.getElementById('ganttHeaderHours');
            if (!headerHours) return;
            
            headerHours.innerHTML = '';
            var now = new Date();
            var currentHour = now.getHours();
            
            for (var hour = 0; hour < 24; hour++) {
                var cell = document.createElement('div');
                cell.className = 'gantt-hour-cell';
                
                if (markCurrentTime) {
                    if (hour === currentHour) {
                        cell.classList.add('current-hour');
                    }
                    if (hour > currentHour) {
                        cell.classList.add('future-hour');
                    }
                }
                
                cell.textContent = hour + ':00';
                headerHours.appendChild(cell);
            }
        }

        function renderEventGantt(startDate, endDate) {
            var datesBody = document.getElementById('ganttDatesBody');
            var ganttContent = document.getElementById('ganttContent');
            
            if (!datesBody || !ganttContent) return;
            
            datesBody.innerHTML = '';
            ganttContent.innerHTML = '';
            
            var dates = generateEventDateRange(startDate, endDate);
            dates.reverse();
            
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var todayStr = formatEventDate(today);
            
            var includesToday = dates.some(function(date) {
                return formatEventDate(date) === todayStr;
            });
            
            renderEventHeader(includesToday);
            
            dates.forEach(function(date) {
                var dateStr = formatEventDate(date);
                var isToday = dateStr === todayStr;
                
                var dateLabel = document.createElement('div');
                dateLabel.className = 'gantt-date-label' + (isToday ? ' today' : '');
                
                var dateMain = document.createElement('div');
                dateMain.className = 'date-main';
                dateMain.textContent = (date.getMonth() + 1) + '/' + date.getDate();
                
                var dateSub = document.createElement('div');
                dateSub.className = 'date-sub';
                dateSub.textContent = getEventWeekday(date);
                
                dateLabel.appendChild(dateMain);
                dateLabel.appendChild(dateSub);
                datesBody.appendChild(dateLabel);
                
                var row = document.createElement('div');
                row.className = 'gantt-row' + (isToday ? ' today' : '');
                
                var dayEvents = eventProcessedEvents.filter(function(e) {
                    return e.date === dateStr && eventTypeFilters[e.type];
                });
                
                dayEvents.sort(function(a, b) {
                    return a.startTime - b.startTime;
                });
                
                var tracks = [];
                var pointEventTracks = {};
                
                dayEvents.forEach(function(evt) {
                    var trackIndex = -1;
                    
                    if (evt.duration > 0) {
                        for (var i = 0; i < tracks.length; i++) {
                            if (tracks[i] <= evt.startTime) {
                                trackIndex = i;
                                break;
                            }
                        }
                        
                        if (trackIndex === -1) {
                            trackIndex = tracks.length;
                            tracks.push(0);
                        }
                        
                        tracks[trackIndex] = evt.endTime;
                    } else {
                        var nearbyEvents = dayEvents.filter(function(e) {
                            return e.duration === 0 && 
                                   Math.abs(e.startTime - evt.startTime) < 5 && 
                                   e !== evt &&
                                   pointEventTracks[e.startTime] !== undefined;
                        });
                        
                        if (nearbyEvents.length > 0) {
                            var usedTracks = nearbyEvents.map(function(e) {
                                return pointEventTracks[e.startTime];
                            });
                            trackIndex = 0;
                            while (usedTracks.indexOf(trackIndex) !== -1) {
                                trackIndex++;
                            }
                        } else {
                            trackIndex = 0;
                        }
                        
                        pointEventTracks[evt.startTime] = trackIndex;
                        
                        while (tracks.length <= trackIndex) {
                            tracks.push(0);
                        }
                    }
                    
                    var eventDiv = document.createElement('div');
                    eventDiv.className = 'gantt-event event-' + evt.type;
                    
                    var leftPercent = (evt.startTime / (24 * 60)) * 100;
                    
                    if (evt.duration > 0) {
                        var widthPercent = (evt.duration / (24 * 60)) * 100;
                        eventDiv.style.left = leftPercent + '%';
                        eventDiv.style.width = widthPercent + '%';
                        eventDiv.textContent = evt.text;
                        if (evt.who && evt.who.trim()) {
                            eventDiv.textContent += ' [' + evt.who.trim() + ']';
                        }
                    } else {
                        eventDiv.style.left = leftPercent + '%';
                        eventDiv.style.transform = 'translateX(-50%)';
                        eventDiv.classList.add('event-point');
                        
                        var icon = '';
                        var textMatch = evt.text.match(/^([\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF]|[\uD83C-\uD83E][\uDC00-\uDFFF])/);
                        if (textMatch) {
                            icon = textMatch[0];
                        } else {
                            var iconMap = {
                                'feed-milk': 'ü§±',
                                'feed-formula': 'üçº',
                                'food': 'ü•Ñ',
                                'poop': 'üí©',
                                'weight': '‚öñÔ∏è'
                            };
                            icon = iconMap[evt.type] || 'üìå';
                        }
                        eventDiv.setAttribute('data-icon', icon);
                    }
                    
                    var top = 3 + trackIndex * 28;
                    eventDiv.style.top = top + 'px';
                    eventDiv.title = evt.tooltip || evt.text;
                    
                    eventDiv.onclick = function(e) {
                        e.stopPropagation();
                        showEventCard(evt, e);
                    };
                    
                    row.appendChild(eventDiv);
                });
                
                if (tracks.length > 0) {
                    var rowHeight = Math.max(50, tracks.length * 28 + 10);
                    row.style.height = rowHeight + 'px';
                    row.style.minHeight = rowHeight + 'px';
                    dateLabel.style.height = rowHeight + 'px';
                    dateLabel.style.minHeight = rowHeight + 'px';
                }
                
                ganttContent.appendChild(row);
            });
            
            syncEventScroll();
            scrollToCurrentTime();
        }

        function syncEventScroll() {
            // ÊªöÂä®ÂêåÊ≠•Â∑≤Âú® initEventTouchDrag ‰∏≠Â§ÑÁêÜ
            // Ëøô‰∏™ÂáΩÊï∞‰øùÁïô‰∏∫Á©∫Ôºå‰ª•Èò≤ÂÖ∂‰ªñÂú∞ÊñπË∞ÉÁî®
        }

        function scrollToCurrentTime() {
            var ganttScrollArea = document.getElementById('ganttScrollArea');
            if (!ganttScrollArea) return;
            
            var now = new Date();
            var currentHour = now.getHours();
            var currentMinute = now.getMinutes();
            var timePercent = (currentHour * 60 + currentMinute) / (24 * 60);
            var contentWidth = ganttScrollArea.scrollWidth;
            var viewportWidth = ganttScrollArea.clientWidth;
            var timePosition = contentWidth * timePercent;
            var scrollPosition;
            
            if (viewportWidth < 768) {
                scrollPosition = timePosition - (viewportWidth / 3);
            } else if (viewportWidth < 1200) {
                scrollPosition = timePosition - (viewportWidth * 0.4);
            } else {
                scrollPosition = timePosition - (viewportWidth / 2);
            }
            
            if (scrollPosition < 0) scrollPosition = 0;
            var maxScroll = contentWidth - viewportWidth;
            if (scrollPosition > maxScroll) scrollPosition = maxScroll;
            
            setTimeout(function() {
                ganttScrollArea.scrollLeft = scrollPosition;
                ganttScrollArea.scrollTop = 0;
            }, 100);
        }

        function initEventTouchDrag() {
            var ganttScrollArea = document.getElementById('ganttScrollArea');
            var datesBody = document.getElementById('ganttDatesBody');
            
            if (!ganttScrollArea || !datesBody) return;

            // ÁõëÂê¨ÊªöÂä®Âå∫ÂüüÁöÑÊªöÂä®‰∫ã‰ª∂ÔºåÂêåÊ≠•Âà∞Êó•ÊúüÂàó
            ganttScrollArea.addEventListener('scroll', function() {
                datesBody.scrollTop = ganttScrollArea.scrollTop;
            });

            // ËÆæÁΩÆÂÖâÊ†áÊ†∑Âºè
            ganttScrollArea.style.cursor = 'grab';
            
            var isDown = false;
            var startX = 0;
            var startY = 0;
            var scrollLeft = 0;
            var scrollTop = 0;

            ganttScrollArea.onpointerdown = function(e) {
                if (e.target.closest('.gantt-event')) {
                    return;
                }

                isDown = true;
                startX = e.clientX;
                startY = e.clientY;
                scrollLeft = ganttScrollArea.scrollLeft;
                scrollTop = ganttScrollArea.scrollTop;

                ganttScrollArea.setPointerCapture(e.pointerId);
                ganttScrollArea.style.cursor = 'grabbing';
            };

            ganttScrollArea.onpointermove = function(e) {
                if (!isDown) return;

                var dx = e.clientX - startX;
                var dy = e.clientY - startY;

                ganttScrollArea.scrollLeft = scrollLeft - dx;
                ganttScrollArea.scrollTop = scrollTop - dy;
            };

            ganttScrollArea.onpointerup = ganttScrollArea.onpointercancel = function(e) {
                if (!isDown) return;

                isDown = false;
                ganttScrollArea.style.cursor = 'grab';

                try {
                    ganttScrollArea.releasePointerCapture(e.pointerId);
                } catch(err) {}
            };
        }

        function toggleEventType(type, element) {
            eventTypeFilters[type] = !eventTypeFilters[type];
            
            if (eventTypeFilters[type]) {
                element.classList.remove('disabled');
            } else {
                element.classList.add('disabled');
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÊï∞ÊçÆ
            if (eventProcessedEvents.length > 0) {
                renderAllEventData();
            }
        }

        function showEventCard(evt, event) {
            var card = document.getElementById('eventCard');
            var title = document.getElementById('eventCardTitle');
            var content = document.getElementById('eventCardContent');
            
            title.textContent = evt.text;
            
            var html = '';
            html += '<div class="event-card-item">';
            html += '<div class="event-card-label">Êó•Êúü</div>';
            html += '<div class="event-card-value">' + evt.date + '</div>';
            html += '</div>';
            
            if (evt.duration > 0) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">ÂºÄÂßãÊó∂Èó¥</div>';
                html += '<div class="event-card-value">' + formatMinutesToEventTime(evt.startTime) + '</div>';
                html += '</div>';
                
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">ÁªìÊùüÊó∂Èó¥</div>';
                html += '<div class="event-card-value">' + formatMinutesToEventTime(evt.endTime) + '</div>';
                html += '</div>';
                
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">ÊåÅÁª≠Êó∂Èó¥</div>';
                html += '<div class="event-card-value">' + formatEventDuration(evt.duration) + '</div>';
                html += '</div>';
            } else {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">Êó∂Èó¥</div>';
                html += '<div class="event-card-value">' + formatMinutesToEventTime(evt.startTime) + '</div>';
                html += '</div>';
            }
            
            if (evt.who && evt.who.trim()) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">Êìç‰Ωú‰∫∫</div>';
                html += '<div class="event-card-value">' + evt.who + '</div>';
                html += '</div>';
            }
            
            if (evt.tooltip && evt.tooltip !== evt.text) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">ËØ¶ÁªÜ‰ø°ÊÅØ</div>';
                html += '<div class="event-card-value" style="white-space: pre-wrap;">' + evt.tooltip + '</div>';
                html += '</div>';
            }
            
            content.innerHTML = html;
            
            var clickX = event.clientX;
            var clickY = event.clientY;
            
            card.style.left = '0px';
            card.style.top = '0px';
            card.classList.add('show');
            
            var cardWidth = card.offsetWidth;
            var cardHeight = card.offsetHeight;
            var windowWidth = window.innerWidth;
            var windowHeight = window.innerHeight;
            
            var left = clickX + 15;
            var top = clickY + 15;
            
            if (left + cardWidth > windowWidth - 20) {
                left = clickX - cardWidth - 15;
            }
            
            if (top + cardHeight > windowHeight - 20) {
                top = windowHeight - cardHeight - 20;
            }
            
            if (left < 20) {
                left = 20;
            }
            
            if (top < 20) {
                top = 20;
            }
            
            card.style.left = left + 'px';
            card.style.top = top + 'px';
        }

        function closeEventCard() {
            var card = document.getElementById('eventCard');
            card.classList.remove('show');
        }

        function formatMinutesToEventTime(minutes) {
            var hours = Math.floor(minutes / 60);
            var mins = minutes % 60;
            return (hours < 10 ? '0' + hours : hours) + ':' + (mins < 10 ? '0' + mins : mins);
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∫ã‰ª∂ËßÜÂõæÁöÑËß¶Êë∏ÊãñÂä®
        window.addEventListener('load', function() {
            initEventTouchDrag();
            
            document.addEventListener('click', function(e) {
                var card = document.getElementById('eventCard');
                if (card.classList.contains('show') && 
                    !card.contains(e.target) && 
                    !e.target.closest('.gantt-event')) {
                    closeEventCard();
                }
            });
        });

        // Â∞Ü‰æßËæπÊ∞îÊ≥°ÁªëÂÆöÂà∞ÊâìÂºÄ‰∏≠Â§ÆÂØπËØùÈù¢ÊùøÁöÑÂáΩÊï∞
        (function(){
            var bubble = document.getElementById('aiChatBubble');
            if (bubble) {
                bubble.addEventListener('click', function() {
                    // Áõ¥Êé•Ë∞ÉÁî®È°µÈù¢Â∑≤ÊúâÁöÑ openChatPanel
                    try { openChatPanel(); } catch(e) { console.error(e); }
                });
            }
        })();
    </script>

    <!-- ‰∫ã‰ª∂ËßÜÂõæÂÆπÂô® -->
    <div id="eventView" class="view-container" style="display: none;">
        <div class="event-controls">
            <div class="event-legend">
                <div class="event-legend-item" data-type="sleep" onclick="toggleEventType('sleep', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);"></div>
                    <span>Áù°Ëßâ</span>
                </div>
                <div class="event-legend-item" data-type="feed-milk" onclick="toggleEventType('feed-milk', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);"></div>
                    <span>ÊØç‰π≥</span>
                </div>
                <div class="event-legend-item" data-type="feed-formula" onclick="toggleEventType('feed-formula', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);"></div>
                    <span>Â•∂Á≤â</span>
                </div>
                <div class="event-legend-item" data-type="food" onclick="toggleEventType('food', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);"></div>
                    <span>ËæÖÈ£ü</span>
                </div>
                <div class="event-legend-item" data-type="poop" onclick="toggleEventType('poop', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);"></div>
                    <span>Êç¢Â∞øÂ∏É</span>
                </div>
                <div class="event-legend-item" data-type="weight" onclick="toggleEventType('weight', this)">
                    <div class="event-legend-color" style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);"></div>
                    <span>‰ΩìÈáç</span>
                </div>
            </div>
        </div>
        
        <div class="gantt-container">
            <div class="gantt-fixed-column">
                <div class="gantt-header-date">Êó•Êúü</div>
                <div class="gantt-dates-body" id="ganttDatesBody"></div>
            </div>
            
            <div class="gantt-scroll-area" id="ganttScrollArea">
                <div class="gantt-header-hours" id="ganttHeaderHours"></div>
                <div class="gantt-content" id="ganttContent"></div>
            </div>
        </div>
    </div>

    <!-- ‰∫ã‰ª∂ÊÇ¨ÊµÆÂç°Áâá -->
    <div class="event-card" id="eventCard">
        <div class="event-card-header">
            <div class="event-card-title" id="eventCardTitle">‰∫ã‰ª∂ËØ¶ÊÉÖ</div>
            <button class="event-card-close" onclick="closeEventCard()">√ó</button>
        </div>
        <div id="eventCardContent"></div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="switchView('event')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <line x1="9" y1="9" x2="15" y2="9"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            <span>‰∫ã‰ª∂</span>
        </div>
        <div class="nav-item active" onclick="switchView('analysis')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            <span>ÂàÜÊûê</span>
        </div>
    </div>

</body>
</html>