<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>å®å®æ—¥å¸¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header-container {
      position: relative;
      margin-bottom: 10px;
    }
    .settings-btn,.refresh-btn {
      background: rgba(255,255,255,.15);
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .3s;
    }
    .settings-btn {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
    }
    .refresh-btn {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
    }
    .settings-btn:hover,.refresh-btn:hover {
      background: rgba(255,255,255,.25);
      transform: translateY(-50%) scale(1.05);
    }
    .refresh-btn.loading {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: translateY(-50%) rotate(0); }
      to { transform: translateY(-50%) rotate(360deg); }
    }
    h1 {
      color: #fff;
      text-align: center;
      margin: 0;
      font-size: clamp(22px,6vw,32px);
      text-shadow: 2px 2px 4px rgba(0,0,0,.2);
    }
    #babyAge {
      display: block;
      text-align: center;
      color: #fff;
      margin-bottom: 15px;
      font-size: clamp(13px,3.5vw,16px);
    }

    .file-input-container {
      background: rgba(255,255,255,.95);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    .toggle-btn {
      background: transparent;
      border: none;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
    }
    .birth-date-input {
      margin: 12px 0;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }
    .file-label {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 6px;
    }
    .file-input-container input[type="file"] {
      display: none;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
    }

    .today-summary,
    .yesterday-summary {
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(3px);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .today-summary h2,
    .yesterday-summary h2 {
      color: #fff;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .today-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 10px;
    }
    .today-card {
      background: rgba(255,255,255,.15);
      border-radius: 8px;
      padding: 10px;
      color: #fff;
    }
    .today-card h3 {
      margin-bottom: 6px;
      font-size: 14px;
    }
    .today-card .detail {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 6px;
      font-size: 13px;
      align-items: center;
    }
    .today-card .num {
      font-weight: 700;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: rgba(255,255,255,.95);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    .stat-card h3 {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }
    .stat-card .value {
      font-size: 26px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 4px;
    }
    .stat-card .label {
      font-size: 12px;
      color: #999;
    }

    .chart-container {
      background: rgba(255,255,255,.95);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,.1);
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .chart-title {
      font-weight: 700;
      font-size: 15px;
    }
    .time-dimension {
      display: flex;
      gap: 6px;
    }
    .time-dimension button {
      padding: 4px 10px;
      border: 1px solid #667eea;
      background: #fff;
      color: #667eea;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .time-dimension button.active {
      background: #667eea;
      color: #fff;
    }

    .chart-slide-wrapper {
      overflow: hidden;
      position: relative;
      width: 100%;
    }
    /* è¿™é‡Œæ˜¯å…³é”®ï¼šæœ€å°‘å’Œå¤–é¢ä¸€æ ·å®½ */
    .chart-slide-inner {
      will-change: transform;
      position: relative;
      min-width: 100%;
    }
    canvas {
      max-height: 280px;
      display: block;
      touch-action: pan-y;
      user-select: none;
      cursor: grab;
    }
    canvas:active {
      cursor: grabbing;
    }

    /* è®¾ç½®å¼¹çª— */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      width: 90%;
      max-width: 420px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    /* AI é¢æ¿æŒ‰é’®å…ˆç•™ç€ */
    .chat-btn {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: #667eea;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(102,126,234,.3);
    }
    .chat-panel {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 340px;
      height: 460px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,.2);
      display: none;
      flex-direction: column;
      z-index: 1100;
    }
    .chat-panel.show {
      display: flex;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #f6f6f6;
    }
    .chat-message {
      margin-bottom: 8px;
      border-radius: 8px;
      padding: 6px 8px;
      max-width: 90%;
    }
    .chat-message.user {
      background: #667eea;
      color: #fff;
      margin-left: auto;
    }
    .chat-message.assistant {
      background: #fff;
      border: 1px solid #eee;
      color: #333;
    }
    .chat-input-group {
      display: flex;
      gap: 6px;
      padding: 8px;
      border-top: 1px solid #eee;
    }
    .chat-input-group input {
      flex: 1;
      padding: 6px 8px;
    }

    @media (max-width: 600px) {
      .chart-header { flex-wrap: wrap; }
      .time-dimension { margin-left: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <button class="settings-btn" onclick="openSettings()">â˜°</button>
      <h1>ğŸ“Š å®å®æ—¥å¸¸</h1>
      <button class="refresh-btn" onclick="refreshData()">âŸ³</button>
    </div>
    <span id="babyAge">æ­£åœ¨è®¡ç®—...</span>

    <div id="fileContainer" class="file-input-container">
      <button id="toggleBtn" class="toggle-btn" onclick="toggleFileSection()">ğŸ“ æ‰‹åŠ¨ä¸Šä¼ CSVï¼ˆç‚¹å‡»å±•å¼€ï¼‰</button>
      <div id="fileDetails" style="display:none;">
        <div class="birth-date-input">
          <label for="birthDate">ğŸ“… å®å®ç”Ÿæ—¥ï¼š</label>
          <input type="date" id="birthDate" value="2025-02-24">
        </div>
        <label class="file-label" for="csvFile">ğŸ“‚ é€‰æ‹©CSVæ–‡ä»¶
          <input type="file" id="csvFile" accept=".csv">
        </label>
        <div class="status" id="status">ç­‰å¾…ä¸Šä¼ CSVæ–‡ä»¶</div>
      </div>
    </div>

    <div id="dataContainer" class="">
      <!-- ä»Šæ—¥ -->
      <div class="today-summary">
        <h2>ğŸ“… ä»Šæ—¥æ±‡æ€» <span id="todayDate"></span></h2>
        <div class="today-grid">
          <div class="today-card">
            <h3>ğŸ¼ å–‚å¥¶</h3>
            <div class="detail"><span>æ€»æ¬¡æ•°</span><span id="todayFeedCount" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>å¥¶ç²‰</span><span id="todayFormula" class="num">-</span><span>ml</span></div>
            <div class="detail"><span>æ¯ä¹³</span><span id="todayBreast" class="num">-</span><span>min</span></div>
          </div>
          <div class="today-card">
            <h3>ğŸ˜´ ç¡çœ </h3>
            <div class="detail"><span>æ¬¡æ•°</span><span id="todaySleepCount" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>æ€»æ—¶é•¿</span><span id="todaySleepTotal" class="num">-</span><span>h</span></div>
            <div class="detail"><span>æœ€é•¿</span><span id="todaySleepMax" class="num">-</span><span>h</span></div>
          </div>
          <div class="today-card">
            <h3>â˜€ï¸ ç™½å¤©</h3>
            <div class="detail"><span>å–‚å¥¶</span><span id="todayDayFeed" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>ç¡çœ </span><span id="todayDaySleep" class="num">-</span><span>h</span></div>
          </div>
          <div class="today-card">
            <h3>ğŸŒ™ å¤œé—´</h3>
            <div class="detail"><span>å–‚å¥¶</span><span id="todayNightFeed" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>ç¡çœ </span><span id="todayNightSleep" class="num">-</span><span>h</span></div>
          </div>
        </div>
      </div>

      <!-- æ˜¨æ—¥ -->
      <div class="yesterday-summary">
        <h2>ğŸ“† æ˜¨æ—¥æ±‡æ€» <span id="yesterdayDate"></span></h2>
        <div class="today-grid">
          <div class="today-card">
            <h3>ğŸ¼ å–‚å¥¶</h3>
            <div class="detail"><span>æ€»æ¬¡æ•°</span><span id="yesterdayFeedCount" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>å¥¶ç²‰</span><span id="yesterdayFormula" class="num">-</span><span>ml</span></div>
            <div class="detail"><span>æ¯ä¹³</span><span id="yesterdayBreast" class="num">-</span><span>min</span></div>
          </div>
          <div class="today-card">
            <h3>ğŸ˜´ ç¡çœ </h3>
            <div class="detail"><span>æ¬¡æ•°</span><span id="yesterdaySleepCount" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>æ€»æ—¶é•¿</span><span id="yesterdaySleepTotal" class="num">-</span><span>h</span></div>
            <div class="detail"><span>æœ€é•¿</span><span id="yesterdaySleepMax" class="num">-</span><span>h</span></div>
          </div>
          <div class="today-card">
            <h3>â˜€ï¸ ç™½å¤©</h3>
            <div class="detail"><span>å–‚å¥¶</span><span id="yesterdayDayFeed" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>ç¡çœ </span><span id="yesterdayDaySleep" class="num">-</span><span>h</span></div>
          </div>
          <div class="today-card">
            <h3>ğŸŒ™ å¤œé—´</h3>
            <div class="detail"><span>å–‚å¥¶</span><span id="yesterdayNightFeed" class="num">-</span><span>æ¬¡</span></div>
            <div class="detail"><span>ç¡çœ </span><span id="yesterdayNightSleep" class="num">-</span><span>h</span></div>
          </div>
        </div>
      </div>

      <!-- ç»Ÿè®¡å¡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>ğŸ’¤ å¹³å‡ç¡çœ </h3>
          <div class="value"><span id="avgSleep">-</span> h</div>
          <div class="label">æ¯æ—¥</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ¼ å¹³å‡å¥¶ç²‰</h3>
          <div class="value"><span id="avgFormula">-</span> ml</div>
          <div class="label">æ¯æ—¥</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ‘¶ å¹³å‡æ¯ä¹³</h3>
          <div class="value"><span id="avgBreast">-</span> min</div>
          <div class="label">æ¯æ—¥</div>
        </div>
        <div class="stat-card">
          <h3>âš–ï¸ å½“å‰ä½“é‡</h3>
          <div class="value"><span id="currentWeight">-</span> kg</div>
          <div class="label">æœ€è¿‘è®°å½•</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ¼ å–‚å¥¶é—´éš”</h3>
          <div class="value"><span id="avgFeedInterval">-</span> h</div>
          <div class="label">å¹³å‡</div>
        </div>
        <div class="stat-card">
          <h3>ğŸ’¤ ç¡çœ é—´éš”</h3>
          <div class="value"><span id="avgSleepInterval">-</span> h</div>
          <div class="label">å¹³å‡</div>
        </div>
      </div>

      <!-- å›¾è¡¨ä»¬ -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ¼ å–‚å¥¶æ¬¡æ•°ï¼ˆç™½å¤©/å¤œé—´ï¼‰</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'feedCount','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'feedCount','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'feedCount','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="feedCountChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ¼ æ¯æ—¥å–‚å¥¶é‡</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'feedAmount','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'feedAmount','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'feedAmount','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="feedAmountChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ’¤ ç¡çœ æ—¶é•¿ï¼ˆç™½å¤©/å¤œé—´ï¼‰</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'sleepDuration','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'sleepDuration','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'sleepDuration','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="sleepDurationChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ’¤ ç¡çœ é—´éš”ï¼ˆç™½å¤©/å¤œé—´ï¼‰</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'sleepInterval','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'sleepInterval','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'sleepInterval','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="sleepIntervalChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ¼ å–‚å¥¶é—´éš”ï¼ˆç™½å¤©/å¤œé—´ï¼‰</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'feedInterval','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'feedInterval','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'feedInterval','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="feedIntervalChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">âš–ï¸ ä½“é‡å˜åŒ–</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'weight','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'weight','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'weight','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="weightChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">ğŸ’© å¤§ä¾¿æ¬¡æ•°</div>
          <div class="time-dimension">
            <button class="active" onclick="changeTimeDimension(this,'poop','day')">æ—¥</button>
            <button onclick="changeTimeDimension(this,'poop','week')">å‘¨</button>
            <button onclick="changeTimeDimension(this,'poop','month')">æœˆ</button>
          </div>
        </div>
        <div class="chart-slide-wrapper">
          <div class="chart-slide-inner">
            <canvas id="poopChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½® -->
  <div id="settingsModal" class="modal-overlay" onclick="closeSettingsIfClickOutside(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <button class="close-btn" onclick="closeSettings()">Ã—</button>
      </div>
      <form id="settingsForm">
        <div class="form-group">
          <label for="babyNameInput">å®å®åå­—</label>
          <input type="text" id="babyNameInput" style="width:100%;padding:6px 8px;">
        </div>
        <div class="form-group" style="margin-top:10px;">
          <label for="birthDateInput">å®å®ç”Ÿæ—¥</label>
          <input type="date" id="birthDateInput" style="width:100%;padding:6px 8px;">
        </div>
        <div class="form-group" style="margin-top:10px;">
          <label for="defaultChartDaysInput">å›¾è¡¨é»˜è®¤æ˜¾ç¤ºå¤©æ•°ï¼ˆä»…ä½œä¸ºå‚è€ƒï¼‰</label>
          <input type="number" id="defaultChartDaysInput" min="3" max="15" value="5" style="width:100%;padding:6px 8px;">
          <small style="color:#666;">ç°åœ¨å·²ç»æŒ‰å±å¹•å®½åº¦è‡ªåŠ¨è®¡ç®—äº†ï¼Œè¿™ä¸ªå€¼åªæ˜¯ç»™è„šæœ¬åšä¸Šé™ç”¨</small>
        </div>
        <button type="submit" style="margin-top:16px;width:100%;padding:8px;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;">ä¿å­˜</button>
      </form>
    </div>
  </div>

  <!-- AIèŠå¤©æŒ‰é’® -->
  <button id="chatBtn" class="chat-btn" onclick="openChatPanel()">ğŸ’¬</button>
  <div id="chatPanel" class="chat-panel">
    <div style="padding:10px 12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
      <strong>ğŸ¤– å®å®æ•°æ®é—®ç­”</strong>
      <button class="close-btn" onclick="closeChatPanel()">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-group">
      <input id="chatInput" placeholder="é—®ä¸€ä¸‹å®å®ç¡çœ /å–‚å¥¶..." onkeypress="if(event.key==='Enter'){sendMessage();}">
      <button onclick="sendMessage()">â¤</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // =========================================================
    // ä¸€äº›å…¨å±€å˜é‡
    // =========================================================
    var charts = {};
    var allAnalyzedData = { dates: [], data: {} };
    var chartScroll = {
      feedCount: { offset: 0, totalItems: 0 },
      feedAmount: { offset: 0, totalItems: 0 },
      sleepDuration: { offset: 0, totalItems: 0 },
      sleepInterval: { offset: 0, totalItems: 0 },
      feedInterval: { offset: 0, totalItems: 0 },
      weight: { offset: 0, totalItems: 0 },
      poop: { offset: 0, totalItems: 0 }
    };
    var defaultChartDays = 5;

    // =========================================================
    // è®¾ç½®å¼¹çª— & æœ¬åœ°å­˜å‚¨
    // =========================================================
    function openSettings() {
      loadSettings();
      document.getElementById('settingsModal').classList.add('show');
    }
    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }
    function closeSettingsIfClickOutside(e) {
      if (e.target.id === 'settingsModal') {
        closeSettings();
      }
    }
    function loadSettings() {
      var babyName = localStorage.getItem('babyName') || '';
      var birthDate = localStorage.getItem('birthDate') || '2025-02-24';
      var chartDays = localStorage.getItem('defaultChartDays') || '5';
      document.getElementById('babyNameInput').value = babyName;
      document.getElementById('birthDateInput').value = birthDate;
      document.getElementById('defaultChartDaysInput').value = chartDays;
    }
    function saveSettings(e) {
      e.preventDefault();
      var babyName = document.getElementById('babyNameInput').value;
      var birthDate = document.getElementById('birthDateInput').value;
      var chartDays = parseInt(document.getElementById('defaultChartDaysInput').value) || 5;
      localStorage.setItem('babyName', babyName);
      localStorage.setItem('birthDate', birthDate);
      localStorage.setItem('defaultChartDays', chartDays);
      defaultChartDays = chartDays;
      updateBabyAge();
      updateTitle();
      closeSettings();
      // æœ‰æ•°æ®çš„è¯é‡ç”»
      if (allAnalyzedData && allAnalyzedData.dates.length) {
        renderCharts(allAnalyzedData);
      }
    }
    document.getElementById('settingsForm').addEventListener('submit', saveSettings);

    function updateTitle() {
      var babyName = localStorage.getItem('babyName');
      var h1 = document.querySelector('h1');
      if (babyName && babyName.trim() !== '') {
        h1.textContent = 'ğŸ“Š ' + babyName + 'çš„æ—¥å¸¸';
      } else {
        h1.textContent = 'ğŸ“Š å®å®æ—¥å¸¸';
      }
    }
    function updateBabyAge() {
      var birth = localStorage.getItem('birthDate') || document.getElementById('birthDate').value;
      if (!birth) return;
      var b = new Date(birth + 'T00:00:00');
      var now = new Date();
      var months = (now.getFullYear() - b.getFullYear()) * 12 + (now.getMonth() - b.getMonth());
      var days = now.getDate() - b.getDate();
      if (days < 0) {
        months--;
        var prev = new Date(now.getFullYear(), now.getMonth(), 0);
        days = prev.getDate() - b.getDate() + now.getDate();
      }
      var babyName = localStorage.getItem('babyName') || 'å®å®';
      document.getElementById('babyAge').textContent = babyName + 'å·²ç» ' + months + ' ä¸ªæœˆ ' + days + ' å¤©äº† ğŸ‰';
    }

    // =========================================================
    // ä¸Šä¼ åŒºåŸŸå±•å¼€/æ”¶èµ·
    // =========================================================
    function toggleFileSection() {
      var d = document.getElementById('fileDetails');
      var btn = document.getElementById('toggleBtn');
      if (d.style.display === 'none') {
        d.style.display = 'block';
        btn.textContent = 'ğŸ“ æ”¶èµ·';
      } else {
        d.style.display = 'none';
        btn.textContent = 'ğŸ“ æ‰‹åŠ¨ä¸Šä¼ CSVï¼ˆç‚¹å‡»å±•å¼€ï¼‰';
      }
    }

    // =========================================================
    // CSV è§£æ & æ•°æ®åˆ†æ
    // =========================================================
    function parseCSV(text) {
      var lines = text.trim().split('\n');
      if (lines.length < 2) return [];
      var headers = lines[0].split(',').map(function(h){ return h.trim(); });
      var data = [];
      for (var i=1;i<lines.length;i++) {
        var line = lines[i].trim();
        if (!line) continue;
        var cols = line.split(',');
        var row = {};
        for (var j=0;j<headers.length;j++) {
          row[headers[j]] = cols[j] ? cols[j].trim() : '';
        }
        if (row.timestamp) data.push(row);
      }
      return data;
    }

    // æ™šä¸Š20:00~éš”å¤©06:00 å½’å‰ä¸€å¤©
    function classifyDateFromTimestamp(ts) {
      var parts = ts.split(' ');
      var date = parts[0];
      var time = parts[1] || '00:00:00';
      var hour = parseInt(time.split(':')[0]);
      var d = new Date(date + 'T00:00:00');
      if (hour < 6) {
        d.setDate(d.getDate() - 1);
      }
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth()+1).padStart(2,'0');
      var dd = String(d.getDate()).padStart(2,'0');
      return yyyy + '-' + mm + '-' + dd;
    }

    function analyzeData(csvRows) {
      var daily = {};
      var allDatesSet = {};

      csvRows.forEach(function(row){
        var ts = row.timestamp;
        if (!ts) return;
        var dateKey = classifyDateFromTimestamp(ts);  // 2025-11-02
        var shortKey = dateKey.slice(5);              // 11-02

        if (!daily[dateKey]) {
          daily[dateKey] = {
            date: dateKey,
            feedCount: 0,
            dayFeed: 0,
            nightFeed: 0,
            formulaMl: 0,
            breastMin: 0,
            sleepDurations: [],
            sleepTotal: 0,
            sleepMax: 0,
            daySleep: 0,
            nightSleep: 0,
            weight: null,
            poop: 0,
            feedTimes: [],
            sleepEndTimes: []
          };
        }
        var d = daily[dateKey];
        allDatesSet[dateKey] = true;

        var hour = parseInt(ts.split(' ')[1].split(':')[0]);
        var isNight = (hour >= 20 || hour < 6);

        var t = row.event_type ? row.event_type.trim() : '';
        var sub = row.subtype ? row.subtype.trim() : '';
        var val = row.value ? parseFloat(row.value) : 0;

        // å–‚å¥¶
        if (t === 'å–‚å¥¶' || t === 'feed' || t === 'å–å¥¶') {
          d.feedCount += 1;
          if (isNight) d.nightFeed += 1; else d.dayFeed += 1;
          d.feedTimes.push(new Date(ts.replace(' ','T')));
          // å¥¶ç²‰
          if (sub.indexOf('å¥¶ç²‰') !== -1 || sub.toLowerCase().indexOf('formula') !== -1) {
            d.formulaMl += val || 0;
          } else if (sub.indexOf('æ¯ä¹³') !== -1 || sub.toLowerCase().indexOf('breast') !== -1) {
            d.breastMin += val || 0;
          }
        }

        // ç¡è§‰ï¼šæˆ‘ä»¬åªè®¤â€œç»“æŸ + pair_keyâ€ä¸ºä¸€æ¬¡ç¡çœ 
        if ((t === 'ç¡è§‰' || t === 'sleep') && (sub === 'ç»“æŸ' || sub === 'end') && row.pair_key) {
          var start = new Date(row.pair_key.replace(' ','T'));
          var end = new Date(ts.replace(' ','T'));
          var durH = (end - start) / 3600000;
          if (durH > 0 && durH < 24) {
            d.sleepDurations.push(durH);
            d.sleepTotal += durH;
            if (durH > d.sleepMax) d.sleepMax = durH;
            d.sleepEndTimes.push(end);

            var startHour = start.getHours();
            var startIsNight = (startHour >= 20 || startHour < 6);
            if (startIsNight) d.nightSleep += durH;
            else d.daySleep += durH;
          }
        }

        // ä½“é‡
        if (t === 'ä½“é‡' || t.toLowerCase() === 'weight') {
          d.weight = val || d.weight;
        }

        // å¤§ä¾¿
        if (t === 'å¤§ä¾¿' || t.toLowerCase() === 'poop') {
          d.poop += 1;
        }
      });

      // æ’åºæ—¥æœŸ
      var dates = Object.keys(allDatesSet).sort();
      return {
        dates: dates,
        data: daily
      };
    }

    // =========================================================
    // è®¡ç®— å„ç§æ€»è§ˆæ•°å­—
    // =========================================================
    function renderSummaries(analyzed) {
      if (!analyzed.dates.length) return;
      var dates = analyzed.dates;
      var last = dates[dates.length - 1];
      var prev = dates.length > 1 ? dates[dates.length - 2] : null;
      var today = analyzed.data[last];

      // today
      document.getElementById('todayDate').textContent = last;
      document.getElementById('todayFeedCount').textContent = today.feedCount || 0;
      document.getElementById('todayFormula').textContent = Math.round(today.formulaMl || 0);
      document.getElementById('todayBreast').textContent = Math.round(today.breastMin || 0);
      document.getElementById('todaySleepCount').textContent = today.sleepDurations.length || 0;
      document.getElementById('todaySleepTotal').textContent = (today.sleepTotal || 0).toFixed(1);
      document.getElementById('todaySleepMax').textContent = (today.sleepMax || 0).toFixed(1);
      document.getElementById('todayDayFeed').textContent = today.dayFeed || 0;
      document.getElementById('todayNightFeed').textContent = today.nightFeed || 0;
      document.getElementById('todayDaySleep').textContent = (today.daySleep || 0).toFixed(1);
      document.getElementById('todayNightSleep').textContent = (today.nightSleep || 0).toFixed(1);

      // yesterday
      if (prev) {
        var y = analyzed.data[prev];
        document.getElementById('yesterdayDate').textContent = prev;
        document.getElementById('yesterdayFeedCount').textContent = y.feedCount || 0;
        document.getElementById('yesterdayFormula').textContent = Math.round(y.formulaMl || 0);
        document.getElementById('yesterdayBreast').textContent = Math.round(y.breastMin || 0);
        document.getElementById('yesterdaySleepCount').textContent = y.sleepDurations.length || 0;
        document.getElementById('yesterdaySleepTotal').textContent = (y.sleepTotal || 0).toFixed(1);
        document.getElementById('yesterdaySleepMax').textContent = (y.sleepMax || 0).toFixed(1);
        document.getElementById('yesterdayDayFeed').textContent = y.dayFeed || 0;
        document.getElementById('yesterdayNightFeed').textContent = y.nightFeed || 0;
        document.getElementById('yesterdayDaySleep').textContent = (y.daySleep || 0).toFixed(1);
        document.getElementById('yesterdayNightSleep').textContent = (y.nightSleep || 0).toFixed(1);
      }

      // stats
      var totalSleep = 0, totalFormula = 0, totalBreast = 0, totalFeedIntervals = [], totalSleepIntervals = [], latestWeight = null;
      dates.forEach(function(d){
        var day = analyzed.data[d];
        totalSleep += day.sleepTotal || 0;
        totalFormula += day.formulaMl || 0;
        totalBreast += day.breastMin || 0;
        if (day.weight) latestWeight = day.weight;
        // å–‚å¥¶é—´éš”
        if (day.feedTimes && day.feedTimes.length > 1) {
          for (var i=1;i<day.feedTimes.length;i++) {
            var diff = (day.feedTimes[i] - day.feedTimes[i-1]) / 3600000;
            if (diff > 0 && diff < 24) totalFeedIntervals.push(diff);
          }
        }
        // ç¡çœ é—´éš”
        if (day.sleepEndTimes && day.sleepEndTimes.length > 1) {
          for (var j=1;j<day.sleepEndTimes.length;j++) {
            var diff2 = (day.sleepEndTimes[j] - day.sleepEndTimes[j-1]) / 3600000;
            if (diff2 > 0 && diff2 < 24) totalSleepIntervals.push(diff2);
          }
        }
      });
      var n = dates.length;
      document.getElementById('avgSleep').textContent = n ? (totalSleep/n).toFixed(1) : '-';
      document.getElementById('avgFormula').textContent = n ? Math.round(totalFormula/n) : '-';
      document.getElementById('avgBreast').textContent = n ? Math.round(totalBreast/n) : '-';
      document.getElementById('currentWeight').textContent = latestWeight ? latestWeight : '-';
      var avgFeedI = totalFeedIntervals.length ? (totalFeedIntervals.reduce((a,b)=>a+b,0)/totalFeedIntervals.length).toFixed(1) : '-';
      var avgSleepI = totalSleepIntervals.length ? (totalSleepIntervals.reduce((a,b)=>a+b,0)/totalSleepIntervals.length).toFixed(1) : '-';
      document.getElementById('avgFeedInterval').textContent = avgFeedI;
      document.getElementById('avgSleepInterval').textContent = avgSleepI;
    }

    // =========================================================
    // å…³é”®ï¼šæŒ‰å±å¹•è‡ªåŠ¨ç®—ä¸€å±å¤šå°‘å¤©
    // =========================================================
    function getVisibleCountForChart(chartType) {
      var canvas = document.getElementById(chartType + 'Chart');
      var wrapper = canvas ? canvas.closest('.chart-slide-wrapper') : null;
      var width = wrapper ? wrapper.clientWidth : (canvas ? canvas.clientWidth : window.innerWidth);
      var minDayWidth = 70;
      var autoCount = Math.floor(width / minDayWidth);
      return Math.max(3, autoCount || 3);
    }

    function getVisibleData(labels, chartType) {
      var totalItems = labels.length;
      var visibleCount = getVisibleCountForChart(chartType);

      if (!chartScroll[chartType]) {
        chartScroll[chartType] = { offset: 0, totalItems: totalItems, visible: visibleCount };
      }

      var offset = chartScroll[chartType].offset || 0;
      chartScroll[chartType].totalItems = totalItems;
      chartScroll[chartType].visible = visibleCount;

      var maxOffset = Math.max(0, totalItems - visibleCount);
      if (offset < 0) offset = 0;
      if (offset > maxOffset) offset = maxOffset;
      chartScroll[chartType].offset = offset;

      var endIndex = totalItems - Math.floor(offset);
      var startIndex = Math.max(0, endIndex - visibleCount);
      var visibleLabels = labels.slice(startIndex, endIndex);

      return {
        labels: visibleLabels,
        startIndex: startIndex,
        endIndex: endIndex,
        maxOffset: maxOffset,
        currentOffset: offset,
        visibleCount: visibleCount
      };
    }

    function ensureChartWidth(chartType) {
      var canvas = document.getElementById(chartType + 'Chart');
      if (!canvas) return;
      var wrapper = canvas.closest('.chart-slide-wrapper');
      var inner = wrapper ? wrapper.querySelector('.chart-slide-inner') : null;
      if (!wrapper || !inner) return;

      var totalItems = chartScroll[chartType] ? chartScroll[chartType].totalItems : 0;
      var visible = chartScroll[chartType] ? chartScroll[chartType].visible : getVisibleCountForChart(chartType);
      var perDayWidth = 70;
      var totalWidth = Math.max(totalItems * perDayWidth, wrapper.clientWidth);

      inner.style.width = totalWidth + 'px';
      canvas.style.width = totalWidth + 'px';
    }

    function bindSwipeToChart(chartType) {
      var canvas = document.getElementById(chartType + 'Chart');
      if (!canvas) return;
      var wrapper = canvas.closest('.chart-slide-wrapper');
      var inner = wrapper ? wrapper.querySelector('.chart-slide-inner') : null;
      if (!wrapper || !inner) return;

      ensureChartWidth(chartType);

      var isDown = false;
      var startX = 0;
      var startTranslate = 0;

      function getTranslate() {
        var t = inner.style.transform;
        if (!t) return 0;
        var m = /translateX\\(([-0-9.]+)px\\)/.exec(t);
        return m ? parseFloat(m[1]) : 0;
      }

      function clamp(x) {
        var wrapperW = wrapper.clientWidth;
        var totalW = inner.offsetWidth;
        var minX = Math.min(0, wrapperW - totalW);
        if (x < minX) x = minX;
        if (x > 0) x = 0;
        return x;
      }

      function setTranslate(x) {
        x = clamp(x);
        inner.style.transform = 'translateX(' + x + 'px)';

        // åŒæ­¥å› scroll çŠ¶æ€
        var totalW = inner.offsetWidth;
        var wrapperW = wrapper.clientWidth;
        var perDayWidth = 70;
        var hiddenRight = totalW + x - wrapperW;
        if (hiddenRight < 0) hiddenRight = 0;

        var totalItems = chartScroll[chartType] ? chartScroll[chartType].totalItems : 0;
        var visible = chartScroll[chartType] ? chartScroll[chartType].visible : getVisibleCountForChart(chartType);
        var pixelOffset = hiddenRight / perDayWidth;
        var maxOffset = Math.max(0, totalItems - visible);
        if (pixelOffset > maxOffset) pixelOffset = maxOffset;
        if (chartScroll[chartType]) {
          chartScroll[chartType].offset = pixelOffset;
        }
      }

      wrapper.onpointerdown = function (e) {
        isDown = true;
        startX = e.clientX;
        startTranslate = getTranslate();
        wrapper.setPointerCapture(e.pointerId);
      };

      wrapper.onpointermove = function (e) {
        if (!isDown) return;
        var dx = e.clientX - startX;
        setTranslate(startTranslate + dx);
      };

      wrapper.onpointerup = wrapper.onpointercancel = function (e) {
        isDown = false;
        if (e.pointerId) {
          try { wrapper.releasePointerCapture(e.pointerId); } catch (_) {}
        }
      };

      window.addEventListener('resize', function () {
        ensureChartWidth(chartType);
        var cur = getTranslate();
        setTranslate(cur);
      });
    }

    // =========================================================
    // å›¾è¡¨æ¸²æŸ“
    // =========================================================
    function renderCharts(analyzed) {
      var dates = analyzed.dates;
      if (!dates.length) return;

      // 1. å–‚å¥¶æ¬¡æ•°
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'feedCount');
        var dayData = [];
        var nightData = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          dayData.push(full ? full.dayFeed || 0 : 0);
          nightData.push(full ? full.nightFeed || 0 : 0);
        });

        var ctx = document.getElementById('feedCountChart').getContext('2d');
        if (charts.feedCount) charts.feedCount.destroy();
        charts.feedCount = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'ç™½å¤©', data: dayData, backgroundColor: 'rgba(255,206,86,0.8)' },
              { label: 'å¤œé—´', data: nightData, backgroundColor: 'rgba(153,102,255,0.8)' }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        ensureChartWidth('feedCount');
        bindSwipeToChart('feedCount');
      })();

      // 2. å–‚å¥¶é‡
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'feedAmount');
        var formula = [];
        var breast = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          formula.push(full ? Math.round(full.formulaMl || 0) : 0);
          breast.push(full ? Math.round(full.breastMin || 0) : 0);
        });
        var ctx = document.getElementById('feedAmountChart').getContext('2d');
        if (charts.feedAmount) charts.feedAmount.destroy();
        charts.feedAmount = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'å¥¶ç²‰(ml)', data: formula, backgroundColor: 'rgba(54,162,235,0.8)' },
              { label: 'æ¯ä¹³(min)', data: breast, backgroundColor: 'rgba(255,99,132,0.8)' }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        ensureChartWidth('feedAmount');
        bindSwipeToChart('feedAmount');
      })();

      // 3. ç¡çœ æ—¶é•¿
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'sleepDuration');
        var daySleep = [];
        var nightSleep = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          daySleep.push(full ? (full.daySleep || 0).toFixed(1) : 0);
          nightSleep.push(full ? (full.nightSleep || 0).toFixed(1) : 0);
        });
        var ctx = document.getElementById('sleepDurationChart').getContext('2d');
        if (charts.sleepDuration) charts.sleepDuration.destroy();
        charts.sleepDuration = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'ç™½å¤©ç¡çœ (h)', data: daySleep, backgroundColor: 'rgba(255,206,86,0.8)' },
              { label: 'å¤œé—´ç¡çœ (h)', data: nightSleep, backgroundColor: 'rgba(153,102,255,0.8)' }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        ensureChartWidth('sleepDuration');
        bindSwipeToChart('sleepDuration');
      })();

      // 4. ç¡çœ é—´éš”
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'sleepInterval');
        var avgInterval = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          var arr = full ? full.sleepEndTimes || [] : [];
          if (arr.length > 1) {
            var gaps = [];
            for (var i=1;i<arr.length;i++) {
              var diff = (arr[i] - arr[i-1]) / 3600000;
              if (diff > 0 && diff < 24) gaps.push(diff);
            }
            var avg = gaps.length ? gaps.reduce((a,b)=>a+b,0)/gaps.length : 0;
            avgInterval.push(avg.toFixed(1));
          } else {
            avgInterval.push(0);
          }
        });
        var ctx = document.getElementById('sleepIntervalChart').getContext('2d');
        if (charts.sleepInterval) charts.sleepInterval.destroy();
        charts.sleepInterval = new Chart(ctx, {
          type: 'line',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'å¹³å‡ç¡çœ é—´éš”(h)', data: avgInterval, borderColor: 'rgba(153,102,255,1)', backgroundColor: 'rgba(153,102,255,0.2)', tension: 0.3, fill: true }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        ensureChartWidth('sleepInterval');
        bindSwipeToChart('sleepInterval');
      })();

      // 5. å–‚å¥¶é—´éš”
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'feedInterval');
        var avgInterval = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          var arr = full ? full.feedTimes || [] : [];
          if (arr.length > 1) {
            var gaps = [];
            for (var i=1;i<arr.length;i++) {
              var diff = (arr[i] - arr[i-1]) / 3600000;
              if (diff > 0 && diff < 24) gaps.push(diff);
            }
            var avg = gaps.length ? gaps.reduce((a,b)=>a+b,0)/gaps.length : 0;
            avgInterval.push(avg.toFixed(1));
          } else {
            avgInterval.push(0);
          }
        });
        var ctx = document.getElementById('feedIntervalChart').getContext('2d');
        if (charts.feedInterval) charts.feedInterval.destroy();
        charts.feedInterval = new Chart(ctx, {
          type: 'line',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'å¹³å‡å–‚å¥¶é—´éš”(h)', data: avgInterval, borderColor: 'rgba(75,192,192,1)', backgroundColor: 'rgba(75,192,192,0.2)', tension: 0.3, fill: true }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        ensureChartWidth('feedInterval');
        bindSwipeToChart('feedInterval');
      })();

      // 6. ä½“é‡
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'weight');
        var weights = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          weights.push(full && full.weight ? full.weight : null);
        });
        var ctx = document.getElementById('weightChart').getContext('2d');
        if (charts.weight) charts.weight.destroy();
        charts.weight = new Chart(ctx, {
          type: 'line',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'ä½“é‡(kg)', data: weights, borderColor: 'rgba(255,159,64,1)', backgroundColor: 'rgba(255,159,64,0.2)', tension: 0.3, spanGaps: true }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
        ensureChartWidth('weight');
        bindSwipeToChart('weight');
      })();

      // 7. å¤§ä¾¿
      (function(){
        var labels = dates;
        var paged = getVisibleData(labels, 'poop');
        var poops = [];
        paged.labels.forEach(function(d){
          var full = analyzed.data[d];
          poops.push(full ? full.poop || 0 : 0);
        });
        var ctx = document.getElementById('poopChart').getContext('2d');
        if (charts.poop) charts.poop.destroy();
        charts.poop = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: paged.labels,
            datasets: [
              { label: 'å¤§ä¾¿æ¬¡æ•°', data: poops, backgroundColor: 'rgba(201,203,207,0.8)' }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        ensureChartWidth('poop');
        bindSwipeToChart('poop');
      })();
    }

    // æ—¶é—´ç»´åº¦åˆ‡æ¢ï¼ˆè¿™é‡Œå…ˆç®€å•å¤„ç†ï¼Œå®é™…ä½ å¯ä»¥åšå‘¨/æœˆèšåˆï¼‰
    function changeTimeDimension(btn, chartType, dim) {
      var parent = btn.parentNode;
      Array.from(parent.children).forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      // æš‚æ—¶æˆ‘ä»¬è¿˜æ˜¯æŒ‰ day çš„æ•°æ®æ¥ï¼Œåªæ˜¯ä¿ç•™UI
      if (allAnalyzedData && allAnalyzedData.dates.length) {
        renderCharts(allAnalyzedData);
      }
    }

    // =========================================================
    // åˆ·æ–°æ•°æ®ï¼šä»æœ¬åœ° baby_log.csv é‡æ–°æ‹‰
    // =========================================================
    function refreshData() {
      var btn = document.querySelector('.refresh-btn');
      btn.classList.add('loading');
      fetch('./baby_log.csv', { cache: 'no-cache' })
        .then(function(r){ return r.text(); })
        .then(function(text){
          var csv = parseCSV(text);
          if (csv.length) {
            allAnalyzedData = analyzeData(csv);
            renderSummaries(allAnalyzedData);
            renderCharts(allAnalyzedData);
            document.getElementById('status').textContent = 'âœ… å·²åŠ è½½ baby_log.csv';
          } else {
            document.getElementById('status').textContent = 'âš ï¸ baby_log.csv æ²¡æœ‰æ•°æ®';
          }
        })
        .catch(function(err){
          console.error(err);
          document.getElementById('status').textContent = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ';
        })
        .finally(function(){
          btn.classList.remove('loading');
        });
    }

    // =========================================================
    // æ‰‹åŠ¨ä¸Šä¼  CSV
    // =========================================================
    document.getElementById('csvFile').addEventListener('change', function(e){
      var file = e.target.files[0];
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function(evt){
        var text = evt.target.result;
        var csv = parseCSV(text);
        if (csv.length) {
          allAnalyzedData = analyzeData(csv);
          renderSummaries(allAnalyzedData);
          renderCharts(allAnalyzedData);
          document.getElementById('status').textContent = 'âœ… æˆåŠŸè¯»å– ' + file.name;
        } else {
          document.getElementById('status').textContent = 'âš ï¸ æ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®';
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // =========================================================
    // AI é¢æ¿ï¼ˆå ä½ï¼Œæ–¹ä¾¿ä½ æ¥ä½ è‡ªå·±çš„åå°ï¼‰
    // =========================================================
    function openChatPanel() {
      document.getElementById('chatPanel').classList.add('show');
    }
    function closeChatPanel() {
      document.getElementById('chatPanel').classList.remove('show');
    }
    function sendMessage() {
      var input = document.getElementById('chatInput');
      var msg = input.value.trim();
      if (!msg) return;
      var box = document.getElementById('chatMessages');
      var me = document.createElement('div');
      me.className = 'chat-message user';
      me.textContent = msg;
      box.appendChild(me);

      // ç®€å•å›å¤
      var reply = document.createElement('div');
      reply.className = 'chat-message assistant';
      reply.textContent = 'æˆ‘æ”¶åˆ°äº†ï¼š' + msg + 'ï¼ˆè¿™é‡Œæ¥ä½ çš„ LLM å°±è¡Œï¼‰';
      box.appendChild(reply);
      box.scrollTop = box.scrollHeight;
      input.value = '';
    }

    // =========================================================
    // é¡µé¢åŠ è½½
    // =========================================================
    window.addEventListener('DOMContentLoaded', function(){
      // åˆå§‹åŒ–è®¾ç½®
      if (localStorage.getItem('birthDate')) {
        document.getElementById('birthDate').value = localStorage.getItem('birthDate');
      }
      document.getElementById('birthDate').addEventListener('change', function(e){
        localStorage.setItem('birthDate', e.target.value);
        updateBabyAge();
      });
      updateTitle();
      updateBabyAge();

      // å°è¯•è‡ªåŠ¨åŠ è½½åŒç›®å½•çš„ baby_log.csv
      refreshData();
    });
  </script>
</body>
</html>