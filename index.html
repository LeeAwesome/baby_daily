<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>å©´å„¿æŠ¤ç†æ•°æ®çœ‹æ¿</title>
    <script id="chartjs-bootstrap">
    (function () {
      try {
        var code = localStorage.getItem('chartjs_3_9_1');
        if (code) {
          var s = document.createElement('script');
          s.text = code;
          document.head.appendChild(s);
          window.__CHARTJS_READY__ = true;
        } else {
          window.__CHARTJS_READY__ = false;
          window.__NEED_CHARTJS__ = true;
        }
      } catch (e) {
        window.__CHARTJS_READY__ = false;
        window.__NEED_CHARTJS__ = true;
      }
    })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            min-height: 100vh
        }

        .container {
            max-width: 600px;
            margin: 0 auto
        }

        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .2)
        }

        .file-input-container {
            background: rgba(255, 255, 255, .95);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .file-input-container input {
            display: none
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px
        }

        .status {
            margin-top: 10px;
            font-size: 12px;
            color: #666
        }

        .today-summary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .2);
            color: #fff
        }

        .today-summary h2 {
            font-size: 18px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 700
        }

        .today-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px
        }

        .today-card {
            background: rgba(255, 255, 255, .15);
            padding: 10px;
            border-radius: 8px
        }

        .today-card h3 {
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 700
        }

        .today-card .detail {
            font-size: 12px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between
        }

        .today-card .num {
            font-size: 16px;
            font-weight: 700
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px
        }

        .stat-card {
            background: rgba(255, 255, 255, .95);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea
        }

        .stat-card .unit {
            font-size: 12px;
            color: #999
        }

        .chart-container {
            background: rgba(255, 255, 255, .95);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center
        }

        canvas {
            max-height: 250px
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ‘¶ å©´å„¿æŠ¤ç†æ•°æ®çœ‹æ¿</h1>
        <div class="file-input-container"><label for="csvFile" class="file-label">ğŸ“ é€‰æ‹©CSVæ–‡ä»¶</label><input type="file"
                id="csvFile" accept=".csv">
            <div class="status" id="status">ç­‰å¾…é€‰æ‹©æ–‡ä»¶...</div>
        </div>
        <div class="file-input-container" id="chartjsPicker" style="display:none; margin-top:10px;">
          <label for="chartJsFile" class="file-label">ğŸ“¦ é€‰æ‹©Chart.jsï¼ˆé¦–æ¬¡ç¦»çº¿ä½¿ç”¨ï¼‰</label>
          <input type="file" id="chartJsFile" accept=".js">
          <div class="status" id="chartStatus">Chart.js æœªå°±ç»ªï¼ˆä»…éœ€é€‰æ‹©ä¸€æ¬¡ï¼Œéšåç¦»çº¿å¯ç”¨ï¼‰</div>
        </div>
        <div id="dataContainer" style="display:none">
            <div class="today-summary">
                <h2>ğŸ“‹ ä»Šæ—¥æ±‡æ€» <span id="todayDate"></span></h2>
                <div class="today-grid">
                    <div class="today-card">
                        <h3>ğŸ¼ å–‚å¥¶æƒ…å†µ</h3>
                        <div class="detail"><span>æ€»æ¬¡æ•°</span><span class="num" id="todayFeedingCount">-</span><span>
                                æ¬¡</span></div>
                        <div class="detail"><span>å¥¶ç²‰</span><span class="num" id="todayFormula">-</span><span> ml</span>
                        </div>
                        <div class="detail"><span>æ¯ä¹³</span><span class="num" id="todayBreast">-</span><span> åˆ†é’Ÿ</span>
                        </div>
                    </div>
                    <div class="today-card">
                        <h3>ğŸ˜´ ç¡çœ æƒ…å†µ</h3>
                        <div class="detail"><span>æ¬¡æ•°</span><span class="num" id="todaySleepCount">-</span><span>
                                æ¬¡</span></div>
                        <div class="detail"><span>æ€»æ—¶é•¿</span><span class="num" id="todaySleepTotal">-</span><span>
                                å°æ—¶</span></div>
                        <div class="detail"><span>æœ€é•¿</span><span class="num" id="todaySleepMax">-</span><span> å°æ—¶</span>
                        </div>
                    </div>
                </div>
                <div class="today-grid">
                    <div class="today-card">
                        <h3>ğŸŒ ç™½å¤© (6-20ç‚¹)</h3>
                        <div class="detail"><span>å–‚å¥¶</span><span class="num" id="todayDayFeeding">-</span><span>
                                æ¬¡</span></div>
                        <div class="detail"><span>ç¡çœ </span><span class="num" id="todayDaySleep">-</span><span> å°æ—¶</span>
                        </div>
                    </div>
                    <div class="today-card">
                        <h3>ğŸŒ™ å¤œé—´ (20-6ç‚¹)</h3>
                        <div class="detail"><span>å–‚å¥¶</span><span class="num" id="todayNightFeeding">-</span><span>
                                æ¬¡</span></div>
                        <div class="detail"><span>ç¡çœ </span><span class="num" id="todayNightSleep">-</span><span>
                                å°æ—¶</span></div>
                    </div>
                </div>
                <div id="todayOther" style="display:none" class="today-grid">
                    <div class="today-card" id="todayWeightCard" style="display:none">
                        <h3>âš–ï¸ ä½“é‡</h3>
                        <div class="num" id="todayWeight" style="text-align:center">-kg</div>
                    </div>
                    <div class="today-card" id="todayFoodCard" style="display:none">
                        <h3>ğŸ¥„ è¾…é£Ÿ</h3>
                        <div class="num" id="todayFood" style="text-align:center">-æ¬¡</div>
                    </div>
                    <div class="today-card" id="todayPoopCard" style="display:none">
                        <h3>ğŸ’© å¤§ä¾¿</h3>
                        <div class="num" id="todayPoop" style="text-align:center">-æ¬¡</div>
                    </div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»å–‚å¥¶æ¬¡æ•°</h3>
                    <div class="value" id="totalFeeding">-</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <h3>æ—¥å‡ç¡çœ </h3>
                    <div class="value" id="avgDailySleep">-</div>
                    <div class="unit">å°æ—¶</div>
                </div>
                <div class="stat-card">
                    <h3>æ—¥å‡å¥¶ç²‰</h3>
                    <div class="value" id="avgFormula">-</div>
                    <div class="unit">ml</div>
                </div>
                <div class="stat-card">
                    <h3>å½“å‰ä½“é‡</h3>
                    <div class="value" id="currentWeight">-</div>
                    <div class="unit">kg</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ“Š æ¯æ—¥å–‚å¥¶æ¬¡æ•°</div><canvas id="feedingChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸŒ“ æ˜¼å¤œå–‚å¥¶åˆ†å¸ƒ</div><canvas id="dayNightChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ˜´ ç¡çœ æ—¶é•¿(ç™½å¤©vså¤œé—´)</div><canvas id="sleepChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ å¥¶ç²‰ç”¨é‡è¶‹åŠ¿</div><canvas id="formulaChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">ğŸ¼ æ¯ä¹³æ—¶é•¿è¶‹åŠ¿</div><canvas id="breastChart"></canvas>
            </div>
        </div>
    </div>
    <script>
    (function(){
      function ensureChartUI(){
        var pick = document.getElementById('chartjsPicker');
        if (!pick) return;
        if (window.__CHARTJS_READY__) {
          pick.style.display = 'none';
          var st = document.getElementById('chartStatus');
          if (st) st.textContent = 'Chart.js å·²å°±ç»ªï¼ˆæ¥è‡ªæœ¬åœ°ç¼“å­˜ï¼‰';
        } else {
          pick.style.display = 'block';
        }
      }
      document.addEventListener('DOMContentLoaded', ensureChartUI);
      window.addEventListener('load', ensureChartUI);

      window.__injectChartFromLocalFile = function(file){
        var reader = new FileReader();
        reader.onload = function(ev){
          try{
            var code = ev.target.result || '';
            // ç®€å•æ ¡éªŒï¼Œé¿å…è¯¯é€‰æ–‡ä»¶
            if (code.indexOf('Chart=') === -1 && code.indexOf('class Chart') === -1 && code.indexOf('Chart.version') === -1) {
              var st1 = document.getElementById('chartStatus');
              if (st1) st1.textContent = 'é€‰æ‹©çš„æ–‡ä»¶ä¸åƒæ˜¯ Chart.jsï¼Œä»å·²å°è¯•åŠ è½½â€¦';
            }
            localStorage.setItem('chartjs_3_9_1', code);
            var s = document.createElement('script');
            s.text = code;
            document.head.appendChild(s);
            window.__CHARTJS_READY__ = true;
            var st = document.getElementById('chartStatus');
            if (st) st.textContent = 'Chart.js å·²åŠ è½½å¹¶ç¼“å­˜ï¼ˆç¦»çº¿å¯ç”¨ï¼‰';
            var pick = document.getElementById('chartjsPicker');
            if (pick) pick.style.display = 'none';
          }catch(err){
            var st2 = document.getElementById('chartStatus');
            if (st2) st2.textContent = 'åŠ è½½å¤±è´¥ï¼š' + err.message;
          }
        };
        reader.onerror = function(){
          var st3 = document.getElementById('chartStatus');
          if (st3) st3.textContent = 'è¯»å–å¤±è´¥';
        };
        reader.readAsText(file, 'UTF-8');
      };

      document.addEventListener('change', function(e){
        if (e.target && e.target.id === 'chartJsFile' && e.target.files && e.target.files[0]) {
          __injectChartFromLocalFile(e.target.files[0]);
        }
      });
    })();
    let charts = {}; function parseCSV(text) { const lines = text.trim().split('\n'); if (lines.length < 2) return []; const firstLine = lines[0]; const delimiter = firstLine.includes(',') && !firstLine.includes('\t') ? ',' : '\t'; const headers = firstLine.split(delimiter).map(h => h.trim()); const data = []; for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (!line) continue; const cols = line.split(delimiter); const row = {}; let hasData = false; headers.forEach((header, idx) => { row[header] = (cols[idx] || '').trim(); if (row[header] && header === 'timestamp') hasData = true }); if (hasData) data.push(row) } return data } function getHour(timestamp) { return parseInt(timestamp.split(' ')[1].split(':')[0]) } function isDay(hour) { return hour >= 6 && hour < 20 } function analyzeData(csvData) { const dailyStats = {}; let latestWeight = null; let todayStats = null; const today = new Date().toISOString().split('T')[0]; csvData.forEach(row => { const timestamp = (row.timestamp || '').trim().replace(/\s+/g, ' '); if (!timestamp || !/\d{4}-\d{2}-\d{2}/.test(timestamp)) return; const date = timestamp.split(' ')[0]; const shortDate = date.substring(5); const hour = getHour(timestamp); const isDayTime = isDay(hour); if (!dailyStats[shortDate]) { dailyStats[shortDate] = { æ¯ä¹³: 0, æ¯ä¹³æ—¶é•¿: 0, å¥¶ç²‰: 0, å¥¶ç²‰é‡: 0, ç¡çœ : [], è¾…é£Ÿ: 0, å¤§ä¾¿: 0, ç™½å¤©å–‚å¥¶: 0, å¤œé—´å–‚å¥¶: 0, ç™½å¤©ç¡çœ : 0, å¤œé—´ç¡çœ : 0, ä½“é‡: null } } const s = dailyStats[shortDate]; const type = (row.event_type || '').trim(); const sub = (row.subtype || '').trim(); const val = parseFloat(row.value || '0') || 0; const pair = (row.pair_key || '').trim(); if (type === 'å–‚å¥¶') { if (sub === 'æ¯ä¹³') { s.æ¯ä¹³++; if (val > 0) s.æ¯ä¹³æ—¶é•¿ += val; if (isDayTime) s.ç™½å¤©å–‚å¥¶++; else s.å¤œé—´å–‚å¥¶++ } else if (sub === 'å¥¶ç²‰') { s.å¥¶ç²‰++; if (val > 0) s.å¥¶ç²‰é‡ += val; if (isDayTime) s.ç™½å¤©å–‚å¥¶++; else s.å¤œé—´å–‚å¥¶++ } } else if (type === 'ç¡è§‰' && sub === 'ç»“æŸ' && pair) { try { const start = new Date(pair.replace(' ', 'T')); const end = new Date(timestamp.replace(' ', 'T')); if (!isNaN(start.getTime()) && !isNaN(end.getTime())) { const h = (end - start) / 3600000; if (h > 0 && h < 24) { s.ç¡çœ .push(h); const sh = getHour(pair); if (isDay(sh)) s.ç™½å¤©ç¡çœ  += h; else s.å¤œé—´ç¡çœ  += h } } } catch (e) { } } else if (type === 'ä½“é‡' && val > 0) { s.ä½“é‡ = val; latestWeight = val } else if (type === 'è¾…é£Ÿ') s.è¾…é£Ÿ++; else if (type === 'æ¢å°¿å¸ƒ' && sub === 'å¤§ä¾¿') s.å¤§ä¾¿++; if (date === today) todayStats = s }); const dates = Object.keys(dailyStats).sort(); const result = {}; dates.forEach(d => { const s = dailyStats[d]; const total = s.ç¡çœ .reduce((a, b) => a + b, 0); result[d] = { æ¯ä¹³: s.æ¯ä¹³, æ¯ä¹³æ—¶é•¿: s.æ¯ä¹³æ—¶é•¿, å¥¶ç²‰: s.å¥¶ç²‰, å¥¶ç²‰é‡: Math.round(s.å¥¶ç²‰é‡), ç¡çœ : Math.round(total * 10) / 10, ç¡çœ æ¬¡æ•°: s.ç¡çœ .length, æœ€é•¿ç¡çœ : s.ç¡çœ .length > 0 ? Math.max(...s.ç¡çœ ).toFixed(1) : 0, è¾…é£Ÿ: s.è¾…é£Ÿ, å¤§ä¾¿: s.å¤§ä¾¿, ç™½å¤©å–‚å¥¶: s.ç™½å¤©å–‚å¥¶, å¤œé—´å–‚å¥¶: s.å¤œé—´å–‚å¥¶, ç™½å¤©ç¡çœ : Math.round(s.ç™½å¤©ç¡çœ  * 10) / 10, å¤œé—´ç¡çœ : Math.round(s.å¤œé—´ç¡çœ  * 10) / 10, ä½“é‡: s.ä½“é‡ } }); return { data: result, dates: dates, weight: latestWeight, todayData: todayStats ? { ...todayStats, ç¡çœ æ€»: todayStats.ç¡çœ .reduce((a, b) => a + b, 0), æœ€é•¿: todayStats.ç¡çœ .length > 0 ? Math.max(...todayStats.ç¡çœ ) : 0 } : null } } function renderToday(td) { if (!td) { document.querySelector('.today-summary').style.display = 'none'; return } const now = new Date(); document.getElementById('todayDate').textContent = `(${now.getMonth() + 1}/${now.getDate()})`; document.getElementById('todayFeedingCount').textContent = td.æ¯ä¹³ + td.å¥¶ç²‰; document.getElementById('todayFormula').textContent = Math.round(td.å¥¶ç²‰é‡); document.getElementById('todayBreast').textContent = Math.round(td.æ¯ä¹³æ—¶é•¿); document.getElementById('todaySleepCount').textContent = td.ç¡çœ .length; document.getElementById('todaySleepTotal').textContent = td.ç¡çœ æ€».toFixed(1); document.getElementById('todaySleepMax').textContent = td.æœ€é•¿.toFixed(1); document.getElementById('todayDayFeeding').textContent = td.ç™½å¤©å–‚å¥¶; document.getElementById('todayDaySleep').textContent = td.ç™½å¤©ç¡çœ .toFixed(1); document.getElementById('todayNightFeeding').textContent = td.å¤œé—´å–‚å¥¶; document.getElementById('todayNightSleep').textContent = td.å¤œé—´ç¡çœ .toFixed(1); let hasOther = false; if (td.ä½“é‡) { document.getElementById('todayWeightCard').style.display = 'block'; document.getElementById('todayWeight').textContent = td.ä½“é‡; hasOther = true } if (td.è¾…é£Ÿ > 0) { document.getElementById('todayFoodCard').style.display = 'block'; document.getElementById('todayFood').textContent = td.è¾…é£Ÿ; hasOther = true } if (td.å¤§ä¾¿ > 0) { document.getElementById('todayPoopCard').style.display = 'block'; document.getElementById('todayPoop').textContent = td.å¤§ä¾¿; hasOther = true } if (hasOther) document.getElementById('todayOther').style.display = 'grid' }
    function renderCharts(analyzed) {
      if (typeof Chart === 'undefined') {
        const st = document.getElementById('status');
        if (st) st.textContent = 'âš ï¸ Chart.js æœªåŠ è½½ï¼šè¯·å…ˆç‚¹å‡»â€œé€‰æ‹©Chart.jsï¼ˆé¦–æ¬¡ç¦»çº¿ä½¿ç”¨ï¼‰â€å¯¼å…¥ chart.min.jsã€‚';
        return;
      }
      const { data, dates, weight, todayData } = analyzed; if (dates.length === 0) { document.getElementById('status').textContent = 'âŒ æ²¡æœ‰æ•°æ®'; return } document.getElementById('dataContainer').style.display = 'block'; renderToday(todayData); const totalB = dates.reduce((s, d) => s + data[d].æ¯ä¹³, 0); const totalF = dates.reduce((s, d) => s + data[d].å¥¶ç²‰, 0); const totalS = dates.reduce((s, d) => s + data[d].ç¡çœ , 0); const totalFA = dates.reduce((s, d) => s + data[d].å¥¶ç²‰é‡, 0); document.getElementById('totalFeeding').textContent = totalB + totalF; document.getElementById('avgDailySleep').textContent = (totalS / dates.length).toFixed(1); document.getElementById('avgFormula').textContent = Math.round(totalFA / dates.length); document.getElementById('currentWeight').textContent = weight || '-'; Chart.defaults.font.size = 12; if (charts.f) charts.f.destroy(); charts.f = new Chart(document.getElementById('feedingChart'), { type: 'bar', data: { labels: dates, datasets: [{ label: 'æ¯ä¹³(æ¬¡)', data: dates.map(d => data[d].æ¯ä¹³), backgroundColor: 'rgba(255,159,64,0.8)' }, { label: 'å¥¶ç²‰(æ¬¡)', data: dates.map(d => data[d].å¥¶ç²‰), backgroundColor: 'rgba(54,162,235,0.8)' }] }, options: { responsive: !0, scales: { y: { beginAtZero: !0 } } } }); if (charts.dn) charts.dn.destroy(); charts.dn = new Chart(document.getElementById('dayNightChart'), { type: 'bar', data: { labels: dates, datasets: [{ label: 'ç™½å¤©', data: dates.map(d => data[d].ç™½å¤©å–‚å¥¶), backgroundColor: 'rgba(255,206,86,0.8)' }, { label: 'å¤œé—´', data: dates.map(d => data[d].å¤œé—´å–‚å¥¶), backgroundColor: 'rgba(75,192,192,0.8)' }] }, options: { responsive: !0, scales: { y: { beginAtZero: !0 } } } }); if (charts.s) charts.s.destroy(); charts.s = new Chart(document.getElementById('sleepChart'), { type: 'bar', data: { labels: dates, datasets: [{ label: 'ç™½å¤©(h)', data: dates.map(d => data[d].ç™½å¤©ç¡çœ ), backgroundColor: 'rgba(255,206,86,0.8)' }, { label: 'å¤œé—´(h)', data: dates.map(d => data[d].å¤œé—´ç¡çœ ), backgroundColor: 'rgba(153,102,255,0.8)' }] }, options: { responsive: !0, scales: { y: { beginAtZero: !0, stacked: !0 }, x: { stacked: !0 } } } }); if (charts.fm) charts.fm.destroy(); charts.fm = new Chart(document.getElementById('formulaChart'), { type: 'line', data: { labels: dates, datasets: [{ label: 'å¥¶ç²‰(ml)', data: dates.map(d => data[d].å¥¶ç²‰é‡), borderColor: 'rgba(54,162,235,1)', backgroundColor: 'rgba(54,162,235,0.2)', fill: !0, tension: .4 }] }, options: { responsive: !0, scales: { y: { beginAtZero: !0 } } } }); if (charts.b) charts.b.destroy(); charts.b = new Chart(document.getElementById('breastChart'), { type: 'line', data: { labels: dates, datasets: [{ label: 'æ¯ä¹³(åˆ†é’Ÿ)', data: dates.map(d => data[d].æ¯ä¹³æ—¶é•¿), borderColor: 'rgba(255,159,64,1)', backgroundColor: 'rgba(255,159,64,0.2)', fill: !0, tension: .4 }] }, options: { responsive: !0, scales: { y: { beginAtZero: !0 } } } }); document.getElementById('status').textContent = 'âœ… åŠ è½½æˆåŠŸ'
    }
    document.getElementById('csvFile').addEventListener('change', function (e) { const file = e.target.files[0]; if (!file) return; document.getElementById('status').textContent = 'è¯»å–ä¸­...'; const reader = new FileReader(); reader.onload = function (ev) { try { const csv = parseCSV(ev.target.result); if (csv.length === 0) { document.getElementById('status').textContent = 'âŒ æ— æ•°æ®'; return } const analyzed = analyzeData(csv); renderCharts(analyzed) } catch (err) { document.getElementById('status').textContent = 'âŒ é”™è¯¯:' + err.message } }; reader.onerror = function () { document.getElementById('status').textContent = 'âŒ è¯»å–å¤±è´¥' }; reader.readAsText(file, 'UTF-8') })
    </script>
</body>

</html>