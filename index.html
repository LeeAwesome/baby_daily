<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ÂÆùÂÆùÊó•Â∏∏ÁîüÊ¥ªÊó•Âøó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            min-height: 100vh
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5px
        }

        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            font-size: clamp(22px, 6vw, 32px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .2)
        }

        #babyAge {
            display: block;
            text-align: center;
            color: #fff;
            margin-bottom: 15px;
            font-size: clamp(13px, 3.5vw, 16px)
        }

        .file-input-container {
            background: rgba(255, 255, 255, .95);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: #667eea;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            padding: 5px;
            text-decoration: underline
        }

        #fileDetails {
            margin-top: 12px
        }

        .birth-date-input {
            margin: 12px 0;
            text-align: center;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center
        }

        .birth-date-input label {
            color: #667eea;
            font-weight: 600;
            font-size: 14px
        }

        .birth-date-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(13px, 3vw, 15px);
            font-weight: 600;
            margin-top: 10px
        }

        .file-input-container input[type="file"] {
            display: none
        }

        .status {
            margin-top: 10px;
            font-size: clamp(11px, 2.5vw, 13px);
            color: #666
        }

        .today-summary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .2);
            color: #fff
        }

        .yesterday-summary {
            background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .2);
            color: #fff
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .summary-header h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 0;
            font-weight: 700;
            flex: 1;
        }

        .toggle-icon {
            font-size: clamp(18px, 4vw, 24px);
            transition: transform 0.3s;
            margin-left: 10px;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .summary-content {
            margin-top: 12px;
            overflow: hidden;
            transition: all 0.3s ease-out;
            max-height: 2000px;
        }

        .summary-content.collapsed {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }

        .today-summary h2 {
            font-size: clamp(16px, 4vw, 20px);
            margin-bottom: 12px;
            text-align: center;
            font-weight: 700
        }

        .today-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px
        }

        .today-card {
            background: rgba(255, 255, 255, .15);
            padding: clamp(10px, 2.5vw, 14px);
            border-radius: 8px;
            min-width: 0
        }

        .today-card h3 {
            font-size: clamp(13px, 3.5vw, 16px);
            margin-bottom: 8px;
            font-weight: 700
        }

        .today-card .detail {
            font-size: clamp(12px, 3vw, 14px);
            margin: 5px 0;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 5px;
            align-items: center
        }

        .today-card .num {
            font-size: clamp(15px, 4vw, 19px);
            font-weight: 700
        }

        .latest-record {
            font-size: clamp(11px, 2.5vw, 13px);
            color: rgba(255, 255, 255, .85);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, .2);
            word-break: break-word
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px
        }

        .stat-card {
            background: rgba(255, 255, 255, .95);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            min-width: 0
        }

        .stat-card h3 {
            font-size: clamp(13px, 3vw, 15px);
            color: #666;
            margin-bottom: 8px
        }

        .stat-card .value {
            font-size: clamp(22px, 5vw, 32px);
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px
        }

        .stat-card .label {
            font-size: clamp(11px, 2.5vw, 13px);
            color: #999
        }

        .chart-container {
            background: rgba(255, 255, 255, .95);
            padding: clamp(12px, 3vw, 18px);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px
        }

        .chart-title {
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: 700;
            color: #333
        }

        .time-dimension {
            display: flex;
            gap: 8px
        }

        .time-dimension button {
            padding: 6px 12px;
            border: 1px solid #667eea;
            background: #fff;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(11px, 2.5vw, 13px);
            transition: all .2s
        }

        .time-dimension button.active {
            background: #667eea;
            color: #fff
        }

        .time-dimension button:hover {
            background: #667eea;
            color: #fff
        }

        canvas {
            max-height: 300px
        }

        @media (max-width: 600px) {
            .chart-header {
                flex-direction: column;
                align-items: flex-start
            }
        }

        .hidden {
            display: none
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä ÂÆùÂÆùÊó•Â∏∏ÁîüÊ¥ªÊó•Âøó</h1>
        <span id="babyAge">Ê≠£Âú®ËÆ°ÁÆó...</span>

        <div id="fileContainer" class="file-input-container">
            <button id="toggleBtn" class="toggle-btn" onclick="toggleFileSection()">üìÅ ÊâãÂä®‰∏ä‰º†CSVÔºàÁÇπÂáªÂ±ïÂºÄÔºâ</button>
            <div id="fileDetails" style="display:none">
                <div class="birth-date-input">
                    <label for="birthDate">üìÖ ÂÆùÂÆùÁîüÊó•Ôºö</label>
                    <input type="date" id="birthDate" value="2025-02-24">
                </div>
                <label class="file-label" for="csvFile">
                    üìÇ ÈÄâÊã©CSVÊñá‰ª∂
                    <input type="file" id="csvFile" accept=".csv">
                </label>
                <div class="status" id="status">Á≠âÂæÖ‰∏ä‰º†CSVÊñá‰ª∂</div>
            </div>
        </div>

        <div id="dataContainer" class="hidden">
            <!-- ‰ªäÊó•Ê±áÊÄª -->
            <div class="today-summary">
                <div class="summary-header">
                    <h2>üìÖ ‰ªäÊó•Ê±áÊÄª <span id="todayDate"></span></h2>
                </div>
                <div class="summary-content">
                    <div class="today-grid">
                        <div class="today-card" id="feedCard">
                            <h3>üçº ÂñÇÂ•∂ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>ÊÄªÊ¨°Êï∞</span>
                                <span id="todayFeedCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Â•∂Á≤â</span>
                                <span id="todayFormula" class="num">-</span>
                                <span>ml</span>
                            </div>
                            <div class="detail">
                                <span>ÊØç‰π≥</span>
                                <span id="todayBreast" class="num">-</span>
                                <span>ÂàÜÈíü</span>
                            </div>
                        </div>
                        <div class="today-card" id="sleepCard">
                            <h3>üò¥ Áù°Áú†ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todaySleepCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>ÊÄªÊó∂Èïø</span>
                                <span id="todaySleepTotal" class="num">-</span>
                                <span>h</span>
                            </div>
                            <div class="detail">
                                <span>ÊúÄÈïø</span>
                                <span id="todaySleepMax" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>‚òÄÔ∏è ÁôΩÂ§©</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="todayDayFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="todayDaySleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üåô Â§úÈó¥</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="todayNightFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="todayNightSleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                    </div>
                    <div id="todayOther" class="today-grid" style="display:none;">
                        <div class="today-card" id="weightCard" style="display:none">
                            <h3>‚öñÔ∏è ‰ΩìÈáç</h3>
                            <div class="detail">
                                <span>‰ªäÊó•</span>
                                <span id="todayWeight" class="num">-</span>
                                <span>kg</span>
                            </div>
                        </div>
                        <div class="today-card" id="foodCard" style="display:none">
                            <h3>üçΩÔ∏è ËæÖÈ£ü</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todayFood" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                        </div>
                        <div class="today-card" id="poopCard" style="display:none">
                            <h3>üí© Â§ß‰æø</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="todayPoop" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êò®Êó•Ê±áÊÄª -->
            <div class="yesterday-summary">
                <div class="summary-header" onclick="toggleYesterday()">
                    <h2>üìÜ Êò®Êó•Ê±áÊÄª <span id="yesterdayDate"></span></h2>
                    <span class="toggle-icon" id="yesterdayToggle">‚ñº</span>
                </div>
                <div class="summary-content collapsed" id="yesterdayContent">
                    <div class="today-grid">
                        <div class="today-card">
                            <h3>üçº ÂñÇÂ•∂ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>ÊÄªÊ¨°Êï∞</span>
                                <span id="yesterdayFeedCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Â•∂Á≤â</span>
                                <span id="yesterdayFormula" class="num">-</span>
                                <span>ml</span>
                            </div>
                            <div class="detail">
                                <span>ÊØç‰π≥</span>
                                <span id="yesterdayBreast" class="num">-</span>
                                <span>ÂàÜÈíü</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üò¥ Áù°Áú†ÊÉÖÂÜµ</h3>
                            <div class="detail">
                                <span>Ê¨°Êï∞</span>
                                <span id="yesterdaySleepCount" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>ÊÄªÊó∂Èïø</span>
                                <span id="yesterdaySleepTotal" class="num">-</span>
                                <span>h</span>
                            </div>
                            <div class="detail">
                                <span>ÊúÄÈïø</span>
                                <span id="yesterdaySleepMax" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>‚òÄÔ∏è ÁôΩÂ§©</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="yesterdayDayFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="yesterdayDaySleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                        <div class="today-card">
                            <h3>üåô Â§úÈó¥</h3>
                            <div class="detail">
                                <span>ÂñÇÂ•∂</span>
                                <span id="yesterdayNightFeed" class="num">-</span>
                                <span>Ê¨°</span>
                            </div>
                            <div class="detail">
                                <span>Áù°Áú†</span>
                                <span id="yesterdayNightSleep" class="num">-</span>
                                <span>h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üí§ Âπ≥ÂùáÁù°Áú†</h3>
                    <div class="value"><span id="avgSleep">-</span> h</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>üçº Âπ≥ÂùáÂ•∂Á≤â</h3>
                    <div class="value"><span id="avgFormula">-</span> ml</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>üë∂ Âπ≥ÂùáÊØç‰π≥</h3>
                    <div class="value"><span id="avgBreast">-</span> min</div>
                    <div class="label">ÊØèÊó•</div>
                </div>
                <div class="stat-card">
                    <h3>‚öñÔ∏è ÂΩìÂâç‰ΩìÈáç</h3>
                    <div class="value"><span id="currentWeight">-</span> kg</div>
                    <div class="label">ÊúÄËøëËÆ∞ÂΩï</div>
                </div>
                <div class="stat-card">
                    <h3>üçº ÂñÇÂ•∂Èó¥Èöî</h3>
                    <div class="value"><span id="avgFeedInterval">-</span> h</div>
                    <div class="label">Âπ≥Âùá</div>
                </div>
                <div class="stat-card">
                    <h3>üí§ Áù°Áú†Èó¥Èöî</h3>
                    <div class="value"><span id="avgSleepInterval">-</span> h</div>
                    <div class="label">Âπ≥Âùá</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÂñÇÂ•∂Ê¨°Êï∞ÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedCount', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedCount', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedCount', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="feedCountChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÊØèÊó•ÂñÇÂ•∂Èáè</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedAmount', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedAmount', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedAmount', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="feedAmountChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí§ Áù°Áú†Êó∂ÈïøÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'sleepDuration', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'sleepDuration', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'sleepDuration', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="sleepDurationChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí§ Áù°Áú†Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'sleepInterval', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'sleepInterval', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'sleepInterval', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="sleepIntervalChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üçº ÂñÇÂ•∂Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'feedInterval', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'feedInterval', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'feedInterval', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="feedIntervalChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">‚öñÔ∏è ‰ΩìÈáçÂèòÂåñ</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'weight', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'weight', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'weight', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="weightChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üí© Â§ß‰æøÊ¨°Êï∞</div>
                    <div class="time-dimension">
                        <button class="active" onclick="changeTimeDimension(this, 'poop', 'day')">Êó•</button>
                        <button onclick="changeTimeDimension(this, 'poop', 'week')">Âë®</button>
                        <button onclick="changeTimeDimension(this, 'poop', 'month')">Êúà</button>
                    </div>
                </div>
                <canvas id="poopChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Áªü‰∏ÄÁöÑÁôΩÂ§©/Â§úÈó¥È¢úËâ≤ÊñπÊ°à
        var COLORS = {
            DAY: 'rgba(255,206,86,0.8)',      // ÁôΩÂ§©Áªü‰∏ÄÈ¢úËâ≤ - ÈªÑËâ≤
            NIGHT: 'rgba(153,102,255,0.8)',   // Â§úÈó¥Áªü‰∏ÄÈ¢úËâ≤ - Á¥´Ëâ≤
            DAY_DARK: 'rgba(255,193,7,0.9)',  // ÁôΩÂ§©Ê∑±Ëâ≤ÔºàÊØç‰π≥Ôºâ
            DAY_LIGHT: 'rgba(255,235,59,0.7)', // ÁôΩÂ§©ÊµÖËâ≤ÔºàÂ•∂Á≤âÔºâ
            NIGHT_DARK: 'rgba(126,87,194,0.9)', // Â§úÈó¥Ê∑±Ëâ≤ÔºàÊØç‰π≥Ôºâ
            NIGHT_LIGHT: 'rgba(179,157,219,0.7)' // Â§úÈó¥ÊµÖËâ≤ÔºàÂ•∂Á≤âÔºâ
        };
        
        var charts = {};
        var allAnalyzedData = {};

        function toggleFileSection() {
            var details = document.getElementById('fileDetails');
            var btn = document.getElementById('toggleBtn');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                btn.textContent = 'üìÅ Êî∂Ëµ∑';
            } else {
                details.style.display = 'none';
                btn.textContent = 'üìÅ ÊâãÂä®‰∏ä‰º†CSVÔºàÁÇπÂáªÂ±ïÂºÄÔºâ';
            }
        }

        function toggleYesterday() {
            var content = document.getElementById('yesterdayContent');
            var icon = document.getElementById('yesterdayToggle');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                icon.textContent = '‚ñ∂';
            }
        }

        function calculateAndDisplayAge() {
            var birthDateStr = document.getElementById('birthDate').value;
            if (!birthDateStr) return;
            var birthDate = new Date(birthDateStr);
            var today = new Date();
            var months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
            var days = today.getDate() - birthDate.getDate();
            if (days < 0) {
                months--;
                var lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                days = lastMonth.getDate() - birthDate.getDate() + today.getDate();
            }
            document.getElementById('babyAge').textContent = 'ÂÆùÂÆùÂ∑≤Áªè ' + months + ' ‰∏™Êúà ' + days + ' Â§©‰∫Ü üéâ';
        }

        function parseCSV(text) {
            var lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            var headers = lines[0].split(',').map(function (h) { return h.trim(); });
            var data = [];
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                var cols = line.split(',');
                var row = {};
                for (var j = 0; j < headers.length; j++) {
                    row[headers[j]] = cols[j] ? cols[j].trim() : '';
                }
                if (row.timestamp) data.push(row);
            }
            return data;
        }

        // Âà§Êñ≠Êó∂Èó¥Â∫îËØ•ÂΩíÂ±ûÂì™‰∏ÄÂ§©ÔºàÊôö‰∏ä8ÁÇπÂà∞Ê¨°Êó•Êó©‰∏ä6ÁÇπÂΩíÂâç‰∏ÄÂ§©Ôºâ
        function getClassifyDate(timestamp) {
            var date = timestamp.split(' ')[0];
            var hour = parseInt(timestamp.split(' ')[1].split(':')[0]);
            var classifyDate = new Date(date + 'T00:00:00');
            
            // Êôö‰∏ä8ÁÇπ(20:00)Âà∞Ê¨°Êó•Êó©‰∏ä6ÁÇπÂΩíÂâç‰∏ÄÂ§©
            if (hour < 6 || hour >= 20) {
                if (hour < 6) {
                    classifyDate.setDate(classifyDate.getDate() - 1);
                }
            }
            
            var classifyFullDate = classifyDate.getFullYear() + '-' + 
                                  String(classifyDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                  String(classifyDate.getDate()).padStart(2, '0');
            return {
                fullDate: classifyFullDate,
                shortDate: classifyFullDate.substring(5)
            };
        }

        function analyzeData(csvData) {
            var dailyStats = {};
            var today = new Date().toISOString().split('T')[0];
            var latestRecords = {};
            var todayData = null;
            var latestWeight = null;

            csvData.forEach(function (row) {
                var ts = row.timestamp.trim();
                if (!ts || !/\d{4}-\d{2}-\d{2}/.test(ts)) return;

                var date = ts.split(' ')[0];
                var hour = parseInt(ts.split(' ')[1].split(':')[0]);
                // Â§úÈó¥Êó∂ÊÆµÔºö20:00-06:00
                var isNight = hour >= 20 || hour < 6;

                var type = row.event_type.trim();
                var sub = row.subtype.trim();
                var val = parseFloat(row.value) || 0;

                // Â§ÑÁêÜÁù°Áú†ÔºàÁâπÊÆäÂ§ÑÁêÜÔºåÂõ†‰∏∫ÂÆÉÊúâpair_keyÔºâ
                if (type === 'Áù°Ëßâ' && sub === 'ÁªìÊùü' && row.pair_key) {
                    try {
                        var start = new Date(row.pair_key.replace(' ', 'T'));
                        var end = new Date(ts.replace(' ', 'T'));
                        var h = (end - start) / 3600000;
                        if (h > 0 && h < 24) {
                            var startHour = parseInt(row.pair_key.split(' ')[1].split(':')[0]);
                            var startMinute = parseInt(row.pair_key.split(' ')[1].split(':')[1]);
                            var endHour = parseInt(ts.split(' ')[1].split(':')[0]);
                            var endMinute = parseInt(ts.split(' ')[1].split(':')[1]);
                            
                            // Ê†πÊçÆÂºÄÂßãÊó∂Èó¥Âà§Êñ≠ÂΩíÂ±ûÊó•Êúü
                            var classified = getClassifyDate(row.pair_key);
                            
                            if (!dailyStats[classified.shortDate]) {
                                dailyStats[classified.shortDate] = {
                                    fullDate: classified.fullDate,
                                    milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                                    sleep: [], food: 0, poop: 0,
                                    dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                                    dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                                    feedTimes: [], sleepEndTimes: []
                                };
                            }
                            
                            var s = dailyStats[classified.shortDate];
                            s.sleep.push(h);
                            s.sleepEndTimes.push(end);
                            
                            // ËÆ°ÁÆóÁôΩÂ§©ÂíåÂ§úÈó¥ÁöÑÈáçÂè†Êó∂Èó¥
                            // ËæπÁïåÊó∂Èó¥Ôºö6:00 Âíå 20:00
                            var startDecimal = startHour + startMinute / 60;
                            var endDecimal = endHour + endMinute / 60;
                            
                            var daySleepHours = 0;
                            var nightSleepHours = 0;
                            
                            // Â¶ÇÊûúË∑®Â§©ÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                            if (end.getDate() !== start.getDate()) {
                                // Ë∑®Â§©ÊÉÖÂÜµÔºöËÆ°ÁÆóÁ¨¨‰∏ÄÂ§©ÁöÑÈÉ®ÂàÜ
                                if (startDecimal >= 6 && startDecimal < 20) {
                                    // ÂºÄÂßãÂú®ÁôΩÂ§©
                                    daySleepHours += 20 - startDecimal;
                                    nightSleepHours += 24 - 20; // 20:00Âà∞24:00
                                } else if (startDecimal >= 20) {
                                    // ÂºÄÂßãÂú®Êôö‰∏ä
                                    nightSleepHours += 24 - startDecimal;
                                } else {
                                    // ÂºÄÂßãÂú®ÂáåÊô®
                                    nightSleepHours += 6 - startDecimal;
                                    daySleepHours += 20 - 6; // ÂÆåÊï¥ÁôΩÂ§©
                                    nightSleepHours += 24 - 20; // 20:00Âà∞24:00
                                }
                                
                                // ËÆ°ÁÆóÁ¨¨‰∫åÂ§©ÁöÑÈÉ®ÂàÜ
                                if (endDecimal >= 6 && endDecimal <= 20) {
                                    // ÁªìÊùüÂú®ÁôΩÂ§©
                                    nightSleepHours += 6; // 0:00Âà∞6:00
                                    daySleepHours += endDecimal - 6;
                                } else if (endDecimal < 6) {
                                    // ÁªìÊùüÂú®ÂáåÊô®
                                    nightSleepHours += endDecimal;
                                } else {
                                    // ÁªìÊùüÂú®Êôö‰∏ä
                                    nightSleepHours += 6;
                                    daySleepHours += 20 - 6;
                                    nightSleepHours += endDecimal - 20;
                                }
                            } else {
                                // Âêå‰∏ÄÂ§©ÂÜÖÁöÑÁù°Áú†
                                if (startDecimal >= 20 || endDecimal <= 6) {
                                    // ÂÆåÂÖ®Âú®Â§úÈó¥
                                    nightSleepHours = h;
                                } else if (startDecimal >= 6 && endDecimal <= 20) {
                                    // ÂÆåÂÖ®Âú®ÁôΩÂ§©
                                    daySleepHours = h;
                                } else if (startDecimal < 6 && endDecimal > 6 && endDecimal <= 20) {
                                    // Ë∑®Ë∂äÊó©‰∏ä6ÁÇπÔºöÂáåÊô® ‚Üí ÁôΩÂ§©
                                    nightSleepHours = 6 - startDecimal;
                                    daySleepHours = endDecimal - 6;
                                } else if (startDecimal >= 6 && startDecimal < 20 && endDecimal > 20) {
                                    // Ë∑®Ë∂äÊôö‰∏ä20ÁÇπÔºöÁôΩÂ§© ‚Üí Â§úÈó¥
                                    daySleepHours = 20 - startDecimal;
                                    nightSleepHours = endDecimal - 20;
                                } else if (startDecimal < 6 && endDecimal > 20) {
                                    // Ë∑®Ë∂ä‰∏§‰∏™ËæπÁïåÔºöÂáåÊô® ‚Üí ÁôΩÂ§© ‚Üí Â§úÈó¥
                                    nightSleepHours = 6 - startDecimal;
                                    daySleepHours = 20 - 6;
                                    nightSleepHours += endDecimal - 20;
                                }
                            }
                            
                            s.daySleep += daySleepHours;
                            s.nightSleep += nightSleepHours;
                            
                            // ‰ΩøÁî®ÁªìÊùüÊó∂Èó¥‰Ωú‰∏∫ÈÜíÊù•Êó∂Èó¥
                            if (classified.fullDate === today) {
                                latestRecords.sleep = { 
                                    t: ts.split(' ')[1],
                                    h: h.toFixed(1) 
                                };
                            }
                        }
                    } catch (e) { }
                    return; // Áù°Áú†Â§ÑÁêÜÂÆåÊØïÔºåË∑≥ËøáÂêéÈù¢ÁöÑÂ§ÑÁêÜ
                }

                // ÂÖ∂‰ªñ‰∫ã‰ª∂Á±ªÂûãÊ†πÊçÆÊó∂Èó¥Êà≥Âà§Êñ≠ÂΩíÂ±ûÊó•Êúü
                var classified = getClassifyDate(ts);
                var shortDate = classified.shortDate;

                if (!dailyStats[shortDate]) {
                    dailyStats[shortDate] = {
                        fullDate: classified.fullDate,
                        milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                        sleep: [], food: 0, poop: 0,
                        dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                        dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                        feedTimes: [], sleepEndTimes: []
                    };
                }

                var s = dailyStats[shortDate];

                if (type === 'ÂñÇÂ•∂') {
                    if (sub === 'ÊØç‰π≥' || sub === 'Â•∂Á≤â') {
                        s.feedTimes.push(new Date(ts.replace(' ', 'T')));
                    }
                    if (sub === 'ÊØç‰π≥') {
                        s.milk++;
                        if (val > 0) s.milkMin += val;
                        if (isNight) {
                            s.nightFeed++;
                            s.nightMilk++;
                        } else {
                            s.dayFeed++;
                            s.dayMilk++;
                        }
                        if (classified.fullDate === today) latestRecords.milk = { t: ts.split(' ')[1], v: val };
                    } else if (sub === 'Â•∂Á≤â') {
                        s.formula++;
                        if (val > 0) s.formulaMl += val;
                        if (isNight) {
                            s.nightFeed++;
                            s.nightFormula++;
                        } else {
                            s.dayFeed++;
                            s.dayFormula++;
                        }
                        if (classified.fullDate === today) latestRecords.formula = { t: ts.split(' ')[1], v: val };
                    }
                } else if (type === '‰ΩìÈáç' && val > 0) {
                    s.weight = val;
                    latestWeight = val;
                    if (classified.fullDate === today) latestRecords.weight = { t: ts.split(' ')[1], v: val };
                } else if (type === 'ËæÖÈ£ü') {
                    s.food++;
                    if (classified.fullDate === today) {
                        if (!latestRecords.foods) latestRecords.foods = [];
                        var foodDesc = sub || '';
                        if (row.notes && row.notes.trim()) foodDesc += (foodDesc ? ' - ' : '') + row.notes.trim();
                        latestRecords.foods.push({ t: ts.split(' ')[1], desc: foodDesc || '(Êó†ÊèèËø∞)' });
                    }
                } else if (type === 'Êç¢Â∞øÂ∏É' && sub === 'Â§ß‰æø') {
                    s.poop++;
                    if (classified.fullDate === today) latestRecords.poop = { t: ts.split(' ')[1] };
                }

                if (classified.fullDate === today) todayData = s;
            });

            var dates = Object.keys(dailyStats).sort();
            var result = {};
            dates.forEach(function (d) {
                var s = dailyStats[d];
                var total = s.sleep.reduce(function (a, b) { return a + b; }, 0);
                
                var feedIntervals = [];
                for (var i = 1; i < s.feedTimes.length; i++) {
                    var interval = (s.feedTimes[i] - s.feedTimes[i-1]) / 3600000;
                    // ËøáÊª§ÊéâË¥üÊï∞ÂíåÂºÇÂ∏∏ÂÄºÔºà>24Â∞èÊó∂ÁöÑÈó¥ÈöîÂèØËÉΩÊòØË∑®Â§©Êï∞ÊçÆÈóÆÈ¢òÔºâ
                    if (interval > 0 && interval < 24) {
                        var hour = s.feedTimes[i-1].getHours();
                        var isNightInterval = hour >= 20 || hour < 6;
                        feedIntervals.push({ value: interval, isDay: !isNightInterval });
                    }
                }
                
                var sleepIntervals = [];
                for (var i = 1; i < s.sleepEndTimes.length; i++) {
                    var interval = (s.sleepEndTimes[i] - s.sleepEndTimes[i-1]) / 3600000;
                    // ËøáÊª§ÊéâË¥üÊï∞ÂíåÂºÇÂ∏∏ÂÄº
                    if (interval > 0 && interval < 24) {
                        var hour = s.sleepEndTimes[i-1].getHours();
                        var isNightInterval = hour >= 20 || hour < 6;
                        sleepIntervals.push({ value: interval, isDay: !isNightInterval });
                    }
                }

                result[d] = {
                    fullDate: s.fullDate,
                    milk: s.milk, milkMin: s.milkMin, formula: s.formula, formulaMl: s.formulaMl,
                    sleep: Math.round(total * 10) / 10, sleepCnt: s.sleep.length,
                    maxSleep: s.sleep.length > 0 ? Math.max.apply(null, s.sleep).toFixed(1) : 0,
                    food: s.food, poop: s.poop,
                    dayFeed: s.dayFeed, nightFeed: s.nightFeed,
                    dayMilk: s.dayMilk, nightMilk: s.nightMilk,
                    dayFormula: s.dayFormula, nightFormula: s.nightFormula,
                    daySleep: Math.round(s.daySleep * 10) / 10, nightSleep: Math.round(s.nightSleep * 10) / 10,
                    weight: s.weight,
                    feedIntervals: feedIntervals,
                    sleepIntervals: sleepIntervals
                };
            });

            return {
                data: result, dates: dates, weight: latestWeight,
                latest: latestRecords,
                today: todayData ? {
                    milk: todayData.milk, milkMin: todayData.milkMin,
                    formula: todayData.formula, formulaMl: todayData.formulaMl,
                    sleep: todayData.sleep,
                    sleepTotal: todayData.sleep.reduce(function (a, b) { return a + b; }, 0),
                    maxSleep: todayData.sleep.length > 0 ? Math.max.apply(null, todayData.sleep) : 0,
                    dayFeed: todayData.dayFeed, nightFeed: todayData.nightFeed,
                    daySleep: todayData.daySleep, nightSleep: todayData.nightSleep,
                    food: todayData.food, poop: todayData.poop, weight: todayData.weight
                } : null,
                yesterday: (function() {
                    var yd = new Date();
                    yd.setDate(yd.getDate() - 1);
                    var yesterdayKey = String(yd.getMonth() + 1).padStart(2, '0') + '-' + String(yd.getDate()).padStart(2, '0');
                    return result[yesterdayKey] || null;
                })(),
                foods: latestRecords.foods || []
            };
        }

        function aggregateByDimension(data, dimension) {
            var result = {};
            if (dimension === 'day') {
                return data.data;
            } else if (dimension === 'week') {
                data.dates.forEach(function (d) {
                    var fullDate = data.data[d].fullDate;
                    var dateObj = new Date(fullDate);
                    var year = dateObj.getFullYear();
                    var firstDayOfYear = new Date(year, 0, 1);
                    var pastDaysOfYear = (dateObj - firstDayOfYear) / 86400000;
                    var weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                    var weekKey = year + '-W' + String(weekNumber).padStart(2, '0');
                    if (!result[weekKey]) {
                        result[weekKey] = {
                            fullDate: weekKey,
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            food: 0, poop: 0,
                            dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                            dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                            feedIntervals: [], sleepIntervals: [], count: 0
                        };
                    }
                    var w = result[weekKey];
                    var s = data.data[d];
                    w.milk += s.milk;
                    w.milkMin += s.milkMin;
                    w.formula += s.formula;
                    w.formulaMl += s.formulaMl;
                    w.sleep += s.sleep;
                    w.sleepCnt += s.sleepCnt;
                    if (parseFloat(s.maxSleep) > parseFloat(w.maxSleep)) w.maxSleep = s.maxSleep;
                    w.food += s.food;
                    w.poop += s.poop;
                    w.dayFeed += s.dayFeed;
                    w.nightFeed += s.nightFeed;
                    w.dayMilk += s.dayMilk;
                    w.nightMilk += s.nightMilk;
                    w.dayFormula += s.dayFormula;
                    w.nightFormula += s.nightFormula;
                    w.daySleep += s.daySleep;
                    w.nightSleep += s.nightSleep;
                    if (s.weight) w.weight = s.weight;
                    w.feedIntervals = w.feedIntervals.concat(s.feedIntervals);
                    w.sleepIntervals = w.sleepIntervals.concat(s.sleepIntervals);
                    w.count++;
                });
                Object.keys(result).forEach(function (k) {
                    result[k].milk = Math.round(result[k].milk / result[k].count);
                    result[k].milkMin = Math.round(result[k].milkMin / result[k].count);
                    result[k].formula = Math.round(result[k].formula / result[k].count);
                    result[k].formulaMl = Math.round(result[k].formulaMl / result[k].count);
                    result[k].sleep = Math.round((result[k].sleep / result[k].count) * 10) / 10;
                    result[k].sleepCnt = Math.round(result[k].sleepCnt / result[k].count);
                    result[k].food = Math.round(result[k].food / result[k].count);
                    result[k].poop = Math.round(result[k].poop / result[k].count);
                    result[k].dayFeed = Math.round(result[k].dayFeed / result[k].count);
                    result[k].nightFeed = Math.round(result[k].nightFeed / result[k].count);
                    result[k].dayMilk = Math.round(result[k].dayMilk / result[k].count);
                    result[k].nightMilk = Math.round(result[k].nightMilk / result[k].count);
                    result[k].dayFormula = Math.round(result[k].dayFormula / result[k].count);
                    result[k].nightFormula = Math.round(result[k].nightFormula / result[k].count);
                    result[k].daySleep = Math.round((result[k].daySleep / result[k].count) * 10) / 10;
                    result[k].nightSleep = Math.round((result[k].nightSleep / result[k].count) * 10) / 10;
                });
                return result;
            } else if (dimension === 'month') {
                data.dates.forEach(function (d) {
                    var fullDate = data.data[d].fullDate;
                    var monthKey = fullDate.substring(0, 7);
                    if (!result[monthKey]) {
                        result[monthKey] = {
                            fullDate: monthKey,
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            food: 0, poop: 0,
                            dayFeed: 0, nightFeed: 0, daySleep: 0, nightSleep: 0, weight: null,
                            dayMilk: 0, nightMilk: 0, dayFormula: 0, nightFormula: 0,
                            feedIntervals: [], sleepIntervals: [], count: 0
                        };
                    }
                    var m = result[monthKey];
                    var s = data.data[d];
                    m.milk += s.milk;
                    m.milkMin += s.milkMin;
                    m.formula += s.formula;
                    m.formulaMl += s.formulaMl;
                    m.sleep += s.sleep;
                    m.sleepCnt += s.sleepCnt;
                    if (parseFloat(s.maxSleep) > parseFloat(m.maxSleep)) m.maxSleep = s.maxSleep;
                    m.food += s.food;
                    m.poop += s.poop;
                    m.dayFeed += s.dayFeed;
                    m.nightFeed += s.nightFeed;
                    m.dayMilk += s.dayMilk;
                    m.nightMilk += s.nightMilk;
                    m.dayFormula += s.dayFormula;
                    m.nightFormula += s.nightFormula;
                    m.daySleep += s.daySleep;
                    m.nightSleep += s.nightSleep;
                    if (s.weight) m.weight = s.weight;
                    m.feedIntervals = m.feedIntervals.concat(s.feedIntervals);
                    m.sleepIntervals = m.sleepIntervals.concat(s.sleepIntervals);
                    m.count++;
                });
                Object.keys(result).forEach(function (k) {
                    result[k].milk = Math.round(result[k].milk / result[k].count);
                    result[k].milkMin = Math.round(result[k].milkMin / result[k].count);
                    result[k].formula = Math.round(result[k].formula / result[k].count);
                    result[k].formulaMl = Math.round(result[k].formulaMl / result[k].count);
                    result[k].sleep = Math.round((result[k].sleep / result[k].count) * 10) / 10;
                    result[k].sleepCnt = Math.round(result[k].sleepCnt / result[k].count);
                    result[k].food = Math.round(result[k].food / result[k].count);
                    result[k].poop = Math.round(result[k].poop / result[k].count);
                    result[k].dayFeed = Math.round(result[k].dayFeed / result[k].count);
                    result[k].nightFeed = Math.round(result[k].nightFeed / result[k].count);
                    result[k].dayMilk = Math.round(result[k].dayMilk / result[k].count);
                    result[k].nightMilk = Math.round(result[k].nightMilk / result[k].count);
                    result[k].dayFormula = Math.round(result[k].dayFormula / result[k].count);
                    result[k].nightFormula = Math.round(result[k].nightFormula / result[k].count);
                    result[k].daySleep = Math.round((result[k].daySleep / result[k].count) * 10) / 10;
                    result[k].nightSleep = Math.round((result[k].nightSleep / result[k].count) * 10) / 10;
                });
                return result;
            }
        }

        function renderChart(chartType, dimension) {
            if (chartType === 'feedCount') renderFeedCountChart(dimension);
            else if (chartType === 'feedAmount') renderFeedAmountChart(dimension);
            else if (chartType === 'sleepDuration') renderSleepDurationChart(dimension);
            else if (chartType === 'sleepInterval') renderSleepIntervalChart(dimension);
            else if (chartType === 'feedInterval') renderFeedIntervalChart(dimension);
            else if (chartType === 'weight') renderWeightChart(dimension);
            else if (chartType === 'poop') renderPoopChart(dimension);
        }

        // 1. ÂñÇÂ•∂Ê¨°Êï∞ÔºàÁôΩÂ§©/Â§úÈó¥ÔºåÂå∫ÂàÜÊØç‰π≥ÂíåÂ•∂Á≤âÔºâ
        function renderFeedCountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.feedCount) charts.feedCount.destroy();
            charts.feedCount = new Chart(document.getElementById('feedCountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©ÊØç‰π≥(Ê¨°)', data: labels.map(function(d) { return aggregated[d].dayMilk; }), backgroundColor: COLORS.DAY_DARK, stack: 'day' },
                        { label: 'ÁôΩÂ§©Â•∂Á≤â(Ê¨°)', data: labels.map(function(d) { return aggregated[d].dayFormula; }), backgroundColor: COLORS.DAY_LIGHT, stack: 'day' },
                        { label: 'Â§úÈó¥ÊØç‰π≥(Ê¨°)', data: labels.map(function(d) { return aggregated[d].nightMilk; }), backgroundColor: COLORS.NIGHT_DARK, stack: 'night' },
                        { label: 'Â§úÈó¥Â•∂Á≤â(Ê¨°)', data: labels.map(function(d) { return aggregated[d].nightFormula; }), backgroundColor: COLORS.NIGHT_LIGHT, stack: 'night' }
                    ]
                },
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { stacked: true }
                    } 
                }
            });
        }

        // 2. ÊØèÊó•ÂñÇÂ•∂ÈáèÔºàÊØç‰π≥ÂíåÂ•∂Á≤âÔºâ
        function renderFeedAmountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.feedAmount) charts.feedAmount.destroy();
            charts.feedAmount = new Chart(document.getElementById('feedAmountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'Â•∂Á≤â(ml)', data: labels.map(function(d) { return aggregated[d].formulaMl; }), backgroundColor: 'rgba(255,206,86,0.8)', yAxisID: 'y1' },
                        { label: 'ÊØç‰π≥(min)', data: labels.map(function(d) { return aggregated[d].milkMin; }), backgroundColor: 'rgba(153,102,255,0.8)', yAxisID: 'y2' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y1: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Â•∂Á≤â(ml)' } },
                        y2: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'ÊØç‰π≥(min)' } }
                    }
                }
            });
        }

        // 3. Áù°Áú†Êó∂ÈïøÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderSleepDurationChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.sleepDuration) charts.sleepDuration.destroy();
            charts.sleepDuration = new Chart(document.getElementById('sleepDurationChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©(h)', data: labels.map(function(d) { return aggregated[d].daySleep; }), backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥(h)', data: labels.map(function(d) { return aggregated[d].nightSleep; }), backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } } }
            });
        }

        // 4. Áù°Áú†Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderSleepIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            var dayIntervals = labels.map(function(d) {
                var intervals = aggregated[d].sleepIntervals.filter(function(i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function(d) {
                var intervals = aggregated[d].sleepIntervals.filter(function(i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            if (charts.sleepInterval) charts.sleepInterval.destroy();
            charts.sleepInterval = new Chart(document.getElementById('sleepIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©Èó¥Èöî(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥Èó¥Èöî(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // 5. ÂñÇÂ•∂Èó¥ÈöîÔºàÁôΩÂ§©/Â§úÈó¥Ôºâ
        function renderFeedIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            var dayIntervals = labels.map(function(d) {
                var intervals = aggregated[d].feedIntervals.filter(function(i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function(d) {
                var intervals = aggregated[d].feedIntervals.filter(function(i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function(sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            if (charts.feedInterval) charts.feedInterval.destroy();
            charts.feedInterval = new Chart(document.getElementById('feedIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: 'ÁôΩÂ§©Èó¥Èöî(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: 'Â§úÈó¥Èó¥Èöî(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // 6. ‰ΩìÈáçÂèòÂåñ
        function renderWeightChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.weight) charts.weight.destroy();
            charts.weight = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ label: '‰ΩìÈáç(kg)', data: labels.map(function(d) { return aggregated[d].weight; }), borderColor: 'rgba(75,192,192,1)', tension: 0.4, spanGaps: true }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: false } } }
            });
        }

        // 7. Â§ß‰æøÊ¨°Êï∞
        function renderPoopChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.poop) charts.poop.destroy();
            charts.poop = new Chart(document.getElementById('poopChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function(l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ label: 'Â§ß‰æø(Ê¨°)', data: labels.map(function(d) { return aggregated[d].poop; }), backgroundColor: 'rgba(139,69,19,0.6)' }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function changeTimeDimension(btn, chartType, dimension) {
            var parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderChart(chartType, dimension);
        }

        function renderToday(td, latest, foods) {
            if (!td) return;
            var now = new Date();
            document.getElementById('todayDate').textContent = '(' + (now.getMonth() + 1) + '/' + now.getDate() + ')';
            document.getElementById('todayFeedCount').textContent = td.milk + td.formula;
            document.getElementById('todayFormula').textContent = Math.round(td.formulaMl);
            document.getElementById('todayBreast').textContent = Math.round(td.milkMin);
            document.getElementById('todaySleepCount').textContent = td.sleep.length;
            document.getElementById('todaySleepTotal').textContent = td.sleepTotal.toFixed(1);
            document.getElementById('todaySleepMax').textContent = td.maxSleep.toFixed(1);
            document.getElementById('todayDayFeed').textContent = td.dayFeed;
            document.getElementById('todayDaySleep').textContent = td.daySleep.toFixed(1);
            document.getElementById('todayNightFeed').textContent = td.nightFeed;
            document.getElementById('todayNightSleep').textContent = td.nightSleep.toFixed(1);

            if (latest.milk) document.getElementById('feedCard').innerHTML += '<div class="latest-record">üçº ÊØç‰π≥ ' + latest.milk.t.substring(0, 5) + ' (' + latest.milk.v + 'ÂàÜÈíü)</div>';
            if (latest.formula) document.getElementById('feedCard').innerHTML += '<div class="latest-record">üçº Â•∂Á≤â ' + latest.formula.t.substring(0, 5) + ' (' + latest.formula.v + 'ml)</div>';
            if (latest.sleep) document.getElementById('sleepCard').innerHTML += '<div class="latest-record">üí§ ' + latest.sleep.t.substring(0, 5) + ' ÈÜíÊù• (Áù°‰∫Ü' + latest.sleep.h + 'h)</div>';

            if (td.weight) {
                document.getElementById('weightCard').style.display = 'block';
                document.getElementById('todayWeight').textContent = td.weight;
                document.getElementById('todayOther').style.display = 'grid';
            }
            if (td.food > 0) {
                document.getElementById('foodCard').style.display = 'block';
                document.getElementById('todayFood').textContent = td.food;
                document.getElementById('todayOther').style.display = 'grid';
                if (foods && foods.length > 0) {
                    var foodContent = document.getElementById('foodCard');
                    foods.forEach(function(food) {
                        foodContent.innerHTML += '<div class="latest-record">ü•Ñ ' + food.t.substring(0, 5) + ' ' + food.desc + '</div>';
                    });
                }
            }
            if (td.poop > 0) {
                document.getElementById('poopCard').style.display = 'block';
                document.getElementById('todayPoop').textContent = td.poop;
                document.getElementById('todayOther').style.display = 'grid';
            }
        }

        function renderYesterday(yd) {
            if (!yd) return;
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('yesterdayDate').textContent = '(' + (yesterday.getMonth() + 1) + '/' + yesterday.getDate() + ')';
            document.getElementById('yesterdayFeedCount').textContent = yd.milk + yd.formula;
            document.getElementById('yesterdayFormula').textContent = Math.round(yd.formulaMl);
            document.getElementById('yesterdayBreast').textContent = Math.round(yd.milkMin);
            document.getElementById('yesterdaySleepCount').textContent = yd.sleepCnt;
            document.getElementById('yesterdaySleepTotal').textContent = yd.sleep.toFixed(1);
            document.getElementById('yesterdaySleepMax').textContent = yd.maxSleep;
            document.getElementById('yesterdayDayFeed').textContent = yd.dayFeed;
            document.getElementById('yesterdayDaySleep').textContent = yd.daySleep.toFixed(1);
            document.getElementById('yesterdayNightFeed').textContent = yd.nightFeed;
            document.getElementById('yesterdayNightSleep').textContent = yd.nightSleep.toFixed(1);
        }

        function renderCharts(analyzed) {
            var data = analyzed.data;
            var dates = analyzed.dates;
            if (dates.length === 0) return;

            document.getElementById('dataContainer').style.display = 'block';
            document.getElementById('fileContainer').style.display = 'none';

            renderToday(analyzed.today, analyzed.latest, analyzed.foods);
            renderYesterday(analyzed.yesterday);

            var totalS = dates.reduce(function (s, d) { return s + data[d].sleep; }, 0);
            var totalF = dates.reduce(function (s, d) { return s + data[d].formulaMl; }, 0);
            var totalM = dates.reduce(function (s, d) { return s + data[d].milkMin; }, 0);
            var totalFeedGaps = [];
            var totalSleepGaps = [];
            dates.forEach(function(d) {
                totalFeedGaps = totalFeedGaps.concat(data[d].feedIntervals);
                totalSleepGaps = totalSleepGaps.concat(data[d].sleepIntervals);
            });

            document.getElementById('avgSleep').textContent = (totalS / dates.length).toFixed(1);
            document.getElementById('avgFormula').textContent = Math.round(totalF / dates.length);
            document.getElementById('avgBreast').textContent = Math.round(totalM / dates.length);
            document.getElementById('currentWeight').textContent = analyzed.weight || '-';
            var avgFeedVal = totalFeedGaps.length > 0 ? (totalFeedGaps.reduce(function(a,b){return a+b.value}, 0)/totalFeedGaps.length).toFixed(1) : '-';
            var avgSleepVal = totalSleepGaps.length > 0 ? (totalSleepGaps.reduce(function(a,b){return a+b.value}, 0)/totalSleepGaps.length).toFixed(1) : '-';
            document.getElementById('avgFeedInterval').textContent = avgFeedVal;
            document.getElementById('avgSleepInterval').textContent = avgSleepVal;

            Chart.defaults.font.size = 12;

            renderChart('feedCount', 'day');
            renderChart('feedAmount', 'day');
            renderChart('sleepDuration', 'day');
            renderChart('sleepInterval', 'day');
            renderChart('feedInterval', 'day');
            renderChart('weight', 'day');
            renderChart('poop', 'day');

            document.getElementById('status').textContent = '‚úÖ Âä†ËΩΩÊàêÂäüÔºÅÂÖ± ' + dates.length + ' Â§©Êï∞ÊçÆ';
        }

        document.getElementById('csvFile').addEventListener('change', function (e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                var csv = parseCSV(ev.target.result);
                if (csv.length > 0) {
                    allAnalyzedData = analyzeData(csv);
                    renderCharts(allAnalyzedData);
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        document.getElementById('birthDate').addEventListener('change', calculateAndDisplayAge);

        window.addEventListener('load', function () {
            calculateAndDisplayAge();
            fetch('./baby_log.csv', { cache: 'no-cache' })
                .then(function (r) { return r.text(); })
                .then(function (text) {
                    var csv = parseCSV(text);
                    if (csv.length > 0) {
                        allAnalyzedData = analyzeData(csv);
                        renderCharts(allAnalyzedData);
                    }
                })
                .catch(function () {
                    document.getElementById('status').textContent = 'Á≠âÂæÖ‰∏ä‰º†CSVÊñá‰ª∂';
                });
        });
    </script>
</body>
</html>