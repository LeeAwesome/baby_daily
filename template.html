<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>宝宝日常</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            min-height: 100vh
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5px
        }

        .header-container {
            position: relative;
            margin-bottom: 10px
        }

        .settings-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1)
        }

        h1 {
            color: #fff;
            text-align: center;
            margin: 0;
            font-size: clamp(22px, 6vw, 32px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .2)
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0
            }
            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0
        }

        .modal-header h2 {
            margin: 0;
            color: #667eea;
            font-size: 24px
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s
        }

        .close-btn:hover {
            color: #333;
            transform: scale(1.1)
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s
        }

        .save-btn:hover {
            background: #5568d3
        }

        #babyAge {
            display: block;
            text-align: center;
            color: #fff;
            margin-bottom: 15px;
            font-size: clamp(13px, 3.5vw, 16px)
        }

        .file-input-container {
            background: rgba(255, 255, 255, .95);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            display: none
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(13px, 3vw, 15px);
            font-weight: 600
        }

        .file-input-container input[type="file"] {
            display: none
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: clamp(12px, 3vw, 14px);
            background: rgba(255, 255, 255, .7);
            color: #333
        }

        .update-time {
            text-align: center;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
            opacity: 0.95;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2)
        }

        .summary-section {
            background: rgba(255, 255, 255, .95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .today-summary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)
        }

        .yesterday-summary {
            background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%)
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none
        }

        .summary-header h2 {
            margin: 0;
            color: #fff;
            font-size: clamp(18px, 5vw, 22px);
            font-weight: 700
        }

        .chevron {
            color: #fff;
            font-size: 20px;
            transition: transform .3s
        }

        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px
        }

        .summary-card {
            background: rgba(255, 255, 255, .95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .05)
        }

        .summary-card h3 {
            color: #667eea;
            font-size: clamp(14px, 3.5vw, 16px);
            margin-bottom: 10px;
            font-weight: 600
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: clamp(12px, 3vw, 14px)
        }

        .stat-row:last-child {
            border-bottom: none
        }

        .stat-label {
            color: #666;
            font-weight: 500
        }

        .stat-value {
            color: #333;
            font-weight: 700
        }

        .latest-record {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: clamp(11px, 2.8vw, 13px);
            color: #555
        }

        .avg-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px
        }

        .avg-card {
            background: rgba(255, 255, 255, .95);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .avg-card h4 {
            color: #667eea;
            font-size: clamp(12px, 3vw, 14px);
            margin-bottom: 8px;
            font-weight: 600
        }

        .avg-card .value {
            color: #333;
            font-size: clamp(18px, 5vw, 24px);
            font-weight: 700
        }

        .chart-card {
            background: rgba(255, 255, 255, .95);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
            flex-wrap: wrap
        }

        .chart-card h3 {
            font-size: clamp(15px, 4vw, 18px);
            color: #333;
            font-weight: 600;
            margin: 0;
            flex: 1;
            min-width: 120px
        }

        .time-buttons {
            display: flex;
            gap: 6px;
            flex-shrink: 0
        }

        .time-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: clamp(11px, 2.8vw, 13px);
            transition: all .2s;
            font-weight: 500
        }

        .time-btn.active {
            background: #667eea;
            color: #fff;
            border-color: #667eea
        }

        .time-btn:hover {
            background: #f0f0f0
        }

        .time-btn.active:hover {
            background: #5568d3
        }

        @media (max-width: 600px) {
            .chart-header {
                gap: 8px;
                margin-bottom: 12px
            }
            .chart-title {
                font-size: 14px;
                flex: 1;
                min-width: auto
            }
            .time-dimension {
                gap: 5px
            }
            .time-dimension button {
                padding: 5px 10px;
                font-size: 11px
            }
        }

        canvas {
            max-height: 350px
        }

        #dataContainer {
            display: none
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-container">
            <button class="settings-btn" onclick="openSettings()">⚙️</button>
            <h1 id="babyName">宝宝日常</h1>
        </div>
        <span id="babyAge"></span>
        <div class="update-time" id="updateTime">数据加载中...</div>

        <div id="fileContainer" class="file-input-container">
            <label for="csvFile" class="file-label">📁 选择CSV文件</label>
            <input type="file" id="csvFile" accept=".csv">
            <div class="status" id="status">等待上传CSV文件</div>
        </div>

        <div id="dataContainer">
            <div class="summary-section today-summary">
                <div class="summary-header" onclick="toggleSummary(this)">
                    <h2>📅 今日汇总 <span id="todayDate"></span></h2>
                    <span class="chevron">▼</span>
                </div>
                <div class="summary-content">
                    <div class="summary-card" id="feedCard">
                        <h3>🍼 喂奶情况</h3>
                        <div class="stat-row"><span class="stat-label">总次数</span><span class="stat-value"><span id="todayFeedCount">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">奶粉总量</span><span class="stat-value"><span id="todayFormula">0</span> ml</span></div>
                        <div class="stat-row"><span class="stat-label">母乳时长</span><span class="stat-value"><span id="todayBreast">0</span> 分钟</span></div>
                    </div>
                    <div class="summary-card" id="sleepCard">
                        <h3>💤 睡眠情况</h3>
                        <div class="stat-row"><span class="stat-label">睡眠次数</span><span class="stat-value"><span id="todaySleepCount">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">总睡眠</span><span class="stat-value"><span id="todaySleepTotal">0</span> 小时</span></div>
                        <div class="stat-row"><span class="stat-label">最长睡眠</span><span class="stat-value"><span id="todaySleepMax">0</span> 小时</span></div>
                    </div>
                    <div class="summary-card">
                        <h3>🌓 白天/夜间对比</h3>
                        <div class="stat-row"><span class="stat-label">白天喂奶</span><span class="stat-value"><span id="todayDayFeed">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">白天睡眠</span><span class="stat-value"><span id="todayDaySleep">0</span> 小时</span></div>
                        <div class="stat-row"><span class="stat-label">夜间喂奶</span><span class="stat-value"><span id="todayNightFeed">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">夜间睡眠</span><span class="stat-value"><span id="todayNightSleep">0</span> 小时</span></div>
                    </div>
                    <div id="todayOther" style="display:none">
                        <div class="summary-card" id="weightCard" style="display:none">
                            <h3>⚖️ 体重</h3>
                            <div class="stat-row"><span class="stat-label">当前体重</span><span class="stat-value"><span id="todayWeight">0</span> kg</span></div>
                        </div>
                        <div class="summary-card" id="foodCard" style="display:none">
                            <h3>🥄 辅食</h3>
                            <div class="stat-row"><span class="stat-label">辅食次数</span><span class="stat-value"><span id="todayFood">0</span> 次</span></div>
                        </div>
                        <div class="summary-card" id="poopCard" style="display:none">
                            <h3>💩 大便</h3>
                            <div class="stat-row"><span class="stat-label">大便次数</span><span class="stat-value"><span id="todayPoop">0</span> 次</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-section yesterday-summary">
                <div class="summary-header" onclick="toggleSummary(this)">
                    <h2>📅 昨日汇总 <span id="yesterdayDate"></span></h2>
                    <span class="chevron">▼</span>
                </div>
                <div class="summary-content">
                    <div class="summary-card">
                        <h3>🍼 喂奶情况</h3>
                        <div class="stat-row"><span class="stat-label">总次数</span><span class="stat-value"><span id="yesterdayFeedCount">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">奶粉总量</span><span class="stat-value"><span id="yesterdayFormula">0</span> ml</span></div>
                        <div class="stat-row"><span class="stat-label">母乳时长</span><span class="stat-value"><span id="yesterdayBreast">0</span> 分钟</span></div>
                    </div>
                    <div class="summary-card">
                        <h3>💤 睡眠情况</h3>
                        <div class="stat-row"><span class="stat-label">睡眠次数</span><span class="stat-value"><span id="yesterdaySleepCount">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">总睡眠</span><span class="stat-value"><span id="yesterdaySleepTotal">0</span> 小时</span></div>
                        <div class="stat-row"><span class="stat-label">最长睡眠</span><span class="stat-value"><span id="yesterdaySleepMax">0</span> 小时</span></div>
                    </div>
                    <div class="summary-card">
                        <h3>🌓 白天/夜间对比</h3>
                        <div class="stat-row"><span class="stat-label">白天喂奶</span><span class="stat-value"><span id="yesterdayDayFeed">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">白天睡眠</span><span class="stat-value"><span id="yesterdayDaySleep">0</span> 小时</span></div>
                        <div class="stat-row"><span class="stat-label">夜间喂奶</span><span class="stat-value"><span id="yesterdayNightFeed">0</span> 次</span></div>
                        <div class="stat-row"><span class="stat-label">夜间睡眠</span><span class="stat-value"><span id="yesterdayNightSleep">0</span> 小时</span></div>
                    </div>
                </div>
            </div>

            <div class="avg-cards">
                <div class="avg-card">
                    <h4>日均睡眠</h4>
                    <div class="value"><span id="avgSleep">0</span>h</div>
                </div>
                <div class="avg-card">
                    <h4>日均奶粉</h4>
                    <div class="value"><span id="avgFormula">0</span>ml</div>
                </div>
                <div class="avg-card">
                    <h4>日均母乳</h4>
                    <div class="value"><span id="avgBreast">0</span>min</div>
                </div>
                <div class="avg-card">
                    <h4>当前体重</h4>
                    <div class="value"><span id="currentWeight">-</span>kg</div>
                </div>
                <div class="avg-card">
                    <h4>平均喂奶间隔</h4>
                    <div class="value"><span id="avgFeedInterval">-</span>h</div>
                </div>
                <div class="avg-card">
                    <h4>平均睡眠间隔</h4>
                    <div class="value"><span id="avgSleepInterval">-</span>h</div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>🍼 每日喂奶次数</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'feedCount', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedCount', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedCount', 'month')">月</button>
                    </div>
                </div>
                <canvas id="feedCountChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>📊 每日喂奶量</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'feedAmount', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedAmount', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedAmount', 'month')">月</button>
                    </div>
                </div>
                <canvas id="feedAmountChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>😴 睡眠时长</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'sleepDuration', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'sleepDuration', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'sleepDuration', 'month')">月</button>
                    </div>
                </div>
                <canvas id="sleepDurationChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>⏰ 睡眠间隔</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'sleepInterval', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'sleepInterval', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'sleepInterval', 'month')">月</button>
                    </div>
                </div>
                <canvas id="sleepIntervalChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>⏰ 喂奶间隔</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'feedInterval', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedInterval', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'feedInterval', 'month')">月</button>
                    </div>
                </div>
                <canvas id="feedIntervalChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>⚖️ 体重变化</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'weight', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'weight', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'weight', 'month')">月</button>
                    </div>
                </div>
                <canvas id="weightChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>💩 大便次数</h3>
                    <div class="time-buttons">
                        <button class="time-btn active" onclick="changeTimeDimension(this, 'poop', 'day')">日</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'poop', 'week')">周</button>
                        <button class="time-btn" onclick="changeTimeDimension(this, 'poop', 'month')">月</button>
                    </div>
                </div>
                <canvas id="poopChart"></canvas>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ 设置</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            <div class="form-group">
                <label for="babyNameInput">宝宝姓名</label>
                <input type="text" id="babyNameInput" placeholder="请输入宝宝姓名">
            </div>
            <div class="form-group">
                <label for="birthDate">出生日期</label>
                <input type="date" id="birthDate">
            </div>
            <button class="save-btn" onclick="saveSettings()">💾 保存设置</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ========== 📊 CSV数据注入点 - 快捷指令会替换这一行 ==========
        var csvRawData = `__CSV_DATA__`;
        // ====================================================

        var allAnalyzedData = null;
        var charts = {};

        var COLORS = {
            DAY: 'rgba(255,206,86,0.8)',
            NIGHT: 'rgba(153,102,255,0.8)',
            DAY_DARK: 'rgba(255,193,7,0.9)',
            DAY_LIGHT: 'rgba(255,235,59,0.7)',
            NIGHT_DARK: 'rgba(126,87,194,0.9)',
            NIGHT_LIGHT: 'rgba(179,157,219,0.7)'
        };

        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            var babyName = document.getElementById('babyNameInput').value;
            var birthDate = document.getElementById('birthDate').value;
            if (babyName) {
                localStorage.setItem('babyName', babyName);
                document.getElementById('babyName').textContent = babyName + '的日常';
            }
            if (birthDate) {
                localStorage.setItem('birthDate', birthDate);
                calculateAndDisplayAge();
            }
            closeSettings();
        }

        function initializeSettings() {
            var savedName = localStorage.getItem('babyName');
            var savedBirthDate = localStorage.getItem('birthDate');
            if (savedName) {
                document.getElementById('babyName').textContent = savedName + '的日常';
                document.getElementById('babyNameInput').value = savedName;
            }
            if (savedBirthDate) {
                document.getElementById('birthDate').value = savedBirthDate;
                calculateAndDisplayAge();
            }
        }

        function calculateAndDisplayAge() {
            var birthDateStr = document.getElementById('birthDate').value;
            if (!birthDateStr) return;
            var birthDate = new Date(birthDateStr);
            var today = new Date();
            var totalDays = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24));
            var months = Math.floor(totalDays / 30);
            var days = totalDays % 30;
            var name = localStorage.getItem('babyName') || '宝宝';
            document.getElementById('babyAge').textContent = name + '已经 ' + months + ' 个月 ' + days + ' 天了 🎉';
        }

        function toggleSummary(header) {
            var content = header.nextElementSibling;
            var chevron = header.querySelector('.chevron');
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                chevron.textContent = '▼';
            } else {
                content.style.display = 'none';
                chevron.textContent = '▶';
            }
        }

        function parseCSV(text) {
            var lines = text.trim().split('\n');
            var result = [];
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                var parts = line.split(',');
                if (parts.length >= 2) {
                    result.push({
                        timestamp: parts[0] ? parts[0].trim() : '',
                        event: parts[1] ? parts[1].trim() : '',
                        subEvent: parts[2] ? parts[2].trim() : '',
                        value: parts[3] ? parts[3].trim() : '',
                        unit: parts[4] ? parts[4].trim() : '',
                        note: parts[5] ? parts[5].trim() : '',
                        person: parts[6] ? parts[6].trim() : '',
                        pairKey: parts[7] ? parts[7].trim() : ''
                    });
                }
            }
            return result;
        }

        function getClassifyDate(timestamp) {
            var dt = new Date(timestamp);
            var hour = dt.getHours();
            if (hour < 6) {
                dt.setDate(dt.getDate() - 1);
            }
            return dt.toISOString().substring(0, 10);
        }

        function analyzeData(records) {
            var data = {};
            var sleepStarts = {};
            var latest = { milk: null, formula: null, sleep: null };
            var foods = [];

            records.forEach(function (r) {
                var date = getClassifyDate(r.timestamp);
                if (!data[date]) {
                    data[date] = {
                        milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                        sleep: 0, sleepCnt: 0, maxSleep: 0,
                        daySleep: 0, nightSleep: 0, dayFeed: 0, nightFeed: 0,
                        weight: null, food: 0, poop: 0,
                        feedIntervals: [], sleepIntervals: [], sleep: []
                    };
                }
                var d = data[date];
                var hour = new Date(r.timestamp).getHours();
                var isDay = hour >= 6 && hour < 20;

                if (r.event === '喂奶') {
                    if (r.subEvent === '母乳') {
                        d.milk++;
                        if (r.value) d.milkMin += parseFloat(r.value) || 0;
                        latest.milk = { t: r.timestamp.substring(11, 16), v: r.value || 0 };
                    } else if (r.subEvent === '奶粉') {
                        d.formula++;
                        if (r.value) d.formulaMl += parseFloat(r.value) || 0;
                        latest.formula = { t: r.timestamp.substring(11, 16), v: r.value || 0 };
                    }
                    if (isDay) d.dayFeed++; else d.nightFeed++;
                }

                if (r.event === '睡觉') {
                    if (r.subEvent === '开始') {
                        sleepStarts[r.timestamp] = true;
                    } else if (r.subEvent === '结束' && r.pairKey && sleepStarts[r.pairKey]) {
                        var start = new Date(r.pairKey);
                        var end = new Date(r.timestamp);
                        var hours = (end - start) / (1000 * 60 * 60);
                        if (hours > 0 && hours < 24) {
                            d.sleep += hours;
                            d.sleepCnt++;
                            d.maxSleep = Math.max(d.maxSleep, hours);
                            d.sleep.push({ start: r.pairKey, end: r.timestamp, hours: hours });
                            var wakeHour = end.getHours();
                            var wakeIsDay = wakeHour >= 6 && wakeHour < 20;
                            if (wakeIsDay) d.daySleep += hours; else d.nightSleep += hours;
                            latest.sleep = { t: r.timestamp.substring(11, 16), h: hours.toFixed(1) };
                        }
                    }
                }

                if (r.event === '体重' && r.value) d.weight = parseFloat(r.value);
                if (r.event === '辅食') {
                    d.food++;
                    foods.push({ t: r.timestamp.substring(11, 16), desc: (r.subEvent || '') + (r.value ? ' ' + r.value + (r.unit || '') : '') });
                }
                if (r.event === '换尿布' && r.subEvent === '大便') d.poop++;
            });

            // 计算间隔
            var dates = Object.keys(data).sort();
            dates.forEach(function (date) {
                var d = data[date];
                var dayRecords = records.filter(function (r) { return getClassifyDate(r.timestamp) === date; });

                var feeds = dayRecords.filter(function (r) { return r.event === '喂奶'; }).sort(function (a, b) { return new Date(a.timestamp) - new Date(b.timestamp); });
                for (var i = 1; i < feeds.length; i++) {
                    var interval = (new Date(feeds[i].timestamp) - new Date(feeds[i - 1].timestamp)) / (1000 * 60 * 60);
                    if (interval > 0 && interval < 24) {
                        var feedHour = new Date(feeds[i].timestamp).getHours();
                        d.feedIntervals.push({ value: interval, isDay: feedHour >= 6 && feedHour < 20 });
                    }
                }

                for (var i = 1; i < d.sleep.length; i++) {
                    var interval = (new Date(d.sleep[i].start) - new Date(d.sleep[i - 1].end)) / (1000 * 60 * 60);
                    if (interval > 0 && interval < 24) {
                        var wakeHour = new Date(d.sleep[i].start).getHours();
                        d.sleepIntervals.push({ value: interval, isDay: wakeHour >= 6 && wakeHour < 20 });
                    }
                }
            });

            var lastDate = dates[dates.length - 1];
            var yesterdayDate = dates[dates.length - 2];
            var lastWeight = null;
            for (var i = dates.length - 1; i >= 0; i--) {
                if (data[dates[i]].weight !== null) {
                    lastWeight = data[dates[i]].weight;
                    break;
                }
            }

            return {
                data: data,
                dates: dates,
                today: data[lastDate],
                yesterday: data[yesterdayDate],
                weight: lastWeight,
                latest: latest,
                foods: foods
            };
        }

        function aggregateByDimension(analyzed, dimension) {
            var data = analyzed.data;
            var dates = analyzed.dates;
            var result = {};

            if (dimension === 'day') {
                return data;
            } else if (dimension === 'week') {
                dates.forEach(function (date) {
                    var d = new Date(date);
                    var weekStart = new Date(d);
                    weekStart.setDate(d.getDate() - d.getDay());
                    var weekKey = weekStart.toISOString().substring(0, 10);
                    if (!result[weekKey]) {
                        result[weekKey] = {
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            daySleep: 0, nightSleep: 0, dayFeed: 0, nightFeed: 0,
                            weight: null, food: 0, poop: 0,
                            feedIntervals: [], sleepIntervals: []
                        };
                    }
                    var r = result[weekKey];
                    var dd = data[date];
                    r.milk += dd.milk;
                    r.milkMin += dd.milkMin;
                    r.formula += dd.formula;
                    r.formulaMl += dd.formulaMl;
                    r.sleep += dd.sleep;
                    r.sleepCnt += dd.sleepCnt;
                    r.maxSleep = Math.max(r.maxSleep, dd.maxSleep);
                    r.daySleep += dd.daySleep;
                    r.nightSleep += dd.nightSleep;
                    r.dayFeed += dd.dayFeed;
                    r.nightFeed += dd.nightFeed;
                    if (dd.weight !== null) r.weight = dd.weight;
                    r.food += dd.food;
                    r.poop += dd.poop;
                    r.feedIntervals = r.feedIntervals.concat(dd.feedIntervals);
                    r.sleepIntervals = r.sleepIntervals.concat(dd.sleepIntervals);
                });
            } else if (dimension === 'month') {
                dates.forEach(function (date) {
                    var monthKey = date.substring(0, 7);
                    if (!result[monthKey]) {
                        result[monthKey] = {
                            milk: 0, milkMin: 0, formula: 0, formulaMl: 0,
                            sleep: 0, sleepCnt: 0, maxSleep: 0,
                            daySleep: 0, nightSleep: 0, dayFeed: 0, nightFeed: 0,
                            weight: null, food: 0, poop: 0,
                            feedIntervals: [], sleepIntervals: []
                        };
                    }
                    var r = result[monthKey];
                    var dd = data[date];
                    r.milk += dd.milk;
                    r.milkMin += dd.milkMin;
                    r.formula += dd.formula;
                    r.formulaMl += dd.formulaMl;
                    r.sleep += dd.sleep;
                    r.sleepCnt += dd.sleepCnt;
                    r.maxSleep = Math.max(r.maxSleep, dd.maxSleep);
                    r.daySleep += dd.daySleep;
                    r.nightSleep += dd.nightSleep;
                    r.dayFeed += dd.dayFeed;
                    r.nightFeed += dd.nightFeed;
                    if (dd.weight !== null) r.weight = dd.weight;
                    r.food += dd.food;
                    r.poop += dd.poop;
                    r.feedIntervals = r.feedIntervals.concat(dd.feedIntervals);
                    r.sleepIntervals = r.sleepIntervals.concat(dd.sleepIntervals);
                });
            }
            return result;
        }

        function renderChart(chartType, dimension) {
            if (chartType === 'feedCount') renderFeedCountChart(dimension);
            else if (chartType === 'feedAmount') renderFeedAmountChart(dimension);
            else if (chartType === 'sleepDuration') renderSleepDurationChart(dimension);
            else if (chartType === 'sleepInterval') renderSleepIntervalChart(dimension);
            else if (chartType === 'feedInterval') renderFeedIntervalChart(dimension);
            else if (chartType === 'weight') renderWeightChart(dimension);
            else if (chartType === 'poop') renderPoopChart(dimension);
        }

        function renderFeedCountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            var dayMilk = labels.map(function (d) {
                var milkCount = 0, formulaCount = 0;
                if (dimension === 'day') {
                    var dayRecords = allAnalyzedData.data[d];
                    var feeds = [];
                    Object.keys(allAnalyzedData.data).forEach(function (date) {
                        if (date === d) {
                            aggregated[d].feedIntervals.forEach(function (f) {
                                if (f.isDay) milkCount++;
                            });
                        }
                    });
                    return aggregated[d].dayFeed;
                }
                return aggregated[d].dayFeed;
            });
            var nightMilk = labels.map(function (d) { return aggregated[d].nightFeed; });

            if (charts.feedCount) charts.feedCount.destroy();
            charts.feedCount = new Chart(document.getElementById('feedCountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: '白天喂奶', data: dayMilk, backgroundColor: COLORS.DAY },
                        { label: '夜间喂奶', data: nightMilk, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderFeedAmountChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.feedAmount) charts.feedAmount.destroy();
            charts.feedAmount = new Chart(document.getElementById('feedAmountChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: '奶粉(ml)', data: labels.map(function (d) { return aggregated[d].formulaMl; }), backgroundColor: 'rgba(255,99,132,0.8)', yAxisID: 'y1' },
                        { label: '母乳(分)', data: labels.map(function (d) { return aggregated[d].milkMin; }), backgroundColor: 'rgba(54,162,235,0.8)', yAxisID: 'y2' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y1: { type: 'linear', position: 'left', beginAtZero: true },
                        y2: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderSleepDurationChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.sleepDuration) charts.sleepDuration.destroy();
            charts.sleepDuration = new Chart(document.getElementById('sleepDurationChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: '白天(h)', data: labels.map(function (d) { return aggregated[d].daySleep; }), backgroundColor: COLORS.DAY },
                        { label: '夜间(h)', data: labels.map(function (d) { return aggregated[d].nightSleep; }), backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, stacked: true }, x: { stacked: true } } }
            });
        }

        function renderSleepIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            var dayIntervals = labels.map(function (d) {
                var intervals = aggregated[d].sleepIntervals.filter(function (i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function (sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function (d) {
                var intervals = aggregated[d].sleepIntervals.filter(function (i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function (sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            if (charts.sleepInterval) charts.sleepInterval.destroy();
            charts.sleepInterval = new Chart(document.getElementById('sleepIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: '白天间隔(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: '夜间间隔(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderFeedIntervalChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            var dayIntervals = labels.map(function (d) {
                var intervals = aggregated[d].feedIntervals.filter(function (i) { return i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function (sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            var nightIntervals = labels.map(function (d) {
                var intervals = aggregated[d].feedIntervals.filter(function (i) { return !i.isDay; });
                return intervals.length > 0 ? (intervals.reduce(function (sum, i) { return sum + i.value; }, 0) / intervals.length) : 0;
            });
            if (charts.feedInterval) charts.feedInterval.destroy();
            charts.feedInterval = new Chart(document.getElementById('feedIntervalChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [
                        { label: '白天间隔(h)', data: dayIntervals, backgroundColor: COLORS.DAY },
                        { label: '夜间间隔(h)', data: nightIntervals, backgroundColor: COLORS.NIGHT }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderWeightChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.weight) charts.weight.destroy();
            charts.weight = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ label: '体重(kg)', data: labels.map(function (d) { return aggregated[d].weight; }), borderColor: 'rgba(75,192,192,1)', tension: 0.4, spanGaps: true }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: false } } }
            });
        }

        function renderPoopChart(dimension) {
            var aggregated = aggregateByDimension(allAnalyzedData, dimension);
            var labels = Object.keys(aggregated).sort();
            if (charts.poop) charts.poop.destroy();
            charts.poop = new Chart(document.getElementById('poopChart'), {
                type: 'bar',
                data: {
                    labels: labels.map(function (l) { return dimension === 'week' || dimension === 'month' ? l.substring(5) : l; }),
                    datasets: [{ label: '大便(次)', data: labels.map(function (d) { return aggregated[d].poop; }), backgroundColor: 'rgba(139,69,19,0.6)' }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function changeTimeDimension(btn, chartType, dimension) {
            var parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
            renderChart(chartType, dimension);
        }

        function renderToday(td, latest, foods) {
            if (!td) return;
            var now = new Date();
            document.getElementById('todayDate').textContent = '(' + (now.getMonth() + 1) + '/' + now.getDate() + ')';
            document.getElementById('todayFeedCount').textContent = td.milk + td.formula;
            document.getElementById('todayFormula').textContent = Math.round(td.formulaMl);
            document.getElementById('todayBreast').textContent = Math.round(td.milkMin);
            document.getElementById('todaySleepCount').textContent = td.sleep.length;
            document.getElementById('todaySleepTotal').textContent = td.sleepTotal ? td.sleepTotal.toFixed(1) : '0.0';
            document.getElementById('todaySleepMax').textContent = td.maxSleep.toFixed(1);
            document.getElementById('todayDayFeed').textContent = td.dayFeed;
            document.getElementById('todayDaySleep').textContent = td.daySleep.toFixed(1);
            document.getElementById('todayNightFeed').textContent = td.nightFeed;
            document.getElementById('todayNightSleep').textContent = td.nightSleep.toFixed(1);

            if (latest.milk) document.getElementById('feedCard').innerHTML += '<div class="latest-record">🍼 母乳 ' + latest.milk.t + ' (' + latest.milk.v + '分钟)</div>';
            if (latest.formula) document.getElementById('feedCard').innerHTML += '<div class="latest-record">🍼 奶粉 ' + latest.formula.t + ' (' + latest.formula.v + 'ml)</div>';
            if (latest.sleep) document.getElementById('sleepCard').innerHTML += '<div class="latest-record">💤 ' + latest.sleep.t + ' 醒来 (睡了' + latest.sleep.h + 'h)</div>';

            if (td.weight) {
                document.getElementById('weightCard').style.display = 'block';
                document.getElementById('todayWeight').textContent = td.weight;
                document.getElementById('todayOther').style.display = 'grid';
            }
            if (td.food > 0) {
                document.getElementById('foodCard').style.display = 'block';
                document.getElementById('todayFood').textContent = td.food;
                document.getElementById('todayOther').style.display = 'grid';
                if (foods && foods.length > 0) {
                    var foodContent = document.getElementById('foodCard');
                    foods.forEach(function (food) {
                        foodContent.innerHTML += '<div class="latest-record">🥄 ' + food.t + ' ' + food.desc + '</div>';
                    });
                }
            }
            if (td.poop > 0) {
                document.getElementById('poopCard').style.display = 'block';
                document.getElementById('todayPoop').textContent = td.poop;
                document.getElementById('todayOther').style.display = 'grid';
            }
        }

        function renderYesterday(yd) {
            if (!yd) return;
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('yesterdayDate').textContent = '(' + (yesterday.getMonth() + 1) + '/' + yesterday.getDate() + ')';
            document.getElementById('yesterdayFeedCount').textContent = yd.milk + yd.formula;
            document.getElementById('yesterdayFormula').textContent = Math.round(yd.formulaMl);
            document.getElementById('yesterdayBreast').textContent = Math.round(yd.milkMin);
            document.getElementById('yesterdaySleepCount').textContent = yd.sleepCnt;
            document.getElementById('yesterdaySleepTotal').textContent = yd.sleep.toFixed(1);
            document.getElementById('yesterdaySleepMax').textContent = yd.maxSleep ? yd.maxSleep.toFixed(1) : '0.0';
            document.getElementById('yesterdayDayFeed').textContent = yd.dayFeed;
            document.getElementById('yesterdayDaySleep').textContent = yd.daySleep.toFixed(1);
            document.getElementById('yesterdayNightFeed').textContent = yd.nightFeed;
            document.getElementById('yesterdayNightSleep').textContent = yd.nightSleep.toFixed(1);
        }

        function renderCharts(analyzed) {
            var data = analyzed.data;
            var dates = analyzed.dates;
            if (dates.length === 0) return;

            document.getElementById('dataContainer').style.display = 'block';
            document.getElementById('fileContainer').style.display = 'none';

            renderToday(analyzed.today, analyzed.latest, analyzed.foods);
            renderYesterday(analyzed.yesterday);

            var totalS = dates.reduce(function (s, d) { return s + data[d].sleep; }, 0);
            var totalF = dates.reduce(function (s, d) { return s + data[d].formulaMl; }, 0);
            var totalM = dates.reduce(function (s, d) { return s + data[d].milkMin; }, 0);
            var totalFeedGaps = [];
            var totalSleepGaps = [];
            dates.forEach(function (d) {
                totalFeedGaps = totalFeedGaps.concat(data[d].feedIntervals);
                totalSleepGaps = totalSleepGaps.concat(data[d].sleepIntervals);
            });

            document.getElementById('avgSleep').textContent = (totalS / dates.length).toFixed(1);
            document.getElementById('avgFormula').textContent = Math.round(totalF / dates.length);
            document.getElementById('avgBreast').textContent = Math.round(totalM / dates.length);
            document.getElementById('currentWeight').textContent = analyzed.weight || '-';
            var avgFeedVal = totalFeedGaps.length > 0 ? (totalFeedGaps.reduce(function (a, b) { return a + b.value }, 0) / totalFeedGaps.length).toFixed(1) : '-';
            var avgSleepVal = totalSleepGaps.length > 0 ? (totalSleepGaps.reduce(function (a, b) { return a + b.value }, 0) / totalSleepGaps.length).toFixed(1) : '-';
            document.getElementById('avgFeedInterval').textContent = avgFeedVal;
            document.getElementById('avgSleepInterval').textContent = avgSleepVal;

            Chart.defaults.font.size = 12;

            renderChart('feedCount', 'day');
            renderChart('feedAmount', 'day');
            renderChart('sleepDuration', 'day');
            renderChart('sleepInterval', 'day');
            renderChart('feedInterval', 'day');
            renderChart('weight', 'day');
            renderChart('poop', 'day');

            document.getElementById('status').textContent = '✅ 加载成功！共 ' + dates.length + ' 天数据';
        }

        // ========== 初始化 ==========
        window.addEventListener('load', function () {
            initializeSettings();
            
            // 显示更新时间
            var now = new Date();
            document.getElementById('updateTime').textContent = '📊 数据更新时间：' + now.toLocaleString('zh-CN');
            
            // 解析嵌入的CSV数据
            if (csvRawData && csvRawData !== '__CSV_DATA__') {
                var csv = parseCSV(csvRawData);
                if (csv.length > 0) {
                    allAnalyzedData = analyzeData(csv);
                    renderCharts(allAnalyzedData);
                } else {
                    document.getElementById('status').textContent = '❌ CSV数据为空';
                }
            } else {
                document.getElementById('fileContainer').style.display = 'block';
                document.getElementById('status').textContent = '⚠️ 等待快捷指令生成数据...';
            }
        });

        // 保留手动上传功能（备用）
        document.getElementById('csvFile').addEventListener('change', function (e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                csvRawData = ev.target.result;
                var csv = parseCSV(csvRawData);
                if (csv.length > 0) {
                    allAnalyzedData = analyzeData(csv);
                    renderCharts(allAnalyzedData);
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        document.getElementById('birthDate').addEventListener('change', calculateAndDisplayAge);
    </script>

</body>
</html>