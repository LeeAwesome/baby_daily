<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å®å®æ—¥å¸¸ - ç”˜ç‰¹å›¾æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            height: calc(100vh - 30px);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px 0;
            font-size: clamp(20px, 5vw, 28px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, .2);
        }

        .status {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin: 5px 0;
            font-size: 13px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .controls button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .controls button:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .controls input[type="date"],
        .controls input[type="file"] {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        /* å›¾ä¾‹æ ·å¼ */
        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 12px;
            margin-left: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 3px;
            border-left: 3px solid rgba(0,0,0,0.2);
        }

        .legend-item {
            cursor: pointer;
            transition: opacity 0.2s;
            user-select: none;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-item.disabled {
            opacity: 0.3;
            text-decoration: line-through;
        }

        /* æ‚¬æµ®å¡ç‰‡ */
        .event-card {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 20px;
            min-width: 280px;
            max-width: 320px;
            z-index: 1000;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        .event-card.show {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .event-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .event-card-close {
            background: #f5f5f5;
            border: none;
            color: #666;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: background 0.2s;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .event-card-close:hover {
            background: #e0e0e0;
        }

        .event-card-item {
            margin-bottom: 12px;
        }

        .event-card-item:last-child {
            margin-bottom: 0;
        }

        .event-card-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-card-value {
            font-size: 14px;
            color: #333;
        }

        @media (max-width: 768px) {
            .event-card {
                min-width: 240px;
                max-width: 280px;
            }
        }

        /* ç”˜ç‰¹å›¾å®¹å™¨ - ä½¿ç”¨ flex å¸ƒå±€ */
        .gantt-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* å›ºå®šçš„æ—¥æœŸåˆ— */
        .gantt-fixed-column {
            width: 100px;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            background: white;
            z-index: 100;
            box-shadow: 3px 0 6px rgba(0,0,0,0.1);
        }

        .gantt-header-date {
            min-height: 50px;
            padding: 12px 8px;
            text-align: center;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .gantt-dates-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .gantt-dates-body::-webkit-scrollbar {
            display: none;
        }

        /* å¯æ»šåŠ¨çš„å†…å®¹åŒº */
        .gantt-scroll-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            cursor: grab;
        }

        .gantt-scroll-area::-webkit-scrollbar {
            display: none;
        }
        
        .gantt-scroll-area {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ä¿®æ”¹ï¼šç§»é™¤å›ºå®šå®½åº¦ï¼Œæ”¹ä¸º100%è‡ªé€‚åº” */
        .gantt-header-hours {
            display: flex;
            width: 100%;
            min-width: 1440px; /* ä¿ç•™æœ€å°å®½åº¦ä»¥æ”¯æŒå°å±å¹•æ»šåŠ¨ */
            min-height: 50px;
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .gantt-hour-cell {
            flex: 1; /* æ”¹ä¸ºå¼¹æ€§å¸ƒå±€ï¼Œè‡ªåŠ¨å¡«å…… */
            min-width: 60px; /* æœ€å°å®½åº¦ä¿è¯å¯è¯»æ€§ */
            padding: 12px 4px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ä¿®æ”¹ï¼šç§»é™¤å›ºå®šå®½åº¦ */
        .gantt-content {
            flex: 1;
            width: 100%;
            min-width: 1440px; /* ä¿ç•™æœ€å°å®½åº¦ä»¥æ”¯æŒå°å±å¹•æ»šåŠ¨ */
        }

        /* æ—¥æœŸæ ‡ç­¾ï¼ˆåœ¨å›ºå®šåˆ—ä¸­ï¼‰ */
        .gantt-date-label {
            min-height: 60px;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .gantt-date-label:hover {
            background: #f8f9ff;
        }

        .gantt-date-label .date-main {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .gantt-date-label .date-sub {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        /* å†…å®¹è¡Œ */
        .gantt-row {
            display: flex;
            min-height: 60px;
            width: 100%;
            min-width: 1440px; /* ä¿ç•™æœ€å°å®½åº¦ */
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .gantt-row:hover {
            background: #f8f9ff;
        }

        /* ä»Šå¤©çš„æ ‡è®° */
        .gantt-date-label.today {
            background: #fff8e1;
            border-left: 4px solid #ffa000;
        }

        .gantt-date-label.today:hover {
            background: #ffecb3;
        }

        .gantt-row.today {
            background: #fff8e1;
        }

        /* äº‹ä»¶æ¡ */
        .gantt-event {
            position: absolute;
            height: 28px;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            line-height: 1.4;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            pointer-events: auto;
            touch-action: none;
        }

        .gantt-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.25);
            z-index: 40;
            white-space: normal;
        }

        .gantt-event:active {
            transform: translateY(0);
        }

        /* äº‹ä»¶ç±»å‹æ ·å¼ */
        .event-sleep {
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
            color: white;
            border-left: 4px solid #1976d2;
        }

        .event-feed-milk {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
            color: white;
            border-left: 4px solid #f57c00;
        }

        .event-feed-formula {
            background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
            color: white;
            border-left: 4px solid #c2185b;
        }

        .event-food {
            background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);
            color: white;
            border-left: 4px solid #689f38;
        }

        .event-poop {
            background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);
            color: white;
            border-left: 4px solid #795548;
        }

        .event-weight {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
            border-left: 4px solid #388e3c;
        }

        /* ç‚¹äº‹ä»¶ï¼ˆæ²¡æœ‰æŒç»­æ—¶é—´ï¼‰ - åœ†å½¢å¾½ç« æ ·å¼ */
        .event-point {
            width: 28px !important;
            height: 28px !important;
            min-width: 28px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            position: absolute;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 20;
            border: none !important;
        }

        .event-point:hover {
            transform: translateX(-50%) scale(1.5);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 50;
        }

        /* å›¾æ ‡ */
        .event-point::after {
            content: attr(data-icon);
            font-size: 14px;
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        /* ä¸ºä¸åŒäº‹ä»¶ç±»å‹è®¾ç½®æ¸å˜èƒŒæ™¯è‰² */
        .event-point.event-feed-milk {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
        }

        .event-point.event-feed-formula {
            background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
        }

        .event-point.event-food {
            background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);
        }

        .event-point.event-poop {
            background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);
        }

        .event-point.event-weight {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .event-point {
                width: 26px !important;
                height: 26px !important;
                min-width: 26px;
            }

            .event-point::after {
                font-size: 13px;
            }
        }

        /* å½“å‰æ—¶é—´æ ‡è®°ï¼ˆåœ¨è¡¨å¤´ï¼‰ */
        .gantt-hour-cell.current-hour {
            background: rgba(255, 68, 68, 0.15);
            position: relative;
        }

        .gantt-hour-cell.current-hour::after {
            content: 'â—';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff4444;
            font-size: 8px;
        }

        /* æœªæ¥æ—¶é—´æ·¡åŒ– */
        .gantt-hour-cell.future-hour {
            opacity: 0.4;
        }

        /* ä»Šå¤©è¡Œçš„æœªæ¥æ—¶é—´ä¹Ÿæ·¡åŒ– */
        .gantt-row.today .gantt-event {
            transition: opacity 0.3s;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                height: calc(100vh - 16px);
            }

            .gantt-fixed-column {
                width: 80px;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¶ å®å®æ—¥å¸¸ - ç”˜ç‰¹å›¾æ¨¡å¼</h1>
        <div id="status" class="status">ğŸ“ è¯·ä¸Šä¼  CSV æ–‡ä»¶</div>
        
        <div class="controls">
            <label>ğŸ“‚ ä¸Šä¼ CSV:</label>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)">
            
            <button onclick="setDateRange(7)">æœ€è¿‘7å¤©</button>
            <button onclick="setDateRange(14)">æœ€è¿‘14å¤©</button>
            <button onclick="setDateRange(30)">æœ€è¿‘30å¤©</button>
            
            <label>å¼€å§‹:</label>
            <input type="date" id="startDate" onchange="customDateRange()">
            
            <label>ç»“æŸ:</label>
            <input type="date" id="endDate" onchange="customDateRange()">
            
            <button onclick="scrollToCurrentTime()">ğŸ“ å½“å‰æ—¶é—´</button>
            
            <div class="legend">
                <div class="legend-item" data-type="sleep" onclick="toggleEventType('sleep', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);"></div>
                    <span>ç¡è§‰</span>
                </div>
                <div class="legend-item" data-type="feed-milk" onclick="toggleEventType('feed-milk', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);"></div>
                    <span>æ¯ä¹³</span>
                </div>
                <div class="legend-item" data-type="feed-formula" onclick="toggleEventType('feed-formula', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);"></div>
                    <span>å¥¶ç²‰</span>
                </div>
                <div class="legend-item" data-type="food" onclick="toggleEventType('food', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #aed581 0%, #9ccc65 100%);"></div>
                    <span>è¾…é£Ÿ</span>
                </div>
                <div class="legend-item" data-type="poop" onclick="toggleEventType('poop', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);"></div>
                    <span>æ¢å°¿å¸ƒ</span>
                </div>
                <div class="legend-item" data-type="weight" onclick="toggleEventType('weight', this)">
                    <div class="legend-color" style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);"></div>
                    <span>ä½“é‡</span>
                </div>
            </div>
        </div>
        
        <div class="gantt-container">
            <!-- å›ºå®šçš„æ—¥æœŸåˆ— -->
            <div class="gantt-fixed-column">
                <div class="gantt-header-date">æ—¥æœŸ</div>
                <div class="gantt-dates-body" id="ganttDatesBody"></div>
            </div>
            
            <!-- å¯æ»šåŠ¨çš„å†…å®¹åŒº -->
            <div class="gantt-scroll-area" id="ganttScrollArea">
                <!-- æ—¶é—´è½´å¤´éƒ¨ -->
                <div class="gantt-header-hours" id="ganttHeaderHours"></div>
                <!-- å†…å®¹åŒº -->
                <div class="gantt-content" id="ganttContent"></div>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®å¡ç‰‡ -->
    <div class="event-card" id="eventCard">
        <div class="event-card-header">
            <div class="event-card-title" id="eventCardTitle">äº‹ä»¶è¯¦æƒ…</div>
            <button class="event-card-close" onclick="closeEventCard()">Ã—</button>
        </div>
        <div id="eventCardContent"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        var allData = [];
        var processedEvents = [];
        
        // äº‹ä»¶ç±»å‹ç­›é€‰çŠ¶æ€
        var eventTypeFilters = {
            'sleep': true,
            'feed-milk': true,
            'feed-formula': true,
            'food': true,
            'poop': true,
            'weight': true
        };

        // è§£æCSV
        function parseCSV(text) {
            var lines = text.trim().split('\n');
            var result = [];
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                // ç®€å•çš„CSVè§£æï¼ˆå¤„ç†å¼•å·ï¼‰
                var parts = [];
                var current = '';
                var inQuotes = false;
                
                for (var j = 0; j < line.length; j++) {
                    var char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        parts.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current.trim());
                
                if (parts.length >= 7) {
                    result.push({
                        timestamp: parts[0],
                        eventType: parts[1],
                        subtype: parts[2],
                        value: parts[3],
                        unit: parts[4],
                        notes: parts[5],
                        who: parts[6] || '',
                        pairKey: parts[7] || ''
                    });
                }
            }
            return result;
        }

        // å¤„ç†äº‹ä»¶ï¼Œé…å¯¹å¼€å§‹å’Œç»“æŸ
        function processEvents(data) {
            var events = [];
            var sleepPairs = {}; // ç”¨äºé…å¯¹ç¡è§‰çš„å¼€å§‹å’Œç»“æŸ
            
            data.forEach(function(row) {
                if (!row || !row.timestamp) return;
                
                var date = new Date(row.timestamp);
                
                // è§„èŒƒåŒ–æ—¥æœŸæ ¼å¼ï¼Œç¡®ä¿YYYY-MM-DDæ ¼å¼ï¼ˆæœˆæ—¥éƒ½æ˜¯ä¸¤ä½æ•°ï¼‰
                var rawDateStr = row.timestamp.split(' ')[0];
                var dateParts = rawDateStr.split('-');
                var dateStr;
                if (dateParts.length === 3) {
                    var year = dateParts[0];
                    var month = dateParts[1].padStart(2, '0');
                    var day = dateParts[2].padStart(2, '0');
                    dateStr = year + '-' + month + '-' + day;
                } else {
                    dateStr = rawDateStr; // åå¤‡æ–¹æ¡ˆ
                }
                
                var hour = date.getHours();
                var minute = date.getMinutes();
                var timeInMinutes = hour * 60 + minute;
                
                if (row.eventType === 'ç¡è§‰') {
                    if (row.subtype === 'å¼€å§‹') {
                        // è®°å½•ç¡è§‰å¼€å§‹
                        var key = row.pairKey || row.timestamp;
                        sleepPairs[key] = {
                            date: dateStr,
                            startTime: timeInMinutes,
                            startTimestamp: row.timestamp,
                            who: row.who
                        };
                    } else if (row.subtype === 'ç»“æŸ' && row.pairKey) {
                        // æ‰¾åˆ°å¯¹åº”çš„å¼€å§‹ï¼Œåˆ›å»ºç¡è§‰äº‹ä»¶
                        var startEvent = sleepPairs[row.pairKey];
                        if (startEvent) {
                            var endTimeInMinutes = timeInMinutes;
                            
                            // å¤„ç†è·¨å¤©æƒ…å†µ
                            if (dateStr !== startEvent.date) {
                                // åˆ†æˆä¸¤æ®µï¼šå¼€å§‹æ—¥æœŸåˆ°23:59ï¼Œå’Œ00:00åˆ°ç»“æŸæ—¶é—´
                                events.push({
                                    date: startEvent.date,
                                    type: 'sleep',
                                    startTime: startEvent.startTime,
                                    endTime: 24 * 60,
                                    duration: 24 * 60 - startEvent.startTime,
                                    text: 'ğŸ˜´ ç¡è§‰',
                                    tooltip: startEvent.startTimestamp + ' å¼€å§‹',
                                    who: startEvent.who
                                });
                                
                                events.push({
                                    date: dateStr,
                                    type: 'sleep',
                                    startTime: 0,
                                    endTime: endTimeInMinutes,
                                    duration: endTimeInMinutes,
                                    text: 'ğŸ˜´ ç¡è§‰',
                                    tooltip: row.timestamp + ' é†’æ¥',
                                    who: row.who
                                });
                            } else {
                                // åŒä¸€å¤©
                                events.push({
                                    date: dateStr,
                                    type: 'sleep',
                                    startTime: startEvent.startTime,
                                    endTime: endTimeInMinutes,
                                    duration: endTimeInMinutes - startEvent.startTime,
                                    text: 'ğŸ˜´ ç¡è§‰ ' + formatDuration(endTimeInMinutes - startEvent.startTime),
                                    tooltip: startEvent.startTimestamp + ' - ' + row.timestamp,
                                    who: startEvent.who
                                });
                            }
                            
                            delete sleepPairs[row.pairKey];
                        }
                    }
                } else if (row.eventType === 'å–‚å¥¶') {
                    var eventText = '';
                    var eventType = '';
                    
                    if (row.subtype === 'æ¯ä¹³') {
                        eventText = 'ğŸ¤± æ¯ä¹³';
                        if (row.value) eventText += ' ' + row.value + row.unit;
                        eventType = 'feed-milk';
                    } else if (row.subtype === 'å¥¶ç²‰') {
                        eventText = 'ğŸ¼ å¥¶ç²‰';
                        if (row.value) eventText += ' ' + row.value + row.unit;
                        eventType = 'feed-formula';
                    }
                    
                    events.push({
                        date: dateStr,
                        type: eventType,
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: eventText,
                        tooltip: row.timestamp + (row.notes ? '\n' + row.notes : ''),
                        who: row.who
                    });
                } else if (row.eventType === 'è¾…é£Ÿ') {
                    var foodText = 'ğŸ¥„ ' + (row.subtype || 'è¾…é£Ÿ');
                    if (row.value) foodText += ' ' + row.value + row.unit;
                    
                    events.push({
                        date: dateStr,
                        type: 'food',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: foodText,
                        tooltip: row.timestamp + '\n' + (row.notes || row.subtype || ''),
                        who: row.who
                    });
                } else if (row.eventType === 'æ¢å°¿å¸ƒ') {
                    events.push({
                        date: dateStr,
                        type: 'poop',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: 'ğŸ’© ' + row.subtype,
                        tooltip: row.timestamp,
                        who: row.who
                    });
                } else if (row.eventType === 'ä½“é‡') {
                    events.push({
                        date: dateStr,
                        type: 'weight',
                        startTime: timeInMinutes,
                        endTime: timeInMinutes,
                        duration: 0,
                        text: 'âš–ï¸ ' + row.value + row.unit,
                        tooltip: row.timestamp,
                        who: row.who
                    });
                }
            });
            
            return events;
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(minutes) {
            if (minutes < 60) {
                return minutes + 'åˆ†';
            }
            var hours = Math.floor(minutes / 60);
            var mins = minutes % 60;
            if (mins === 0) {
                return hours + 'å°æ—¶';
            }
            return hours + 'å°æ—¶' + mins + 'åˆ†';
        }

        // ç”Ÿæˆæ—¥æœŸèŒƒå›´
        function generateDateRange(startDate, endDate) {
            var dates = [];
            var current = new Date(startDate);
            var end = new Date(endDate);
            
            while (current <= end) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            
            return dates;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ - ç¡®ä¿ä½¿ç”¨æœ¬åœ°æ—¶é—´
        function formatDate(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // å®‰å…¨åœ°ä»å­—ç¬¦ä¸²åˆ›å»ºæœ¬åœ°æ—¥æœŸ
        function parseLocalDate(dateStr) {
            var parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        // è·å–æ˜ŸæœŸ
        function getWeekday(date) {
            var days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return days[date.getDay()];
        }

        // è®¾ç½®æ—¥æœŸèŒƒå›´
        function setDateRange(days) {
            if (processedEvents.length === 0) return;
            
            // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆé¿å…æ—¶åŒºé—®é¢˜ï¼‰
            var today = new Date();
            var todayStr = formatDate(today);
            
            // è§£æå›Dateå¯¹è±¡ï¼Œç¡®ä¿æ—¶åŒºä¸€è‡´
            var endDate = new Date(todayStr + 'T00:00:00');
            
            // å¼€å§‹æ—¥æœŸæ˜¯ä»Šå¤©å¾€å‰æ¨days-1å¤©
            var startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - days + 1);
            
            var startDateStr = formatDate(startDate);
            var endDateStr = formatDate(endDate);
            
            console.log('=== æ—¥æœŸèŒƒå›´è®¾ç½® ===');
            console.log('å¤©æ•°:', days);
            console.log('å¼€å§‹æ—¥æœŸ:', startDateStr);
            console.log('ç»“æŸæ—¥æœŸ:', endDateStr);
            console.log('æ€»äº‹ä»¶æ•°:', processedEvents.length);
            
            // æ£€æŸ¥è¿™ä¸ªæ—¥æœŸèŒƒå›´å†…æœ‰å¤šå°‘äº‹ä»¶
            var eventsInRange = processedEvents.filter(function(e) {
                return e.date >= startDateStr && e.date <= endDateStr;
            });
            console.log('æ—¥æœŸèŒƒå›´å†…äº‹ä»¶æ•°:', eventsInRange.length);
            
            document.getElementById('startDate').value = startDateStr;
            document.getElementById('endDate').value = endDateStr;
            
            renderGantt(startDate, endDate);
        }

        // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
        function customDateRange() {
            var startDateStr = document.getElementById('startDate').value;
            var endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr || !endDateStr) return;
            
            var startDate = new Date(startDateStr);
            var endDate = new Date(endDateStr);
            
            if (startDate > endDate) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            renderGantt(startDate, endDate);
        }

        // æ¸²æŸ“å¤´éƒ¨ï¼ˆ24å°æ—¶ï¼‰- å¯é€‰æ ‡è®°å½“å‰æ—¶é—´
        function renderHeaderWithTime(markCurrentTime) {
            var headerHours = document.getElementById('ganttHeaderHours');
            if (!headerHours) return;
            
            headerHours.innerHTML = '';
            
            // è·å–å½“å‰æ—¶é—´
            var now = new Date();
            var currentHour = now.getHours();
            
            for (var hour = 0; hour < 24; hour++) {
                var cell = document.createElement('div');
                cell.className = 'gantt-hour-cell';
                
                // åªåœ¨æ˜¾ç¤ºä»Šå¤©æ—¶æ ‡è®°å½“å‰æ—¶é—´
                if (markCurrentTime) {
                    // æ ‡è®°å½“å‰å°æ—¶
                    if (hour === currentHour) {
                        cell.classList.add('current-hour');
                    }
                    
                    // æ ‡è®°æœªæ¥æ—¶é—´
                    if (hour > currentHour) {
                        cell.classList.add('future-hour');
                    }
                }
                
                cell.textContent = hour + ':00';
                headerHours.appendChild(cell);
            }
        }
        
        // ä¿ç•™åŸrenderHeaderå‡½æ•°ç”¨äºåˆå§‹åŒ–
        function renderHeader() {
            renderHeaderWithTime(false);
        }

        // æ¸²æŸ“ç”˜ç‰¹å›¾
        function renderGantt(startDate, endDate) {
            var datesBody = document.getElementById('ganttDatesBody');
            var ganttContent = document.getElementById('ganttContent');
            
            if (!datesBody || !ganttContent) return;
            
            datesBody.innerHTML = '';
            ganttContent.innerHTML = '';
            
            var dates = generateDateRange(startDate, endDate);
            // å€’åºæ˜¾ç¤ºæ—¥æœŸï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
            dates.reverse();
            
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var todayStr = formatDate(today);
            
            var startDateStr = formatDate(startDate);
            var endDateStr = formatDate(endDate);
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»Šå¤©
            var includesToday = dates.some(function(date) {
                return formatDate(date) === todayStr;
            });
            
            // é‡æ–°æ¸²æŸ“è¡¨å¤´ï¼ˆå¦‚æœåŒ…å«ä»Šå¤©åˆ™æ ‡è®°å½“å‰æ—¶é—´ï¼‰
            renderHeaderWithTime(includesToday);
            
            dates.forEach(function(date) {
                var dateStr = formatDate(date);
                var isToday = dateStr === todayStr;
                
                // æ—¥æœŸæ ‡ç­¾
                var dateLabel = document.createElement('div');
                dateLabel.className = 'gantt-date-label' + (isToday ? ' today' : '');
                
                var dateMain = document.createElement('div');
                dateMain.className = 'date-main';
                dateMain.textContent = (date.getMonth() + 1) + '/' + date.getDate();
                
                var dateSub = document.createElement('div');
                dateSub.className = 'date-sub';
                dateSub.textContent = getWeekday(date);
                
                dateLabel.appendChild(dateMain);
                dateLabel.appendChild(dateSub);
                datesBody.appendChild(dateLabel);
                
                // å†…å®¹è¡Œ
                var row = document.createElement('div');
                row.className = 'gantt-row' + (isToday ? ' today' : '');
                
                // è·å–è¯¥æ—¥æœŸçš„äº‹ä»¶å¹¶åº”ç”¨ç­›é€‰
                var dayEvents = processedEvents.filter(function(e) {
                    return e.date === dateStr && eventTypeFilters[e.type];
                });
                
                // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                if (dateStr.indexOf('11-02') !== -1 || dateStr.indexOf('11/2') !== -1) {
                    console.log('>>> 11/2 è°ƒè¯•ä¿¡æ¯ <<<');
                    console.log('ç”Ÿæˆçš„dateStr:', dateStr);
                    console.log('è¯¥æ—¥æœŸæ‰€æœ‰äº‹ä»¶:', processedEvents.filter(function(e) { return e.date === dateStr; }).length);
                    console.log('ç­›é€‰åäº‹ä»¶:', dayEvents.length);
                    console.log('CSVä¸­çš„11-02ç›¸å…³æ—¥æœŸ:', processedEvents.filter(function(e) { 
                        return e.date.indexOf('11-02') !== -1; 
                    }).map(function(e) { return e.date; }));
                }
                
                dayEvents.sort(function(a, b) {
                    return a.startTime - b.startTime;
                });
                
                // æ”¹è¿›çš„Trackå¸ƒå±€ - åŒºåˆ†æŒç»­äº‹ä»¶å’Œç¬æ—¶äº‹ä»¶
                var tracks = [];
                var pointEventTracks = {}; // ä¸ºç¬æ—¶äº‹ä»¶å•ç‹¬ç®¡ç†track
                
                dayEvents.forEach(function(evt) {
                    var trackIndex = -1;
                    
                    if (evt.duration > 0) {
                        // æŒç»­äº‹ä»¶ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
                        for (var i = 0; i < tracks.length; i++) {
                            if (tracks[i] <= evt.startTime) {
                                trackIndex = i;
                                break;
                            }
                        }
                        
                        if (trackIndex === -1) {
                            trackIndex = tracks.length;
                            tracks.push(0);
                        }
                        
                        tracks[trackIndex] = evt.endTime;
                    } else {
                        // ç¬æ—¶äº‹ä»¶ï¼šæ™ºèƒ½é¿è®©
                        // æŸ¥æ‰¾æœ€è¿‘5åˆ†é’Ÿå†…æ˜¯å¦æœ‰å…¶ä»–ç¬æ—¶äº‹ä»¶
                        var nearbyEvents = dayEvents.filter(function(e) {
                            return e.duration === 0 && 
                                   Math.abs(e.startTime - evt.startTime) < 5 && 
                                   e !== evt &&
                                   pointEventTracks[e.startTime] !== undefined;
                        });
                        
                        if (nearbyEvents.length > 0) {
                            // æœ‰ä¸´è¿‘äº‹ä»¶ï¼Œé”™å¼€æ˜¾ç¤º
                            var usedTracks = nearbyEvents.map(function(e) {
                                return pointEventTracks[e.startTime];
                            });
                            trackIndex = 0;
                            while (usedTracks.indexOf(trackIndex) !== -1) {
                                trackIndex++;
                            }
                        } else {
                            trackIndex = 0;
                        }
                        
                        pointEventTracks[evt.startTime] = trackIndex;
                        
                        // ç¡®ä¿tracksæ•°ç»„è¶³å¤Ÿå¤§
                        while (tracks.length <= trackIndex) {
                            tracks.push(0);
                        }
                    }
                    
                    // åˆ›å»ºäº‹ä»¶å…ƒç´ 
                    var eventDiv = document.createElement('div');
                    eventDiv.className = 'gantt-event event-' + evt.type;
                    
                    // è®¡ç®—ä½ç½®å’Œå®½åº¦ - ä½¿ç”¨ç™¾åˆ†æ¯”
                    var leftPercent = (evt.startTime / (24 * 60)) * 100;
                    var widthPercent;
                    
                    if (evt.duration > 0) {
                        widthPercent = (evt.duration / (24 * 60)) * 100;
                        eventDiv.style.left = leftPercent + '%';
                        eventDiv.style.width = widthPercent + '%';
                        eventDiv.textContent = evt.text;
                        if (evt.who && evt.who.trim()) {
                            eventDiv.textContent += ' [' + evt.who.trim() + ']';
                        }
                    } else {
                        // ç‚¹äº‹ä»¶ä½¿ç”¨åœ†å½¢å¾½ç« æ ·å¼
                        // ä½¿ç”¨transformå±…ä¸­ï¼Œæ›´ç²¾ç¡®
                        eventDiv.style.left = leftPercent + '%';
                        eventDiv.style.transform = 'translateX(-50%)';
                        eventDiv.classList.add('event-point');
                        
                        // æå–emojiå›¾æ ‡ï¼ˆæ–‡æœ¬å¼€å¤´çš„emojiï¼‰
                        var icon = '';
                        var textMatch = evt.text.match(/^([\uD800-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF]|[\uD83C-\uD83E][\uDC00-\uDFFF])/);
                        if (textMatch) {
                            icon = textMatch[0];
                        } else {
                            // æ ¹æ®äº‹ä»¶ç±»å‹æä¾›é»˜è®¤å›¾æ ‡
                            var iconMap = {
                                'feed-milk': 'ğŸ¤±',
                                'feed-formula': 'ğŸ¼',
                                'food': 'ğŸ¥„',
                                'poop': 'ğŸ’©',
                                'weight': 'âš–ï¸'
                            };
                            icon = iconMap[evt.type] || 'ğŸ“Œ';
                        }
                        eventDiv.setAttribute('data-icon', icon);
                    }
                    
                    var top = 4 + trackIndex * 32;
                    eventDiv.style.top = top + 'px';
                    
                    eventDiv.title = evt.tooltip || evt.text;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºè¯¦æƒ…
                    eventDiv.onclick = function(e) {
                        e.stopPropagation();
                        showEventCard(evt, e);
                    };
                    
                    row.appendChild(eventDiv);
                });
                
                // è°ƒæ•´è¡Œé«˜ä»¥å®¹çº³æ‰€æœ‰tracks
                if (tracks.length > 0) {
                    var rowHeight = tracks.length * 32 + 16;
                    row.style.minHeight = rowHeight + 'px';
                    dateLabel.style.minHeight = rowHeight + 'px';
                }
                
                ganttContent.appendChild(row);
            });
            
            // åŒæ­¥æ»šåŠ¨
            syncScroll();
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰æ—¶é—´ï¼ˆè€ƒè™‘å±å¹•å°ºå¯¸ï¼‰
            scrollToCurrentTime();
            
            // æ›´æ–°çŠ¶æ€
            var totalEvents = processedEvents.filter(function(e) {
                return e.date >= startDateStr && e.date <= endDateStr;
            }).length;
            
            document.getElementById('status').textContent = 
                'âœ… æ˜¾ç¤º ' + dates.length + ' å¤©ï¼Œå…± ' + totalEvents + ' ä¸ªäº‹ä»¶';
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('status').textContent = 'â³ æ­£åœ¨è¯»å–æ–‡ä»¶...';
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var text = e.target.result;
                    allData = parseCSV(text);
                    processedEvents = processEvents(allData);
                    
                    if (processedEvents.length === 0) {
                        document.getElementById('status').textContent = 'âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆäº‹ä»¶æ•°æ®';
                        return;
                    }
                    
                    // è°ƒè¯•ï¼šè¾“å‡ºæ‰€æœ‰å”¯ä¸€æ—¥æœŸ
                    var uniqueDates = {};
                    processedEvents.forEach(function(e) {
                        uniqueDates[e.date] = (uniqueDates[e.date] || 0) + 1;
                    });
                    console.log('=== CSVä¸­çš„æ‰€æœ‰æ—¥æœŸåŠäº‹ä»¶æ•°é‡ ===');
                    Object.keys(uniqueDates).sort().forEach(function(date) {
                        console.log(date + ': ' + uniqueDates[date] + ' ä¸ªäº‹ä»¶');
                    });
                    
                    renderHeaderWithTime(false);
                    setDateRange(7);
                } catch (err) {
                    document.getElementById('status').textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ' + err.message;
                    console.error('è§£æé”™è¯¯:', err);
                }
            };
            
            reader.onerror = function() {
                document.getElementById('status').textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥';
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            document.getElementById('status').textContent = 'ğŸ“ è¯·ä¸Šä¼  CSV æ–‡ä»¶';
            var ganttContent = document.getElementById('ganttContent');
            if (ganttContent) {
                ganttContent.innerHTML = '<div class="loading">è¯·ä¸Šä¼ CSVæ–‡ä»¶</div>';
            }
            renderHeader();
        }

        // åŒæ­¥æ»šåŠ¨
        function syncScroll() {
            var datesBody = document.getElementById('ganttDatesBody');
            var scrollArea = document.getElementById('ganttScrollArea');
            
            if (!datesBody || !scrollArea) return;
            
            scrollArea.onscroll = function() {
                datesBody.scrollTop = scrollArea.scrollTop;
            };
        }

        // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰æ—¶é—´ï¼ˆæ ¹æ®å±å¹•å°ºå¯¸æ™ºèƒ½å®šä½ï¼‰
        function scrollToCurrentTime() {
            var scrollArea = document.getElementById('ganttScrollArea');
            if (!scrollArea) return;
            
            // è·å–å½“å‰æ—¶é—´
            var now = new Date();
            var currentHour = now.getHours();
            var currentMinute = now.getMinutes();
            
            // è®¡ç®—å½“å‰æ—¶é—´å ä¸€å¤©çš„ç™¾åˆ†æ¯”
            var timePercent = (currentHour * 60 + currentMinute) / (24 * 60);
            
            // è·å–å†…å®¹åŒºåŸŸçš„å®é™…å®½åº¦
            var contentWidth = scrollArea.scrollWidth;
            var viewportWidth = scrollArea.clientWidth;
            
            // è®¡ç®—å½“å‰æ—¶é—´å¯¹åº”çš„åƒç´ ä½ç½®
            var timePosition = contentWidth * timePercent;
            
            // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´æ˜¾ç¤ºç­–ç•¥
            var scrollPosition;
            
            if (viewportWidth < 768) {
                // å°å±å¹•ï¼ˆæ‰‹æœºï¼‰ï¼šå½“å‰æ—¶é—´æ˜¾ç¤ºåœ¨å±å¹•å·¦ä¾§ 1/3 å¤„ï¼Œæ–¹ä¾¿æŸ¥çœ‹åç»­æ—¶é—´
                scrollPosition = timePosition - (viewportWidth / 3);
            } else if (viewportWidth < 1200) {
                // ä¸­ç­‰å±å¹•ï¼ˆå¹³æ¿ï¼‰ï¼šå½“å‰æ—¶é—´æ˜¾ç¤ºåœ¨å±å¹•å·¦ä¾§ 2/5 å¤„
                scrollPosition = timePosition - (viewportWidth * 0.4);
            } else {
                // å¤§å±å¹•ï¼ˆç”µè„‘ï¼‰ï¼šå½“å‰æ—¶é—´æ˜¾ç¤ºåœ¨å±å¹•ä¸­å¤®åå·¦
                scrollPosition = timePosition - (viewportWidth / 2);
            }
            
            // ç¡®ä¿ä¸æ»šåŠ¨åˆ°è´Ÿæ•°ä½ç½®
            if (scrollPosition < 0) scrollPosition = 0;
            
            // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§æ»šåŠ¨ä½ç½®
            var maxScroll = contentWidth - viewportWidth;
            if (scrollPosition > maxScroll) scrollPosition = maxScroll;
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²å®Œå…¨æ¸²æŸ“
            setTimeout(function() {
                scrollArea.scrollLeft = scrollPosition;
                // åŒæ—¶ç¡®ä¿ä»Šå¤©çš„è¡Œåœ¨å¯è§†åŒºåŸŸå†…ï¼ˆå‚ç›´æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œå› ä¸ºä»Šå¤©åœ¨æœ€ä¸Šé¢ï¼‰
                scrollArea.scrollTop = 0;
            }, 100);
        }

        // è§¦æ‘¸æ‹–åŠ¨åŠŸèƒ½
        function initTouchDrag() {
            var scrollArea = document.getElementById('ganttScrollArea');
            if (!scrollArea) return;

            var isDown = false;
            var startX = 0;
            var startY = 0;
            var scrollLeft = 0;
            var scrollTop = 0;
            var velocityX = 0;
            var velocityY = 0;
            var lastX = 0;
            var lastY = 0;
            var lastTime = 0;
            var rafId = null;

            scrollArea.onpointerdown = function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯äº‹ä»¶æ¡ï¼Œä¸è§¦å‘æ‹–åŠ¨
                if (e.target.closest('.gantt-event')) {
                    return;
                }

                // åœæ­¢ä»»ä½•æƒ¯æ€§åŠ¨ç”»
                if (rafId) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }

                isDown = true;
                startX = e.clientX;
                startY = e.clientY;
                lastX = e.clientX;
                lastY = e.clientY;
                scrollLeft = scrollArea.scrollLeft;
                scrollTop = scrollArea.scrollTop;
                lastTime = Date.now();
                velocityX = 0;
                velocityY = 0;

                scrollArea.setPointerCapture(e.pointerId);
                scrollArea.style.cursor = 'grabbing';
            };

            scrollArea.onpointermove = function(e) {
                if (!isDown) return;

                var currentX = e.clientX;
                var currentY = e.clientY;
                var currentTime = Date.now();

                var dx = currentX - startX;
                var dy = currentY - startY;

                scrollArea.scrollLeft = scrollLeft - dx;
                scrollArea.scrollTop = scrollTop - dy;

                // è®¡ç®—é€Ÿåº¦
                var dt = currentTime - lastTime;
                if (dt > 0) {
                    velocityX = (currentX - lastX) / dt * 16;
                    velocityY = (currentY - lastY) / dt * 16;
                }

                lastX = currentX;
                lastY = currentY;
                lastTime = currentTime;
            };

            scrollArea.onpointerup = scrollArea.onpointercancel = function(e) {
                if (!isDown) return;

                isDown = false;
                scrollArea.style.cursor = 'grab';

                try {
                    scrollArea.releasePointerCapture(e.pointerId);
                } catch(err) {}

                // æƒ¯æ€§æ»šåŠ¨
                var friction = 0.95;
                var minVelocity = 0.5;

                // é™åˆ¶æœ€å¤§é€Ÿåº¦
                var maxVel = 50;
                if (velocityX > maxVel) velocityX = maxVel;
                if (velocityX < -maxVel) velocityX = -maxVel;
                if (velocityY > maxVel) velocityY = maxVel;
                if (velocityY < -maxVel) velocityY = -maxVel;

                function inertiaScroll() {
                    if (Math.abs(velocityX) > minVelocity || Math.abs(velocityY) > minVelocity) {
                        scrollArea.scrollLeft -= velocityX;
                        scrollArea.scrollTop -= velocityY;
                        velocityX *= friction;
                        velocityY *= friction;
                        rafId = requestAnimationFrame(inertiaScroll);
                    } else {
                        rafId = null;
                    }
                }

                if (Math.abs(velocityX) > minVelocity || Math.abs(velocityY) > minVelocity) {
                    inertiaScroll();
                }
            };

            scrollArea.style.cursor = 'grab';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadData();
            initTouchDrag();
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‚¬æµ®å¡ç‰‡
            document.addEventListener('click', function(e) {
                var card = document.getElementById('eventCard');
                if (card.classList.contains('show') && 
                    !card.contains(e.target) && 
                    !e.target.closest('.gantt-event')) {
                    closeEventCard();
                }
            });
        });

        // åˆ‡æ¢äº‹ä»¶ç±»å‹æ˜¾ç¤º/éšè—
        function toggleEventType(type, element) {
            eventTypeFilters[type] = !eventTypeFilters[type];
            
            if (eventTypeFilters[type]) {
                element.classList.remove('disabled');
            } else {
                element.classList.add('disabled');
            }
            
            // é‡æ–°æ¸²æŸ“
            if (processedEvents.length > 0) {
                var startDateStr = document.getElementById('startDate').value;
                var endDateStr = document.getElementById('endDate').value;
                if (startDateStr && endDateStr) {
                    renderGantt(new Date(startDateStr), new Date(endDateStr));
                }
            }
        }

        // æ˜¾ç¤ºäº‹ä»¶æ‚¬æµ®å¡ç‰‡
        function showEventCard(evt, event) {
            var card = document.getElementById('eventCard');
            var title = document.getElementById('eventCardTitle');
            var content = document.getElementById('eventCardContent');
            
            // è®¾ç½®æ ‡é¢˜
            title.textContent = evt.text;
            
            // æ„å»ºå†…å®¹HTML
            var html = '';
            
            html += '<div class="event-card-item">';
            html += '<div class="event-card-label">æ—¥æœŸ</div>';
            html += '<div class="event-card-value">' + evt.date + '</div>';
            html += '</div>';
            
            if (evt.duration > 0) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">å¼€å§‹æ—¶é—´</div>';
                html += '<div class="event-card-value">' + formatMinutesToTime(evt.startTime) + '</div>';
                html += '</div>';
                
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">ç»“æŸæ—¶é—´</div>';
                html += '<div class="event-card-value">' + formatMinutesToTime(evt.endTime) + '</div>';
                html += '</div>';
                
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">æŒç»­æ—¶é—´</div>';
                html += '<div class="event-card-value">' + formatDuration(evt.duration) + '</div>';
                html += '</div>';
            } else {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">æ—¶é—´</div>';
                html += '<div class="event-card-value">' + formatMinutesToTime(evt.startTime) + '</div>';
                html += '</div>';
            }
            
            if (evt.who && evt.who.trim()) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">æ“ä½œäºº</div>';
                html += '<div class="event-card-value">' + evt.who + '</div>';
                html += '</div>';
            }
            
            if (evt.tooltip && evt.tooltip !== evt.text) {
                html += '<div class="event-card-item">';
                html += '<div class="event-card-label">è¯¦ç»†ä¿¡æ¯</div>';
                html += '<div class="event-card-value" style="white-space: pre-wrap;">' + evt.tooltip + '</div>';
                html += '</div>';
            }
            
            content.innerHTML = html;
            
            // è®¡ç®—å¡ç‰‡ä½ç½®
            var clickX = event.clientX;
            var clickY = event.clientY;
            
            // å…ˆæ˜¾ç¤ºå¡ç‰‡ä»¥è·å–å…¶å°ºå¯¸
            card.style.left = '0px';
            card.style.top = '0px';
            card.classList.add('show');
            
            var cardWidth = card.offsetWidth;
            var cardHeight = card.offsetHeight;
            var windowWidth = window.innerWidth;
            var windowHeight = window.innerHeight;
            
            // é»˜è®¤ä½ç½®ï¼šé¼ æ ‡å³ä¾§åä¸‹
            var left = clickX + 15;
            var top = clickY + 15;
            
            // è¾¹ç•Œæ£€æµ‹å’Œè°ƒæ•´
            if (left + cardWidth > windowWidth - 20) {
                // å³ä¾§ç©ºé—´ä¸è¶³ï¼Œæ”¾åˆ°å·¦ä¾§
                left = clickX - cardWidth - 15;
            }
            
            if (top + cardHeight > windowHeight - 20) {
                // ä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œå‘ä¸Šç§»åŠ¨
                top = windowHeight - cardHeight - 20;
            }
            
            if (left < 20) {
                left = 20;
            }
            
            if (top < 20) {
                top = 20;
            }
            
            card.style.left = left + 'px';
            card.style.top = top + 'px';
        }

        // å…³é—­äº‹ä»¶å¡ç‰‡
        function closeEventCard() {
            var card = document.getElementById('eventCard');
            card.classList.remove('show');
        }

        // å°†åˆ†é’Ÿæ•°è½¬æ¢ä¸ºæ—¶é—´å­—ç¬¦ä¸²
        function formatMinutesToTime(minutes) {
            var hours = Math.floor(minutes / 60);
            var mins = minutes % 60;
            return (hours < 10 ? '0' + hours : hours) + ':' + (mins < 10 ? '0' + mins : mins);
        }
    </script>
</body>
</html>